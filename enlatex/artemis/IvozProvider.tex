% Generated by Sphinx.
\def\sphinxdocclass{report}
\newif\ifsphinxKeepOldNames \sphinxKeepOldNamestrue
\documentclass[letterpaper,10pt,english]{sphinxmanual}
\usepackage{iftex}

\ifPDFTeX
  \usepackage[utf8]{inputenc}
\fi
\ifdefined\DeclareUnicodeCharacter
  \DeclareUnicodeCharacter{00A0}{\nobreakspace}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}
\usepackage{times}
\usepackage[Sonny]{fncychap}
\usepackage{longtable}
\usepackage{sphinx}
\usepackage{multirow}
\usepackage{eqparbox}

\addto\captionsenglish{\renewcommand{\contentsname}{Basic Concepts}}

\addto\captionsenglish{\renewcommand{\figurename}{Fig.\@ }}
\addto\captionsenglish{\renewcommand{\tablename}{Table }}
\SetupFloatingEnvironment{literal-block}{name=Listing }

\addto\extrasenglish{\def\pageautorefname{page}}




\title{IvozProvider 2.10 Documentation}
\date{Jun 19, 2019}
\release{Artemis}
\author{Irontec}
\newcommand{\sphinxlogo}{}
\renewcommand{\releasename}{Release}
\makeindex

\makeatletter
\def\PYG@reset{\let\PYG@it=\relax \let\PYG@bf=\relax%
    \let\PYG@ul=\relax \let\PYG@tc=\relax%
    \let\PYG@bc=\relax \let\PYG@ff=\relax}
\def\PYG@tok#1{\csname PYG@tok@#1\endcsname}
\def\PYG@toks#1+{\ifx\relax#1\empty\else%
    \PYG@tok{#1}\expandafter\PYG@toks\fi}
\def\PYG@do#1{\PYG@bc{\PYG@tc{\PYG@ul{%
    \PYG@it{\PYG@bf{\PYG@ff{#1}}}}}}}
\def\PYG#1#2{\PYG@reset\PYG@toks#1+\relax+\PYG@do{#2}}

\expandafter\def\csname PYG@tok@gd\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PYG@tok@gu\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PYG@tok@gt\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PYG@tok@gs\endcsname{\let\PYG@bf=\textbf}
\expandafter\def\csname PYG@tok@gr\endcsname{\def\PYG@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PYG@tok@cm\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\expandafter\def\csname PYG@tok@vg\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\expandafter\def\csname PYG@tok@vi\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\expandafter\def\csname PYG@tok@vm\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\expandafter\def\csname PYG@tok@mh\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@cs\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}\def\PYG@bc##1{\setlength{\fboxsep}{0pt}\colorbox[rgb]{1.00,0.94,0.94}{\strut ##1}}}
\expandafter\def\csname PYG@tok@ge\endcsname{\let\PYG@it=\textit}
\expandafter\def\csname PYG@tok@vc\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\expandafter\def\csname PYG@tok@il\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@go\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.20,0.20,0.20}{##1}}}
\expandafter\def\csname PYG@tok@cp\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@gi\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PYG@tok@gh\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PYG@tok@ni\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.84,0.33,0.22}{##1}}}
\expandafter\def\csname PYG@tok@nl\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.13,0.44}{##1}}}
\expandafter\def\csname PYG@tok@nn\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.05,0.52,0.71}{##1}}}
\expandafter\def\csname PYG@tok@no\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.38,0.68,0.84}{##1}}}
\expandafter\def\csname PYG@tok@na\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@nb\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@nc\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.05,0.52,0.71}{##1}}}
\expandafter\def\csname PYG@tok@nd\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.33,0.33,0.33}{##1}}}
\expandafter\def\csname PYG@tok@ne\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@nf\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.02,0.16,0.49}{##1}}}
\expandafter\def\csname PYG@tok@si\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.44,0.63,0.82}{##1}}}
\expandafter\def\csname PYG@tok@s2\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@nt\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.02,0.16,0.45}{##1}}}
\expandafter\def\csname PYG@tok@nv\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\expandafter\def\csname PYG@tok@s1\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@dl\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@ch\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\expandafter\def\csname PYG@tok@m\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@gp\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.78,0.36,0.04}{##1}}}
\expandafter\def\csname PYG@tok@sh\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@ow\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@sx\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.78,0.36,0.04}{##1}}}
\expandafter\def\csname PYG@tok@bp\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@c1\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\expandafter\def\csname PYG@tok@fm\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.02,0.16,0.49}{##1}}}
\expandafter\def\csname PYG@tok@o\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PYG@tok@kc\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@c\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\expandafter\def\csname PYG@tok@mf\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@err\endcsname{\def\PYG@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PYG@tok@mb\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@ss\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.32,0.47,0.09}{##1}}}
\expandafter\def\csname PYG@tok@sr\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.14,0.33,0.53}{##1}}}
\expandafter\def\csname PYG@tok@mo\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@kd\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@mi\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@kn\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@cpf\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\expandafter\def\csname PYG@tok@kr\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@s\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@kp\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@w\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PYG@tok@kt\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.56,0.13,0.00}{##1}}}
\expandafter\def\csname PYG@tok@sc\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@sb\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@sa\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@k\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@se\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@sd\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}

\def\PYGZbs{\char`\\}
\def\PYGZus{\char`\_}
\def\PYGZob{\char`\{}
\def\PYGZcb{\char`\}}
\def\PYGZca{\char`\^}
\def\PYGZam{\char`\&}
\def\PYGZlt{\char`\<}
\def\PYGZgt{\char`\>}
\def\PYGZsh{\char`\#}
\def\PYGZpc{\char`\%}
\def\PYGZdl{\char`\$}
\def\PYGZhy{\char`\-}
\def\PYGZsq{\char`\'}
\def\PYGZdq{\char`\"}
\def\PYGZti{\char`\~}
% for compatibility with earlier versions
\def\PYGZat{@}
\def\PYGZlb{[}
\def\PYGZrb{]}
\makeatother

\renewcommand\PYGZsq{\textquotesingle}

\begin{document}

\maketitle
\tableofcontents
\phantomsection\label{index::doc}



\chapter{Introduction to IvozProvider}
\label{basic_concepts/intro/index::doc}\label{basic_concepts/intro/index:introduction-to-ivozprovider}\label{basic_concepts/intro/index:ivozprovider-official-documentation}
The following sections will serve as general introduction to IvozProvider:


\section{About this documentation}
\label{basic_concepts/intro/about::doc}\label{basic_concepts/intro/about:about-this-documentation}
This documentation describes the process of installation and usage of
IvozProvider, the multi-tenant telephony platform for providers developed
by \href{http://irontec.com}{Irontec}.

This should be the starting point for anyone interested in this solution,
both from the technical point of view and the user one and it's divided
in multiple sections from the basic infrastructure information and configuration
to the final user settings.


\section{Getting help}
\label{basic_concepts/intro/getting_help:getting-help}\label{basic_concepts/intro/getting_help::doc}\label{basic_concepts/intro/getting_help:id1}
IvozProvider is an alive and highly developed project. There are
multiple channels to get information or report bugs.

In order of preference:
\begin{itemize}
\item {} 
GitHub: \url{https://github.com/irontec/ivozprovider}

\item {} 
IRC Channel \href{https://webchat.freenode.net/?channels=ivozprovider}{\#ivozprovider} at irc.freenode.net

\item {} 
email: \href{mailto:vozip+ivozprovider@irontec.com}{vozip+ivozprovider@irontec.com}

\item {} 
Twitter: \href{https://twitter.com/irontec}{@irontec}

\end{itemize}

Don't hesitate to contact us for any kind of feedback :)


\section{What is IvozProvider?}
\label{basic_concepts/intro/what_is_ivozprovider::doc}\label{basic_concepts/intro/what_is_ivozprovider:what-is-ivozprovider}
IvozProvider is a {\hyperref[basic_concepts/intro/what_is_ivozprovider:operator\string-oriented]{\sphinxcrossref{\DUrole{std,std-ref}{provider oriented}}}}
{\hyperref[basic_concepts/intro/what_is_ivozprovider:multilevel]{\sphinxcrossref{\DUrole{std,std-ref}{multilevel}}}} {\hyperref[basic_concepts/intro/what_is_ivozprovider:voip]{\sphinxcrossref{\DUrole{std,std-ref}{IP telephony}}}} solution
{\hyperref[basic_concepts/intro/what_is_ivozprovider:exposed]{\sphinxcrossref{\DUrole{std,std-ref}{exposed to the public network}}}}.


\subsection{IP Telephony}
\label{basic_concepts/intro/what_is_ivozprovider:ip-telephony}\label{basic_concepts/intro/what_is_ivozprovider:voip}
IvozProvider supports telephony systems that use \emph{Session Initiation
Protocol}, \textbf{SIP}, described in \href{https://tools.ietf.org/html/rfc3261}{RFC 3261} and any \href{https://www.packetizer.com/ipmc/sip/standards.html}{related RFCs} independent of
manufacturers.

This allows total freedom to choose \emph{softphones}, \emph{hardphones} and the
rest of elements that interact with IvozProvider, without any kind of
binding with a manufacturer.

Right now, IvozProvider supports the following \textbf{transport protocols}
for SIP:
\begin{itemize}
\item {} 
UDP

\item {} 
TCP

\item {} 
TLS

\item {} 
Websockets

\end{itemize}

This last transport protocol described in \href{https://tools.ietf.org/html/rfc7118}{RFC 7118} supports web integrated
softphones, using the \href{https://webrtc.org/}{WebRTC} standard allowing
browsers to establish real-time \emph{peer-to-peer} connections.

The \textbf{supported audio codec} list is:
\begin{itemize}
\item {} 
PCMA (\emph{alaw})

\item {} 
PCMU (\emph{ulaw})

\item {} 
GSM

\item {} 
SpeeX

\item {} 
G.722

\item {} 
G.726

\item {} 
G.729 (manual installation required)

\item {} 
iLBC

\item {} 
\href{http://opus-codec.org/}{OPUS}

\end{itemize}


\subsection{Multilevel}
\label{basic_concepts/intro/what_is_ivozprovider:multilevel}
The web portal design of IvozProvider allows \textbf{multiple actors within the
same infrastructure}:

\noindent\sphinxincludegraphics{{operator_levels}.png}

In {\hyperref[basic_concepts/operation_roles/index:operation\string-roles]{\sphinxcrossref{\DUrole{std,std-ref}{Platform roles}}}} section, the different roles are deeply
described, but to sum up:
\begin{itemize}
\item {} 
\textbf{God Admin}: The administrator and maintainer of the solution. Provides
access to multiple brand operators.

\item {} 
\textbf{Brand Operator}: Responsible of configuring carrier routing, billing and invoicing to
multiple clients.

\item {} 
\textbf{Client Operator}: Responsible of its own configuration and to manage the final platform users.

\item {} 
\textbf{Users}: The last link of the chain, has SIP credentials and can access
its own portal for custom configurations. This level is only available for vPBX client types.

\end{itemize}

\textbf{Each one} of this roles \textbf{has its own portal} that allows them to
fulfill their tasks. Each portal can be customized in the following
ways:
\begin{itemize}
\item {} 
Themes and \emph{skins} for corporate colours.

\item {} 
Client Logos.

\item {} 
Customized URLs with the Brand or Client domain.

\end{itemize}


\subsection{Provider oriented}
\label{basic_concepts/intro/what_is_ivozprovider:operator-oriented}\label{basic_concepts/intro/what_is_ivozprovider:provider-oriented}
IvozProvider is a telephony solution \textbf{designed with horizontal scaling
in mind}. This allows handling a great amount of \textbf{traffic and users}
only by increasing the machines and resources of them.

This are the main ideas that makes this product provider oriented:
\begin{itemize}
\item {} 
Despite the fact that all machine profiles can run in the same host,
what makes it easier for the initial testing, each profile of IvozProvider
can be separated from the rest to make it run in its own machine.

\item {} 
A \textbf{distributed installation} allows to distribute the correct amount of
resources to each task, but also:
\begin{itemize}
\item {} 
Geographic distribution of elements to warranty high availability in
case of CPD failure.

\item {} 
Setup of key elements near the final users, to minimize the communication
latencies.

\item {} 
Horizontal scaling of key profiles to handle hundred of thousands
concurrent calls.

\end{itemize}

\end{itemize}

The resource consuming elements that limit the service of VoIP solutions
use to be:
\begin{itemize}
\item {} 
Already established calls audio management.

\item {} 
Managing configuration for each client administrator (IVRs, conference
rooms, external call filters, etc.)

\item {} 
Databases of configuration and records.

\end{itemize}

IvozProvider was designed always keeping in mind the \textbf{horizontal
scaling} of each of its elements, so it \textbf{can handle thousands concurrent calls}
and what is more important, \textbf{adapt the platform resources to the expected service quality}:
\begin{itemize}
\item {} 
\textbf{Media-relay} servers handle audio frames for the already established
calls:
\begin{itemize}
\item {} 
You can use as many media-relays as you need.

\item {} 
You can join media-relay in groups, and force some clients to use a
group if you want.

\item {} 
You can setup media-relays near the final users, to minimize network
latencies in the calls.

\end{itemize}

\item {} 
\textbf{Application servers} are in charge of processing the configured logic:
\begin{itemize}
\item {} 
They scale horizontally: new Application Serves can be installed and
added to the pool if you feel the need.

\item {} 
Every call is handled by the least busy Application Server

\item {} 
By default, there is no static assignment * between Clients and
Application Servers. This way failure of any Application Server is not
critical: the platform will ignore the faulty Application Server while
distributing calls.

\end{itemize}

\end{itemize}


\subsection{Exposed to the public network}
\label{basic_concepts/intro/what_is_ivozprovider:exposed-to-the-public-network}\label{basic_concepts/intro/what_is_ivozprovider:exposed}
As showed in the installation process, \textbf{IvozProvider is designed to serve
users directly from Internet}. Although it can be used in local
environments, IvozProvider is designed to use public IP addresses for its
services, removing the need of VPN or IPSec tunnels that connect the
infrastructure with the final users

Highlights:
\begin{itemize}
\item {} 
Only the required services will be exposed to Internet.

\item {} 
The untrusted origins access can be filtered out by integrated firewall

\item {} 
Access from IP addresses or networks can be filtered to avoid any kind of
phishing.

\item {} 
There is also an anti-flood mechanism to avoid short-life Denial of
Service attacks.

\item {} 
Each client concurrent calls can be limited to a fixed amount.

\item {} 
IvozProvider supports connection from terminals behind
\href{https://en.wikipedia.org/wiki/Network\_address\_translation}{NAT}.

\item {} 
IvozProvider keep track of those NAT windows and keep them alive with
\emph{nat-piercing} mechanisms.

\end{itemize}


\section{What is inside IvozProvider?}
\label{basic_concepts/intro/what_is_inside::doc}\label{basic_concepts/intro/what_is_inside:what-is-inside-ivozprovider}
IvozProvider uses well-known and stable \href{https://www.gnu.org/philosophy/free-sw.en.html}{Free Software} projects to fulfill
the different required task of the platform.

Nothing better than an image to show all the software that its integrated
into IvozProvider:

\noindent{\hspace*{\fill}\sphinxincludegraphics{{ivozprovider_logos}.png}\hspace*{\fill}}

\begin{notice}{note}{Note:}
We can not stress enough our gratitude to the developers and communities
of this projects.
\end{notice}

The task of each of this software will be deeply detailed in the block
{\hyperref[basic_concepts/architecture/index:architecture]{\sphinxcrossref{\DUrole{std,std-ref}{Platform general architecture}}}}.


\section{Who should use IvozProvider?}
\label{basic_concepts/intro/use_cases::doc}\label{basic_concepts/intro/use_cases:who-should-use-ivozprovider}
IvozProvider is a good option for those interested in having a telephony
platform that can provide service to \textbf{thousands concurrent calls}.

The greatest strengths of IvozProvide can help to decide if the solution
meets your needs:
\begin{itemize}
\item {} 
VoIP: SIP

\item {} 
Multilevel, multitenant

\item {} 
Horizontal scaling

\item {} 
PseudoSBC: open to Internet

\item {} 
Billing and Invoicing engines integrated

\item {} 
PBX Features

\end{itemize}

The installation process is so simple, that the best way to test if
IvozProvider fulfills your needs is to test it!


\chapter{Platform general architecture}
\label{basic_concepts/architecture/index:platform-general-architecture}\label{basic_concepts/architecture/index::doc}\label{basic_concepts/architecture/index:architecture}

\section{General diagram}
\label{basic_concepts/architecture/index:general-diagram}
Following diagram shows the global architecture of IvozProvider solution,
with all its components:

\noindent\sphinxincludegraphics{{flows}.png}

This is a more conceptual diagram:

\noindent\sphinxincludegraphics{{conceptual}.png}


\section{SIP signalling flow}
\label{basic_concepts/architecture/index:sip-signalling-flow}\label{basic_concepts/architecture/index:signallingflow}
The first diagram shows the SIP signalling traffic involved in the
establishment, modification and termination of sessions following the SIP
\href{https://tools.ietf.org/html/rfc3261}{RFC 3261} and any \href{https://www.packetizer.com/ipmc/sip/standards.html}{related RFCs}.

These are the \textbf{external SIP entities} involved:
\begin{itemize}
\item {} 
UACs: users hardphones, softphones, SIP-capable gadget.

\item {} 
SIP carriers/DDI Providers: carriers used to interconnect IvozProvider with external SIP
networks (and, probably, with PSTN).

\end{itemize}

All the SIP traffic (in any of the supported transports: TCP, UDP, TLS, WSS)
they send/receive is to/from this two \textbf{internal SIP entities} of IvozProvider:
\begin{itemize}
\item {} 
Users SIP Proxy (running \href{https://www.kamailio.org}{Kamailio}).

\item {} 
Trunks SIP Proxy (running \href{https://www.kamailio.org}{Kamailio}).

\end{itemize}
\begin{description}
\item[{In fact, users UACs only talk to \emph{Users SIP Proxy} and `SIP carriers' and `DDI}] \leavevmode
Providers' only talk to \emph{Trunks SIP Proxy}.

\end{description}

Inside IvozProvider these two proxies may talk to \emph{Application Servers} running
\href{http://www.asterisk.org/}{Asterisk} for some client types but \textbf{no external
element is allowed to talk to Application Servers directly}.


\section{RTP audio flow}
\label{basic_concepts/architecture/index:rtp-audio-flow}\label{basic_concepts/architecture/index:audioflow}
Sessions initiated by SIP signalling protocol imply media streams shared by
involved entities.

This media streams use \href{https://tools.ietf.org/html/rfc3550}{RTP} to send and
receive the media itself, usually using UDP as a transport protocol.

\textbf{External entities} involved in RTP sessions can be divided in:
\begin{itemize}
\item {} 
Clients endpoints.

\item {} 
Carriers/DDI Providers.

\end{itemize}

Both entities exchanges RTP with the same IvozProvider entity: \emph{media-relays}.

IvozProvider implements \emph{media-relays} using \href{https://github.com/sipwise/rtpengine}{RTPengine}.

Similar to SIP, these \emph{media-relays} exchanges RTP when is needed with
\emph{Application Servers}, but \textbf{external entities never talk directly to them}.


\section{HTTPS traffic}
\label{basic_concepts/architecture/index:https-traffic}
HTTPS is the third traffic type exchanged between IvozProvider and \emph{external
world}.

HTTPS traffic is used for:
\begin{itemize}
\item {} 
\textbf{Terminal provisioning}: several hardphones ask for their configuration when
they wake up and this configuration files can be served through HTTPS.

\item {} 
\textbf{Web portals}: IvozProvider has 4-level web portals for all the
{\hyperref[basic_concepts/operation_roles/index:operation\string-roles]{\sphinxcrossref{\DUrole{std,std-ref}{platform roles}}}}.

Both of these traffics are handled by \emph{Web portals} IvozProvider entity.

\end{itemize}


\section{Additional elements}
\label{basic_concepts/architecture/index:additional-elements}
IvozProvider has multiple elements that are not exposed to the \emph{external world}
but play a crucial task.

The most remarkable profile is \textbf{database profile} that gathers all the
information of the platform and shares it between the majority of software packaged.
IvozProvider uses \href{https://www.mysql.com/}{MySQL database engine} for this task.

Another remarkable task is \textbf{asynchronous tasks handler} in charge of encoding recordings,
generating invoices, reloading services, importing data, etc.


\section{Auxiliary elements}
\label{basic_concepts/architecture/index:auxiliary-elements}
\textbf{Aux profile} runs software that, even though is not vital for calls placing,
makes IvozProvider maintainer's life much easier.

In fact, without them, debugging problems would be much harder and the quality
of given service would be damaged.

Although IvozProvider does not include any of the tools mentioned here, we consider them crucial for dealing with
production environments.

We list here tools configured in all production IvozProvider installations maintained by
\href{https://www.irontec.com}{Irontec}:
\begin{itemize}
\item {} 
\textbf{Homer SIP capture}: This amazing software lets us capture all the SIP traffic
for later analysis, for obtaining statistics, call quality measuring, etc.
Visit \href{http://sipcapture.org/}{SIP Capture website} for more information.

\item {} 
\textbf{Kibana log viewer}: Showing logs collected by remaining \href{https://www.elastic.co/elk-stack}{ELK stack components}.

\item {} 
\textbf{Chronograf metric viewer}: Showing metrics collected by remaining \href{https://www.influxdata.com/time-series-platform/}{TICK stack components}.

\end{itemize}


\chapter{Initial Installation}
\label{basic_concepts/installation/index::doc}\label{basic_concepts/installation/index:initial-installation}

\section{Installation Types}
\label{basic_concepts/installation/install_types::doc}\label{basic_concepts/installation/install_types:installation-types}

\subsection{Distributed Install}
\label{basic_concepts/installation/install_types:distributed-install}
IvozProvider software is designed to run distributed between multiple systems
in what we call profiles:

Each profile is in charge of performing one of the platform functions:
\begin{itemize}
\item {} 
Data storage

\item {} 
SIP Proxy

\item {} 
Application Server

\item {} 
Web portal

\end{itemize}

For each of this profiles, there's a virtual package that will install all the
required dependencies (see {\hyperref[basic_concepts/installation/debian_install:installing\string-profile\string-package]{\sphinxcrossref{\DUrole{std,std-ref}{Installing profile package}}}}).

You can install as many instances as you want for each profile, but take into
account, that while some of them are designed to scale horizontally (for
example: asterisk or media-relays) others will require additional software so the
systems that have the same profile are synchronized (for example: database
replication or http request balancing).


\subsection{StandAlone Install}
\label{basic_concepts/installation/install_types:standalone-install}
If you want a small installation to make a couple of tests or give a basic
service, we have designed all this configuration so they can work in a single
machine.

We have called this kind of installations \textbf{StandAlone} and we have also
created {\hyperref[basic_concepts/installation/cd_install:automatic\string-iso\string-cd\string-image]{\sphinxcrossref{\DUrole{std,std-ref}{Automatic ISO CD image}}}} so you can install in a couple of minutes.


\section{Minimum requirements}
\label{basic_concepts/installation/requirements:minimum-requirements}\label{basic_concepts/installation/requirements::doc}

\subsection{System requirements}
\label{basic_concepts/installation/requirements:system-requirements}
IvozProvider is designed to be installed using Debian GNU/Linux APT package
system.

\begin{notice}{important}{Important:}
It's recommended to install IvozProvider in a dedicated server
for the platform. Many of the installed software may not work properly with
other pre-installed services (like MySQL or DNS servers).
\end{notice}

For a StandAlone installation, we recommend at least:
\begin{itemize}
\item {} 
4 CPUs (x86\_64 or i386)

\item {} 
4 Gb memory

\item {} 
30GB HDD

\item {} 
1/2 public IP Addresses (read note behind)

\end{itemize}

\begin{notice}{note}{Note:}
It is possible to make both KamUsers and KamTrunks
share a unique public IP address. If so, \textbf{KamTrunks ports will be changed
from 5060 (TCP/UDP) to 7060 (TCP/UDP) and from 5061 (TCP) to 7061 (TCP)}.
\end{notice}

If you're not using a {\hyperref[basic_concepts/installation/cd_install:automatic\string-iso\string-cd\string-image]{\sphinxcrossref{\DUrole{std,std-ref}{Automatic ISO CD image}}}} you will also need:
\begin{itemize}
\item {} 
Debian Stretch 9.0 base install

\item {} 
Internet access

\end{itemize}


\section{Debian packages install}
\label{basic_concepts/installation/debian_install::doc}\label{basic_concepts/installation/debian_install:debian-packages-install}
IvozProvider is designed to be installed and updated using Debian packages.
More exactly, the current release is ready to be installed on
\href{https://www.debian.org/releases/stretch}{Debian Stretch 9}.

It's recommended to use one of the \href{https://www.debian.org/releases/stretch/installmanual}{official installation guides} to install the minimum
base system. The rest of required  dependencies will be installed automatically
with IvozProvider meta packages.

No matter if you are installing a {\hyperref[basic_concepts/installation/install_types:standalone\string-install]{\sphinxcrossref{\DUrole{std,std-ref}{StandAlone Install}}}} or a
{\hyperref[basic_concepts/installation/install_types:distributed\string-install]{\sphinxcrossref{\DUrole{std,std-ref}{Distributed Install}}}}, it's required to configure Irontec debian
repositories.


\subsection{APT Repository configuration}
\label{basic_concepts/installation/debian_install:apt-repository-configuration}
Right now, two different repositories are used for the latest IvozProvider
release (called artemis) and it's frontend Klear release (called tayler).

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{cd /etc/apt/sources.list.d}
\PYG{g+go}{echo deb http://packages.irontec.com/debian artemis main extra \PYGZgt{} ivozprovider.list}
\PYG{g+go}{echo deb http://packages.irontec.com/debian tayler main \PYGZgt{} klear.list}
\end{Verbatim}

Optionally, we can add the repository key to check signed packages:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{wget http://packages.irontec.com/public.key \PYGZhy{}q \PYGZhy{}O \PYGZhy{} \textbar{} apt\PYGZhy{}key add \PYGZhy{}}
\end{Verbatim}


\subsection{Installing profile package}
\label{basic_concepts/installation/debian_install:installing-profile-package}
Once the repositories are configured, it will be required to select the proper
metapackage depending on the type of installation.
\begin{itemize}
\item {} \begin{description}
\item[{For a {\hyperref[basic_concepts/installation/install_types:standalone\string-install]{\sphinxcrossref{\DUrole{std,std-ref}{StandAlone Install}}}}:}] \leavevmode\begin{itemize}
\item {} 
ivozprovider

\end{itemize}

\end{description}

\end{itemize}

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{apt\PYGZhy{}get update}
\PYG{g+go}{apt\PYGZhy{}get install ivozprovider}
\end{Verbatim}
\begin{itemize}
\item {} 
For a {\hyperref[basic_concepts/installation/install_types:distributed\string-install]{\sphinxcrossref{\DUrole{std,std-ref}{Distributed Install}}}}: one of the profile packages depending on the
role the machine will perform.
\begin{itemize}
\item {} 
ivozprovider-profile-data

\item {} 
ivozprovider-profile-proxy

\item {} 
ivozprovider-profile-portal

\item {} 
ivozprovider-profile-as

\end{itemize}

\end{itemize}

\begin{notice}{attention}{Attention:}
Distributed installation require a couple manual configuration based on the
roles that are performing. Take into account that distributed installation process
is not documented yet. You can refer to \href{https://github.com/irontec/ivozprovider/issues/271}{documentation request} for more information.
\end{notice}


\subsection{Finish the installation}
\label{basic_concepts/installation/debian_install:finish-the-installation}
Standalone installation have a menu that can be used to configure the basic
services used in IvozProvider. Most of the services are automatically configured
to work in the same machine with the default values.

This menu allows:
\begin{itemize}
\item {} 
Configure IP address(es) for SIP proxies

\item {} 
Default platform language

\item {} 
Administrator MySQL database password

\end{itemize}

It's possible to change any of this values anytime by running:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{dpkg\PYGZhy{}reconfigure ivozprovider}
\end{Verbatim}

\begin{notice}{important}{Important:}
Any of the public IP addresses configured during the
installation will work to access the web portal. Default credentials are
\textbf{admin / changeme}.
\end{notice}


\section{Automatic ISO CD image}
\label{basic_concepts/installation/cd_install::doc}\label{basic_concepts/installation/cd_install:automatic-iso-cd-image}
You can download one of the \href{https://github.com/irontec/ivozprovider}{IvozProvider Automatic ISO CD images} (generated using
\href{https://wiki.debian.org/Simple-CDD}{simplecdd}) in stable or nightly versions:

\begin{notice}{important}{Important:}
IMPORTANT: Automatic install CDs will format target machine disk!
\end{notice}
\begin{itemize}
\item {} 
Configure the target machine to boot from CD. It will display the Debian
GNU/Linux installation menu.

\end{itemize}

\begin{notice}{note}{Note:}
You can use graphic installation if you prefer, but the following
screenshots show the standard installation.
\end{notice}

\noindent\sphinxincludegraphics{{installcd-intro}.png}
\begin{itemize}
\item {} 
Choose installation language:

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-language}.png}
\begin{itemize}
\item {} 
Choose location:

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-location}.png}
\begin{itemize}
\item {} 
Set root password

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-rootpass}.png}
\begin{itemize}
\item {} 
Choose date and time configuration:

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-clock}.png}

\begin{notice}{note}{Note:}
At this point, a generic network configuration and disk partitioning
will be performed, and also a installation of base system.
\end{notice}
\begin{itemize}
\item {} 
Setup MySQL Server root password

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-mysqlpass}.png}

\begin{notice}{important}{Important:}
MySQL password must be set in this screen and again in the following
Ivozprovider configuration menu. If you leave this field empty, the default password
will be used (see below).
\end{notice}
\begin{itemize}
\item {} 
Configure IvozProvider:

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-ivozmenu}.png}

As mentioned in {\hyperref[basic_concepts/installation/requirements:minimum\string-requirements]{\sphinxcrossref{\DUrole{std,std-ref}{Minimum requirements}}}} is required at least one public IP
address for User and Trunk SIP proxies. Remember that if you use only one,
KamTrunks will use different SIP ports to avoid collision.

You can set its addresses right now and configure the interfaces properly when
the system is fully installed. This menu can be displayed anytime after the
installation.

\noindent\sphinxincludegraphics{{installcd-proxyaddr}.png}

You can also configure default root MySQL password right now.

\begin{notice}{note}{Note:}
If you don't configure MySQL password, default password will be used
(changeme). You can still change it later.
\end{notice}

\noindent\sphinxincludegraphics{{installcd-mysql}.png}

And default language for portals:

\noindent\sphinxincludegraphics{{installcd-portallang}.png}

\begin{notice}{note}{Note:}
It is not require to configure all settings during initial
installation. In case any setting has been left without configuration a
warning dialog will be displayed.
\end{notice}

\noindent\sphinxincludegraphics{{installcd-warning}.png}

At last, select where the GRUB boot loader will be installed.

\noindent\sphinxincludegraphics{{installcd-grub}.png}

After the reboot, you are ready to access using the web portals!

\begin{notice}{important}{Important:}
Any of the public IP addresses configured during the
installation will work to access the web portal. Default credentials are
\textbf{admin / changeme}.
\end{notice}


\section{Extra components}
\label{basic_concepts/installation/extra_components::doc}\label{basic_concepts/installation/extra_components:extra-components}

\subsection{G.729}
\label{basic_concepts/installation/extra_components:g-729}
\begin{notice}{attention}{Attention:}
G.729 codec is offered by default for outgoing external calls. If you
don't install it using following instructions, it must be removed from pjsip.conf
configuration file. Otherwise, application servers will be offering a not available codec.
\end{notice}

\begin{notice}{important}{Important:}
In some countries, you might have to pay royalty fees in order to
use G.729 codec to their patent holders. We're not legal advisers regarding
active or withdrawn world patents.
\end{notice}

You can use G.729 with IvozProvider, but installation must be done manually.
G.729 codec is optimized for each CPU type and version of asterisk, so each
installation may require a different codec module.

You can download codec from \href{http://asterisk.hosting.lv/}{here} under the
section Asterisk 13.

Once downloaded, move the \sphinxtitleref{.so} file to \textbf{/usr/lib/asterisk/modules/} and rename
it to \textbf{codec\_g729.so}

You can check the codec is valid by loading the module in asterisk and printing the
available codec translations using:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{asterisk \PYGZhy{}rx \PYGZsq{}module load codec\PYGZus{}g729.so\PYGZsq{}}
\PYG{g+go}{asterisk \PYGZhy{}rx \PYGZsq{}core show translation\PYGZsq{} \textbar{} grep 729}
\end{Verbatim}


\chapter{Platform roles}
\label{basic_concepts/operation_roles/index:operation-roles}\label{basic_concepts/operation_roles/index::doc}\label{basic_concepts/operation_roles/index:platform-roles}
IvozProvider is a multilevel role provider solution.

The following images shows the different available levels and the
relation between them:

\noindent\sphinxincludegraphics{{operator_levels2}.png}

This section will explain each of the available roles, describing their
responsibilities and more important tasks.


\section{Global administrator role}
\label{basic_concepts/operation_roles/index:global-administrator-role}
The global administrator role (operator in the image) is usually done by
the installation responsible.

All options and platform features are visible to this role and usually is
in charge of its maintenance.

Their most important task is to \textbf{create Brands} and configure them so
they have the enough autonomy to properly use the platform:
\begin{itemize}
\item {} 
Configure their web access.

\item {} 
Configure their brand portal look and feel: themes, colors, etc.

\end{itemize}

Apart from their main task, their global visibility and total access
makes them responsible of:
\begin{itemize}
\item {} 
Monitor the platform so it keeps always UP \& RUNNING

\item {} 
Analyze platform logs to track possible errors.

\item {} 
Polish the security mechanisms to avoid external attacks.

\item {} 
Obtain global statistics of calls audio quality.

\item {} 
Increase the available resources of the platform as long as is needed:
\begin{itemize}
\item {} 
Increasing resources available in a standalone installation

\item {} 
Migrating, whenever required, to a distributed installation with multiple
AS, media relays, etc.

\end{itemize}

\end{itemize}

To sum up, \textbf{this role is the only one that has no limits within the
platform}, that's why \emph{God} is a term used in multiple places along this
documentation.

\begin{notice}{important}{Important:}
\emph{This role is responsible of maintaining the platform*}, configuring
it for the correct behaviour. This role \textbf{doesn't have any kind
of limit} and \textbf{grants access} to the \textbf{brand operators}.
\end{notice}


\section{Brand administrator role}
\label{basic_concepts/operation_roles/index:brand-administrator-role}
Brand operator can access a portal with less sections available compared
to the previous role. The general (God) administrator is in charge of
providing an URL with credentials for its brand portal.

The most important task for brand operator is to \textbf{create and configure
clients so they can work properly}.

Due to brand operators are also responsible of billing their clients and
make sure the external calls are properly setup, it must also manage:
\begin{itemize}
\item {} 
Peering contracts with other IP providers for PSTN interconnection.

\item {} 
Include all required client information for the billing process.

\item {} 
Pricing plans that will offer to their clients, that will determine how
match they pay for each call.

\item {} 
Setup the routes for each outgoing call types based on their final
destination

\item {} 
Create the invoices for each billing period and send them to their
clients.

\end{itemize}

As you can see, the task of brand operator has little in common with the
global operator, but their importance is vital so the final users can use
all the features includes in IvozProvider
\phantomsection\label{basic_concepts/operation_roles/index:brand-responsibilities}
\begin{notice}{important}{Important:}
\textbf{To sum up}, brand operators \textbf{grant access} to their
\textbf{clients} administrators and \textbf{configure the platform
to route and rate their calls}.
\end{notice}


\section{Client administrator role}
\label{basic_concepts/operation_roles/index:client-administrator-role}
The client administrator has access to the portal supplied by the brand
operator.

From its point of view, it has a virtual pbx in the cloud that must
configure for its users.

To accomplish that, it's required:
\begin{itemize}
\item {} 
Configure terminals, extensions and users.

\item {} 
Configure the DDI incoming process with the proper logic:
\begin{itemize}
\item {} 
Directly to an user

\item {} 
IVRs

\item {} 
Hunt groups

\item {} 
Faxes

\end{itemize}

\item {} 
Give access to the final users to their web portal, so they can configure
their profile options:
\begin{itemize}
\item {} 
Call forward

\item {} 
Do not disturb

\item {} 
Call waiting

\end{itemize}

\end{itemize}

\begin{notice}{important}{Important:}
To sum up, the client administrators are responsible for
\textbf{configuring the telephony system and make use of all the
features available in IvozProvider}.
\end{notice}


\section{Final user role}
\label{basic_concepts/operation_roles/index:final-user-role}
The final user has two different kinds of credentials, both supplied by
its client administrator:
\begin{itemize}
\item {} 
User portal access credentials

\item {} 
SIP credentials used to register terminals to IvozProvider

\end{itemize}

Through the user portal, it can browse their call registry and configure:
\begin{itemize}
\item {} 
Call forward

\item {} 
Do not disturb

\item {} 
Call waiting

\item {} 
Displayed data when calling

\item {} 
Geographical configuration

\end{itemize}

On the other hand, the SIP credentials allow users to configure their terminals to place and receive calls.

\begin{notice}{note}{Note:}
The same SIP credentials can be used in multiple devices at the same
time,generating what is known as \emph{parallel-forking}: whenever a call is
placed to an user, all the active devices will ring so the user can
answer the call from any of them.
\end{notice}


\chapter{Making internal calls}
\label{getting_started/internal_calls/index:making-internal-calls}\label{getting_started/internal_calls/index::doc}
The goal of this block will be to configure IvozProvider in order to make
internal calls, using as the starting point the base installation described
in the previous step.

In order to achieve making a call between Alice and Bob, we have to fulfill some tasks in
the three configuration levels described in {\hyperref[basic_concepts/operation_roles/index:operation\string-roles]{\sphinxcrossref{\DUrole{std,std-ref}{Platform roles}}}}.

That's why we have ordered the index in these 3 blocks:


\section{Global Configuration}
\label{getting_started/internal_calls/god_portal:global-configuration}\label{getting_started/internal_calls/god_portal::doc}
\begin{notice}{important}{Important:}
Any of the 2 Public IP addresses configured during the
installation will work to access the web portal. Default credentials are
\textbf{admin / changeme}.
\end{notice}

In this section will reference global administrator configuration options,
available in the menu (\textbf{Main management}) of the web portal (only visible to
God Admins):


\subsection{Emulate the Demo brand}
\label{getting_started/internal_calls/god_portal:emulate-the-demo-brand}
As mentioned above, the initial installation will have an already created brand
called DemoBrand, that will be used for our goal: to have 2 telephones registered
that can call each other.

Before going to the next section, is quite important to understand how the
\textbf{emulation} works.
\begin{itemize}
\item {} 
As global operator, you have access to the menu \textbf{Global Configuration} only
visible to \emph{God} administrators.

\item {} 
Apart from that menu, you will also have access to the \textbf{Brand Configuration}
and \textbf{Client configuration} blocks.

\item {} 
Last two blocks have a red button in the right side.

\item {} 
When pressed, a popup will be displayed that lists all existing brands / clients.

\item {} 
After selecting the DemoBrand brand, the icon will change.

\item {} 
The upper right corner of the portal will also display the brand that is being
emulated.

\end{itemize}


\subsection{What emulation means}
\label{getting_started/internal_calls/god_portal:what-emulation-means}
Basically, that \textbf{everything in the menu `Brand configuration' will be relative
to the chosen brand} and is \textbf{exactly} the same menu entries that the brand
operator will see using its brand portal.

\begin{notice}{tip}{Tip:}
Ok, ok, maybe exactly is not totally accurate. The global operator is
able to see some fields in some screens that other admins can't (i.e. On
Client edit screen, fields like `Media relays' or `Application server' are
only configurable by the global operator.
\end{notice}


\section{Brand Configuration}
\label{getting_started/internal_calls/brand_portal::doc}\label{getting_started/internal_calls/brand_portal:brand-configuration}
We need that the default DemoBrand has a client with at least 2 users. In
order to achieve this we will require a little configuration in this section.

In fact, if we check \textbf{Virtual PBXs} in the brand menu, we'll discover that there
is already an existing \emph{DemoCompany} that we can use to fulfill our desired
goal :)

Only a thing is required to configure for this client, pressing \textbf{Edit client} option.


\subsection{Client SIP Domain}
\label{getting_started/internal_calls/brand_portal:domain-per-client}\label{getting_started/internal_calls/brand_portal:client-sip-domain}
As mentioned in the previous section, is \textbf{required} that each of the vPBX clients
has a public domain that resolves to the configured IP address for
{\hyperref[administration_portal/platform/infrastructure/proxy_users:proxyusers]{\sphinxcrossref{\DUrole{std,std-ref}{Proxy Users}}}}.

\begin{notice}{note}{Note:}
DNS register can be type A (supported by all the hardphones/softphones
) or even NAPTR+SRV.
\end{notice}

Once the domain has been configured (by means that are out of scope of this
document), it will be enough to write it in our client configuration \textbf{SIP Domain} field.

Once the client has been saved, the domain will be also displayed in the list in the column \textbf{SIP domain}.

\begin{notice}{attention}{Attention:}
It's important to understand this block. {\hyperref[getting_started/internal_calls/brand_portal:dnshack]{\sphinxcrossref{\DUrole{std,std-ref}{Unless we've a
single client registered}}}}, without a DNS domain pointing to our
users proxy IP address, everything will fail.
\end{notice}

\begin{notice}{danger}{Danger:}
Have we repeated enough that without a properly configured DNS
pointing to the Users proxy IP address nothing will work?
\end{notice}


\subsubsection{I have no time for a DNS registry}
\label{getting_started/internal_calls/brand_portal:dnshack}\label{getting_started/internal_calls/brand_portal:i-have-no-time-for-a-dns-registry}
Everything we have said is true: as we create new brands and brands create new
clients, each of them will need a DNS registry.

But the first client of the platform is quite special and can take over the IP
address of the proxy to use it as a domain.

Although it is not a domain, but being used like it was, it will be displayed
in {\hyperref[administration_portal/platform/sip_domains:sip\string-domains]{\sphinxcrossref{\DUrole{std,std-ref}{SIP domains}}}} section.

\begin{notice}{tip}{Tip:}
It’s important to understand the this trick is only valid for the first
client of the platform ;)
\end{notice}


\subsection{Emulate Demo client}
\label{getting_started/internal_calls/brand_portal:emulate-client}\label{getting_started/internal_calls/brand_portal:emulate-demo-client}
The client emulation process is the same as the brand emulation, with the
difference that it filters the block ‘Client Configuration’ instead of
‘Brand Configuration’.

Once the client has been emulated, the top right corner of the portal will
show that we are in the right path :)


\section{Client Configuration}
\label{getting_started/internal_calls/client_portal:client-configuration}\label{getting_started/internal_calls/client_portal::doc}
We're close to make our fist call in our fresh installed IvozProvider, there
are only 6 steps to configure in our DemoClient virtual pbx.
\begin{itemize}
\item {} 
2 terminals

\item {} 
2 extensions

\item {} 
2 users

\end{itemize}


\subsection{Creating Terminals}
\label{getting_started/internal_calls/client_portal:creating-terminals}
Go to the terminal section and... voilà! We already have 2 terminals created.


\subsection{Creating Extensions}
\label{getting_started/internal_calls/client_portal:creating-extensions}
Then we go to extensions, just to check that we have 2 extensions already
created for us.

Nothing more to do in this section, let's go the next one!


\subsection{Creating Users}
\label{getting_started/internal_calls/client_portal:creating-users}
As expected, we also have 2 created users with previous extensions and terminals assigned.

At this point, we have everything ready make a call between this two users: Alice and Bob.


\section{SIP Terminal configuration}
\label{getting_started/internal_calls/configure_sipuacs:sip-terminal-configuration}\label{getting_started/internal_calls/configure_sipuacs::doc}
The last thing we need is 2 SIP terminals (hardphones, softphones or even
mobile applications) and configure them as follows:

\textbf{ALICE}
\begin{itemize}
\item {} 
\textbf{User}: alice

\item {} 
\textbf{Password}: alice

\item {} 
\textbf{Domain}: users.democlient.com (or the IP if we are using {\hyperref[getting_started/internal_calls/brand_portal:dnshack]{\sphinxcrossref{\DUrole{std,std-ref}{the DNS
trick}}}})

\end{itemize}

\textbf{BOB}
\begin{itemize}
\item {} 
\textbf{User}: bob

\item {} 
\textbf{Password}: bob

\item {} 
\textbf{Domain}: users.democlient.com (or the IP if we are using {\hyperref[getting_started/internal_calls/brand_portal:dnshack]{\sphinxcrossref{\DUrole{std,std-ref}{the DNS
trick}}}})

\end{itemize}

\begin{notice}{tip}{Tip:}
Sometimes the user and domain is configured in a single option. In this
case we should enter \href{mailto:alice@users.democlient.com}{alice@users.democlient.com} and \href{mailto:bob@users.democlient.com}{bob@users.democlient.com}
(or the IP if we are using {\hyperref[getting_started/internal_calls/brand_portal:dnshack]{\sphinxcrossref{\DUrole{std,std-ref}{the DNS trick}}}})
\end{notice}

After configuring the terminals, Alice should be able to call Bob only by
dialing 102 in her terminal.


\chapter{Receiving external calls}
\label{getting_started/external_incoming_calls/index::doc}\label{getting_started/external_incoming_calls/index:receiving-external-calls}
The goal of this block will be configure IvozProvider to receive incoming
external calls.

In order to achieve this, this steps will be followed:


\section{Transformations configuration}
\label{getting_started/external_incoming_calls/transformations:transformations-configuration}\label{getting_started/external_incoming_calls/transformations::doc}
\textbf{IvozProvider} is designed to provide service \textbf{anywhere in the planet}, not
only the original country where the platform is installed.

A very important concept to achieve this goal are the numeric transformations,
that \textbf{adapts the different number format systems of the countries of the world}
defined in \href{https://www.itu.int/rec/T-REC-E.164/es}{E.164} \textbf{to a neutral
format}.

The section that allows the brand operator to configure all the \textbf{numeric
transformations} is \textbf{Brand Configuration / Providers / Numeric transformations}.

You can find more information about transformations in {\hyperref[administration_portal/brand/settings/numeric_transformations:numeric\string-transformations]{\sphinxcrossref{\DUrole{std,std-ref}{Numeric transformations}}}} section.

\begin{notice}{tip}{Tip:}
We already have a pre-created set for most of the countries of the world, so hopefully nothing needs to be done here.
\end{notice}


\section{Peering configuration}
\label{getting_started/external_incoming_calls/peering:peering-configuration}\label{getting_started/external_incoming_calls/peering::doc}
We understand a \textbf{Peering contract} the agreement between a \textbf{Brand Operator}
and a VoIP Provider to make and receive calls.

We divide Peerings in two types:
\begin{itemize}
\item {} 
\textbf{Carriers} for outgoing calls (see {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carriers}}}}).

\item {} 
\textbf{DDI Providers} for incoming calls (see {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Providers}}}}).

\end{itemize}

In order to achieve our goal, we will need to create a new (an valid) DDI Provider assign our country's
numeric transformation. See {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Providers}}}} for further reference.

Once we have an agreement with a DDI provider and we have configured it in
the previous section, only two task are pending:


\section{Configuring an external DDI}
\label{getting_started/external_incoming_calls/configure_ddi:settingup-ddi}\label{getting_started/external_incoming_calls/configure_ddi:configuring-an-external-ddi}\label{getting_started/external_incoming_calls/configure_ddi::doc}
The brand operator, responsible of these \emph{peering} agreements with VoIP providers,
has the task to create the DDIs for each client.

Notice that in order to access this section, the brand operator (or \emph{god})
must have emulated the proper client and access the menu section \textbf{Client
Configuration}.

\begin{notice}{attention}{Attention:}
Section \textbf{Client configuration \textgreater{} DDIs} is different when the
client administrator access than the displayed data when a global or brand
administrator does. Client administrator are unable to create or delete
DDIs, just edit the one created by the brand or god administrator.
\end{notice}

Taking into account these concepts, we create a new DDI and fill the required
fields.

For detailed information about configuration fields, check {\hyperref[administration_portal/client/vpbx/ddis:pbx\string-ddis]{\sphinxcrossref{\DUrole{std,std-ref}{DDIs}}}} section.
\paragraph{Configure incoming routes}

In the previous section, we have created the DDI and configure it (pointing it to user Alice),
but \textbf{the most common procedure} is that the brand operator just creates the DDI while the
\textbf{client administrator}, using the same section, \textbf{configures} it choosing
the correct route (user, hunt group, etc.), calendars filters and so on.

\begin{notice}{note}{Note:}
At this point, calling the number of the configured DDI will make the
\emph{Alice} phone ring.
\end{notice}


\chapter{Making external calls}
\label{getting_started/external_outgoing_calls/index:making-external-calls}\label{getting_started/external_outgoing_calls/index::doc}
The goal of this section is configuring IvozProvider to make external outgoing
calls, taking previous section configuration as a starting point.

We will follow these steps:


\section{Create a new carrier}
\label{getting_started/external_outgoing_calls/create_carrier:create-a-new-carrier}\label{getting_started/external_outgoing_calls/create_carrier::doc}
At this point of the configuration, we have to configure IvozProvider to receive
calls using a DDI Provider, but we have not configured a Carrier to make external call.

\begin{notice}{tip}{Tip:}
VoIP Providers will usually provide both services: making and receiving calls.
\end{notice}

Configure a Carrier in a similar way we configured the DDI Provider (further instructions {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}),
assigning it the same numeric transformation set.


\section{Where do I call?}
\label{getting_started/external_outgoing_calls/where_do_i_call::doc}\label{getting_started/external_outgoing_calls/where_do_i_call:where-do-i-call}
At this point of the configuration, we have to configure IvozProvider to use the
already configured \emph{Carrier} to place the external calls we are making.

To achieve this, in first place, we need that the dialed external numbers fall
in an existing \textbf{target pattern}:
\begin{itemize}
\item {} 
{\hyperref[administration_portal/brand/routing/routing_patterns:routing\string-patterns]{\sphinxcrossref{\DUrole{std,std-ref}{Routing patterns}}}}

\item {} 
{\hyperref[administration_portal/brand/routing/routing_patterns_groups:routing\string-pattern\string-groups]{\sphinxcrossref{\DUrole{std,std-ref}{Routing pattern groups}}}}

\end{itemize}

\begin{notice}{tip}{Tip:}
To achieve our goal of making an external call to a spanish number, we didn't have
to modify the initial contents of this two sections as Spain pattern already exists :)
\end{notice}


\section{Outgoing Routing configuration}
\label{getting_started/external_outgoing_calls/call_routing:outgoing-routing-configuration}\label{getting_started/external_outgoing_calls/call_routing::doc}
We already have our test call categorized as a call within the \textbf{Routing pattern}
`Spain'. In addition, we also have a \textbf{Routing pattern group} including `Spain',
called `Europe'.

Now we have to tell IvozProvider that calls to `Spain' or `Europe' should be
established through our new \textbf{Carrier}.

To make this assignment, we use the section \textbf{Brand Configuration \textgreater{} Routing \textgreater{} Outgoing routings}:
\begin{itemize}
\item {} 
Client: ``Apply to all clients'' (or just \emph{democompany}).

\item {} 
Type: pattern.

\item {} 
Destination pattern: Spain.

\item {} 
Route type: static.

\item {} 
Carriers: our new carrier.

\item {} 
Priority: 1

\item {} 
Priority: 1

\end{itemize}

For more information about routing and load balancing check {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}} section.


\section{Outgoing DDI configuration}
\label{getting_started/external_outgoing_calls/outgoing_ddi:external-ddi}\label{getting_started/external_outgoing_calls/outgoing_ddi::doc}\label{getting_started/external_outgoing_calls/outgoing_ddi:outgoing-ddi-configuration}
Before placing our first outgoing call, it would be desirable to choose the
number that the callee will see when the phone rings, so that he can return the
call easily.

To achieve this goal, we have to configure our DDI as \emph{Alice's} \textbf{outbound DDI},
because she will be the chosen one to place our first outgoing call.

We can set this up editing \emph{Alice} in \textbf{Client Configuration} \textgreater{} \textbf{Users}. If
this change is made by brand operator or global operator, he must {\hyperref[getting_started/internal_calls/brand_portal:emulate\string-client]{\sphinxcrossref{\DUrole{std,std-ref}{emulate
the corresponding client}}}} previously.

\begin{notice}{tip}{Tip:}
We could have set the same DDI as Default Outgoing DDI at client level, editing \emph{democompany} client.
\end{notice}

\begin{notice}{error}{Error:}
Calls from users without an outgoing DDI will be rejected by IvozProvider.
\end{notice}

At this point, we are looking forward to make our first outgoing call with our
new IvozProvider, we may have even tried to call with current configuration but...


\section{No rating plan, no call}
\label{getting_started/external_outgoing_calls/noplan_nocall:no-rating-plan-no-call}\label{getting_started/external_outgoing_calls/noplan_nocall:noplan-nocall}\label{getting_started/external_outgoing_calls/noplan_nocall::doc}
Just the way we warned {\hyperref[basic_concepts/operation_roles/index:brand\string-responsibilities]{\sphinxcrossref{\DUrole{std,std-ref}{when we described the duties of the brand operator}}}}, the brand operator is \textbf{responsible for making all the
needed setup so that IvozProvider is able to bill all external calls}.

\begin{notice}{note}{Note:}
\textbf{Billing a call} is the action of \textbf{assigning price} to a call that implies
cost.
\end{notice}

\textbf{IvozProvider checks live that a call can be billed when it is established} to avoid
placing calls that imply cost but won't be billed because Brand Operator, due to
a mistake, hasn't assigned a price.

\begin{notice}{error}{Error:}
If a call can't be billed, IvozProvider won't allow its establishment.
\end{notice}


\subsection{Creating a rating plan}
\label{getting_started/external_outgoing_calls/noplan_nocall:creating-a-rating-plan}
\textbf{Brand Configuration \textgreater{} Billing \textgreater{} Destination} section is empty by default, as opposed to routing patterns section,
that has all the 254 countries of the world. The reason is that one destination rate
will usually imply lots of pattern per country (GSM networks, especial numbers,
mobile numbers, fixed lines, etc.).

In most of the cases, this section data will be imported from CSV provided by your
VoIP provider, but for our test we will create it manually:
\begin{itemize}
\item {} 
Create a \textbf{destination} with `+34' for Spain.

\item {} 
Create a \textbf{destination rate} and insert a price for Spain destination.

\item {} 
Create a \textbf{rating plan} that includes that destination rate.

\end{itemize}


\subsection{Assign rating plan to client}
\label{getting_started/external_outgoing_calls/noplan_nocall:assign-rating-plan-to-client}
The last step is \textbf{assigning that rating plan} to \emph{democompany} following the indication
{\hyperref[administration_portal/brand/billing/rating_plans:assigning\string-rating\string-plans\string-to\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}.


\section{Outgoing configuration complete!}
\label{getting_started/external_outgoing_calls/finish:outgoing-configuration-complete}\label{getting_started/external_outgoing_calls/finish::doc}
That's it!

At this point, \emph{Alice} should be able to make outgoing calls to
spanish destinations and this calls should be routed and billed accordingly.


\chapter{Platform Configuration}
\label{administration_portal/platform/index::doc}\label{administration_portal/platform/index:platform-configuration}
This section is only shown to \emph{God administrator} and allows modifying global configurations:


\section{Brands}
\label{administration_portal/platform/brands:brands}\label{administration_portal/platform/brands::doc}
\emph{God operator} is responsible for creating and managing platform brands through this section.

This are the fields shown when a new brand is created:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/brands:term-name}
Sets the name for this brand.

\item[{TIN\index{TIN|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/brands:term-tin}
Number used in this brand's invoices.

\item[{Logo\index{Logo|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/brands:term-logo}
Used as default logo in invoices and in portals (if they don't specify
another logo).

\item[{Invoice data\index{Invoice data|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/brands:term-invoice-data}
Data included in invoices created by this brand.

\item[{SIP domain\index{SIP domain|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/brands:term-sip-domain}
Introduced in 1.4. Domain pointing to Users SIP proxy used by all the
Retail Accounts and Residential Devices of this brand.

\item[{Recordings\index{Recordings|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/brands:term-recordings}
Configures a limit for the size of recordings of this brand. A
notification is sent to configured address when 80\% is reached and
older recordings are rotated when configured size is reached.

\item[{Features\index{Features|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/brands:term-features}
Introduced in 1.3, lets god operator choose the features of the created
brand. An equivalent configuration is available in Clients, to choose
between the ones that god operator gave to your Brand. Related sections
are hidden consequently.

\item[{Max calls\index{Max calls|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/brands:term-max-calls}
Limits both user generated and \textbf{external} received calls to this value
(0 for unlimited).

\item[{Locales\index{Locales|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/brands:term-locales}
Define default Timezone, Language and Currency for clients of this brand.

\end{description}

\begin{notice}{hint}{Hint:}
Some features are related to brand and cannot be assigned to clients.
Other ones are also related to clients and lets the brand operator to
assign them to its clients.
\end{notice}

\begin{notice}{warning}{Warning:}
Disabling billing hides all related sections and assumes that an
external element will set a price for calls (external tarification
module is needed, ask for it!).
\end{notice}

\begin{notice}{note}{Note:}
Disabling invoices hides related sections, assuming you will use an
external tool to generate them.
\end{notice}

\begin{notice}{note}{Note:}
SIP domain is only visible for Brands with Retail or Residential features
enabled.
\end{notice}


\subsection{Brand operators}
\label{administration_portal/platform/brands:brand-operators}
\textbf{List of brand operators} subsection allows adding/editing/deleting credentials for brand portal access.


\subsection{Brand Portals}
\label{administration_portal/platform/brands:brand-portals}
\textbf{List of brand portals} subsection allows managing URLs to access to the different web portals available for a given brand.

See {\hyperref[administration_portal/brand/settings/client_portals:client\string-portals]{\sphinxcrossref{\DUrole{std,std-ref}{Client Portals}}}} for further reference.

\begin{notice}{warning}{Warning:}
URLs are assigned to brands. This means that through a given URL the brand can be guessed, but not the client.
As a result, username collision domain will be at brand level (there cannot exist to client administrators
with the same username within a brand).
\end{notice}


\section{Main operators}
\label{administration_portal/platform/main_operators::doc}\label{administration_portal/platform/main_operators:main-operators}
This section lists the credentials to log into the god administration portal. You can edit or delete existing credentials,
and create new ones.

These are the required fields of each entry:
\begin{description}
\item[{Username\index{Username|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/main_operators:term-username}
User for login process.

\item[{Password\index{Password|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/main_operators:term-password}
Password for login process.

\item[{Timezone\index{Timezone|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/main_operators:term-timezone}
Used for showing dates in External Calls and similar sections.

\end{description}

Remaining fields are not required nor used anywhere, they just allow storing additional information of a given user
(name, lastname and email).


\section{Antiflood trusted IPs}
\label{administration_portal/platform/antiflood_trusted_ips::doc}\label{administration_portal/platform/antiflood_trusted_ips:antiflood-trusted-ips}\label{administration_portal/platform/antiflood_trusted_ips:id1}
IvozProvider comes with an \emph{anti-flooding} mechanism to avoid that a single
sender can deny the platform service by sending lots of requests. Both \emph{proxies}
(users and trunks) use this mechanism, that \textbf{limits the number of requests
from an origin address in a time lapse}.

\begin{notice}{warning}{Warning:}
When an origin reaches this limit, the proxy will stop sending
responses for a period of time. After this time, the requests will be again
handled normally.
\end{notice}

Some origins are automatically excluded from this \emph{anti-flooding} mechanism:
\begin{itemize}
\item {} 
Application Servers from the platform.

\item {} 
Client authorized IP addresses or ranges (see previous section).

\end{itemize}

Global operator of the platform can also add exceptions to this mechanism in
the section \textbf{Global configuration} \textgreater{} \textbf{Antiflood trusted IPs}.


\section{Terminal manufacturers}
\label{administration_portal/platform/terminal_manufacturers:terminal-manufacturers}\label{administration_portal/platform/terminal_manufacturers::doc}\label{administration_portal/platform/terminal_manufacturers:provisioning}

\subsection{Overview}
\label{administration_portal/platform/terminal_manufacturers:overview}
IvozProvider supports provisioning of terminals via HTTP/HTTPS that fulfill the
following requirements:
\begin{itemize}
\item {} 
Assuming a just unboxed terminal, just plugged and connected to the network:
\begin{itemize}
\item {} 
Ask IP address via DHCP.

\item {} 
DCHP has enabled the option 66 that points to the platform portal

\item {} 
The first requested provisioning file is a static file (different for each
model) prefixed with the previous step URL.

\item {} 
The served file can redefine the URL for further requests

\end{itemize}

\end{itemize}

Any terminal model that can adapt to this provisioning way can be added into
the section \textbf{Platform Configuration \textgreater{} Terminal manufacturers}.
\paragraph{Example Cisco SPA504G}
\begin{itemize}
\item {} 
Cisco SPA504G is turned on and requests an IP address to DHCP

\item {} 
Receives “\url{http://provision.example.com/provision}” as DHCP option 66

\item {} 
Request HTTP configuration from \url{http://provision.example.com/provision/spa504g.cfg}

\item {} 
All 504G request the same file (spa504.cfg), prefixed with the given URL

\item {} 
This file only contain basic configuration settings for the model and the URL
for the next request (p.e. \url{https://provision.example.com/provision/\$MAC.cfg})

\item {} 
This way, each terminal (MAC should be unique) request a specific file
(and different) after the generic one has been served.

\item {} 
This file will contain the specific configuration for the terminal:
\begin{itemize}
\item {} 
User

\item {} 
Password

\item {} 
SIP Domain

\end{itemize}

\end{itemize}

\begin{notice}{note}{Note:}
IvozProvider provisioning system, right now, only has one goal:
provide credentials and language settings for the terminals.
\end{notice}


\subsection{Configuration of supported models}
\label{administration_portal/platform/terminal_manufacturers:configuration-of-supported-models}
IvozProvider uses a template system that allows global operator (God) to
define new models and configure what files will be served.

The help section of \textbf{Terminal manufacturers} has examples for some models
that work (in the moment of writting this) with IvozProvider provisioning system.

\begin{notice}{hint}{Hint:}
These models will be available after the initial installation, but
you must edit them and load the default configuration before
you can use the provisioning system (option \textbf{Restore default template}).
\end{notice}

\begin{notice}{error}{Error:}
UACs firmware changes may cause that given examples stop working. We
will try to keep templates updated, but we can't guarantee this point.
\end{notice}

Analyzing the suggested templates you can have a basic idea of the flexibility of
the system to configure any existing terminal model in the market and to adapt
them to eventual changes in given examples.


\subsection{Getting technical}
\label{administration_portal/platform/terminal_manufacturers:getting-technical}
Imagine an environment with this configuration:
\begin{itemize}
\item {} 
Provisioning URLs:
\begin{itemize}
\item {} 
Generic file: \url{http://PROV\_IP/provision}

\item {} 
Specific file: \url{https://PROV\_IP:PROV\_PORT/provision}

\end{itemize}

\item {} 
TerminalModels.genericUrlPattern: y000000000044.cfg

\end{itemize}

Which requested URLs will be valid?

For generic file, just one: \url{http://PROV\_IP/provision/y000000000044.cfg}

For specific file, requests are right as long as this rules are fulfilled:
\begin{itemize}
\item {} 
All HTTP requests are wrong.

\item {} 
HTTPS requests to 443 are wrong (PROV\_PORT must be used).

\item {} 
Subpaths after provisioning URL are ignored, both in request and in
specificUrlPattern.

\item {} 
On specific file request, extension must match as long as extension is used
in specificUrlPattern.

\item {} 
On specific file request, the filename must match exactly once \{mac\} is replaced.

\item {} 
MAC address is case insensitive and can contain colons or not (`:').

\end{itemize}

Let's analyze the examples below to understand this rules better:
\paragraph{Example 1 - TerminalModels.specificUrlPattern: \{mac\}.cfg}

Working requests:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/aabbccddeeff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/aa:bb:cc:dd:ee:ff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/aabbccdd:ee:ff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/aabbccddeeff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/AABBCCDDEEFF.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/aabbccddeeff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/subpath2/aabbccddeeff.cfg}
\end{Verbatim}

Wrong requests:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/aabbccddeeff.boot}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/subpath2/aabbccddeeff.boot}
\end{Verbatim}

This example is identical to `t23/\{mac\}.cfg', as subpaths are ignored.
\paragraph{Example 2 - TerminalModels.specificUrlPattern: \{mac\}}

All previous examples are ok, as extension is ignored if no extension is found
in specificUrlPattern.

This example is identical to `t23/\{mac\}', as subpaths are ignored.
\paragraph{Example 3 - TerminalModels.specificUrlPattern: yea-\{mac\}.cfg}

All previous examples are wrong, as no `yea-` is found (`yea' match is case
sensitive).

Working requests:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/yea\PYGZhy{}aabbccdd:ee:ff.cfg}
\end{Verbatim}

Wrong requests:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/yea\PYGZhy{}aabbccdd:ee:ff.boot}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/YEA\PYGZhy{}aabbccdd:ee:ff.cfg}
\end{Verbatim}

This example is identical to `t23/yea-\{mac\}.cfg', as subpaths are ignored.
\paragraph{Example 4 - TerminalModels.specificUrlPattern: yea-\{mac\}}

As no extension is given:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/yea\PYGZhy{}aabbccdd:ee:ff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/yea\PYGZhy{}aabbccdd:ee:ff.boot}
\end{Verbatim}

Wrong requests:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/YEA\PYGZhy{}aabbccdd:ee:ff.cfg}
\end{Verbatim}

This example is identical to `t23/yea-\{mac\}', as subpaths are ignored.


\section{Services}
\label{administration_portal/platform/services:services}\label{administration_portal/platform/services::doc}\label{administration_portal/platform/services:god-services}
There are \textbf{special services} that can be accessed by calling to some codes
\textbf{from the terminal}.

\begin{notice}{danger}{Danger:}
Services defined in this section \textbf{are not accessible during a
conversation}. They are activated by \textbf{calling the codes}, not using
DTMF codes while talking.
\end{notice}

There are the following \textbf{special services} available in the section \textbf{Global
configuration} \textgreater{} \textbf{Services}:
\begin{description}
\item[{Direct pickup\index{Direct pickup|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/services:term-direct-pickup}
This service allows capturing a ringing call from another terminal by
calling the code followed by the extension from the target user.

\item[{Group pickup\index{Group pickup|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/services:term-group-pickup}
This service allows capturing a ringing call for any terminal whose user
is part of one of the capturer pickup groups.

\item[{Check voicemail\index{Check voicemail|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/services:term-check-voicemail}
This service allows checking the user's voicemail using an interactive
menu from which new voicemails can be listen, deleted, etc. This is an
active alternative to receive voicemails via the email. Since 1.4, this
service allows optional extension after the service code to check
another users voicemails. Users can protect their voicemail using the
internal menu options.

\item[{Record locution\index{Record locution|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/services:term-record-locution}
This service allows any user to record their client's locutions by
dialing an special code. Voice instructions will be provided in the
user's language.

\item[{Open Lock\index{Open Lock|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/services:term-open-lock}
Calling this service code will set route lock status to `Opened' (see {\hyperref[administration_portal/client/vpbx/routing_tools/route_locks:route\string-locks]{\sphinxcrossref{\DUrole{std,std-ref}{Route locks}}}}).

\item[{Close Lock\index{Close Lock|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/services:term-close-lock}
Calling this service code will set route lock status to `Closed' (see {\hyperref[administration_portal/client/vpbx/routing_tools/route_locks:route\string-locks]{\sphinxcrossref{\DUrole{std,std-ref}{Route locks}}}}).

\item[{Toggle Lock\index{Toggle Lock|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/services:term-toggle-lock}
Calling this service code will change the current status of the lock (see {\hyperref[administration_portal/client/vpbx/routing_tools/route_locks:route\string-locks]{\sphinxcrossref{\DUrole{std,std-ref}{Route locks}}}}).

\end{description}

As soon as new services are implemented into IvozProvider, they will be listed
in this section.

\begin{notice}{attention}{Attention:}
This section lists the available services and the default codes
when a \textbf{new brand} is created.
\end{notice}

\begin{notice}{hint}{Hint:}
Changing the default code in this section will only affect new
created brands.
\end{notice}


\section{Currencies}
\label{administration_portal/platform/currencies:currencies}\label{administration_portal/platform/currencies::doc}
This section allows adding as many currencies as wanted. It is a multilanguage field with a symbol that will be used
in invoices, balance movements, etc.

These IvozProvider elements have an assigned currency:
\begin{description}
\item[{Brand\index{Brand|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/currencies:term-brand}
Used as default currency for all underlying items that have currency.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/currencies:term-client}
Chosen currency will be used in price calculation, invoices, invoice's fixed costs, balance movements and
remaining money operations of this client.

\item[{Carrier\index{Carrier|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/currencies:term-carrier}
Chosen currency will be used in cost calculation, balance movements and
remaining money operations of this carrier.

\item[{Destination rate\index{Destination rate|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/currencies:term-destination-rate}
All rates within a destination rate will assume this currency.

\item[{Rating plan\index{Rating plan|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/currencies:term-rating-plan}
All destination rates grouped in a rating plan \textbf{must} use this currency.

\end{description}

It is important to take into account notes below before using this feature:
\begin{itemize}
\item {} 
Rating plans \textbf{must} only group destination rates using its currency.

\item {} 
Clients and carriers \textbf{must} only use rating plans using its currency.

\end{itemize}

\begin{notice}{note}{Note:}
Some backend checks avoid some of previous misconfigurations, but not all of them: \textbf{use this feature carefully}.
\end{notice}

\begin{notice}{important}{Important:}
\textbf{There is no currency conversion involved}: call cost will be calculated in carrier's currency, call price
will be calculated in client's currency.
\end{notice}

\begin{notice}{caution}{Caution:}
LCR routes involving carriers with different currencies are not supported.
\end{notice}


\section{Default Notification Templates}
\label{administration_portal/platform/default_notification_templates::doc}\label{administration_portal/platform/default_notification_templates:default-notification-templates}\label{administration_portal/platform/default_notification_templates:id1}
Brand administrators can configure the notifications sent by IvozProvider:
\begin{itemize}
\item {} 
Email sent when a new voicemail is received

\item {} 
Email sent when a new fax is received

\item {} 
Email sent when a balance is below configured threshold

\item {} 
Email sent when an automatic invoice is generated

\item {} 
Email sent when scheduled CDR CSVs are generated

\end{itemize}

This section allows \textbf{modifying default templates} that will be \textbf{used when no custom notification is configured}.

See {\hyperref[administration_portal/brand/settings/notification_templates:notification\string-templates]{\sphinxcrossref{\DUrole{std,std-ref}{Notification Templates}}}} for further reference.


\section{SIP domains}
\label{administration_portal/platform/sip_domains:sip-domains}\label{administration_portal/platform/sip_domains::doc}\label{administration_portal/platform/sip_domains:god-sipdomains}
The section \textbf{Domains} will display the SIP domains that points to our two
public IP addresses.
\begin{itemize}
\item {} 
Users SIP Proxy IP address

\item {} 
Trunks SIP Proxy IP address

\end{itemize}

After the initial installation, there will be two domains, one for each address:
\begin{itemize}
\item {} 
trunks.ivozprovider.local

\item {} 
users.ivozprovider.local

\end{itemize}

This domains will be used internally by a builtin DNS server included in the
solution.

\begin{notice}{attention}{Attention:}
As mentioned in the section {\hyperref[getting_started/internal_calls/brand_portal:domain\string-per\string-client]{\sphinxcrossref{\DUrole{std,std-ref}{Client SIP Domain}}}}, each
client will require a DNS pointing to the users SIP proxy. Once configured,
the domain will be displayed in this list so global administrator can check
what domains are registered for each client.
\end{notice}


\section{Platform Portals}
\label{administration_portal/platform/portals:portals}\label{administration_portal/platform/portals:platform-portals}\label{administration_portal/platform/portals::doc}
This section allows configuration of platform portals that will be used by {\hyperref[administration_portal/platform/main_operators:main\string-operators]{\sphinxcrossref{\DUrole{std,std-ref}{Main operators}}}}.

\begin{notice}{warning}{Warning:}\begin{itemize}
\item {} 
URLs MUST be HTTPS

\item {} 
URLs MUST not end with slash /

\end{itemize}
\end{notice}

Each URL can also configure a logo and a theme per URL.


\section{External calls}
\label{administration_portal/platform/external_calls:id1}\label{administration_portal/platform/external_calls::doc}\label{administration_portal/platform/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{description}
\item[{Start time\index{Start time|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-start-time}
Date and time of the call establishment.

\item[{Brand\index{Brand|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-brand}
Only visible for \emph{god}, shows the brand of each call.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-client}
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller\index{Caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-caller}
DDI presented for the outgoing call.

\item[{Callee\index{Callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-callee}
External number dialed.

\item[{Duration\index{Duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-duration}
Shows how long the call lasted.

\item[{Price\index{Price|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-price}
The money amount for the client.

\item[{Cost\index{Cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-cost}
The money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan\index{Rating Plan|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-rating-plan}
Rating plan used to set price for the call.

\item[{Destination\index{Destination|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-destination}
Destination that matched the call for billing.

\item[{Carrier\index{Carrier|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-carrier}
Shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for
each call.

\item[{Invoice\index{Invoice|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-invoice}
Shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID\index{Call ID|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-call-id}
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type\index{Endpoint Type|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-endpoint-type}
For retail client calls, shows ``RetailAccount''. Empty for remaining client types.

\item[{Endpoint Id\index{Endpoint Id|textbf}}] \leavevmode\phantomsection\label{administration_portal/platform/external_calls:term-endpoint-id}
For retail client calls, shows the retail account's id of the call. Empty for remaining client types.

\end{description}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\subsection{Call rerating}
\label{administration_portal/platform/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\section{Infrastructure}
\label{administration_portal/platform/infrastructure/index:infrastructure}\label{administration_portal/platform/infrastructure/index::doc}
Sections in this group list the components of the platform and are not meant to be modified without a deep knowledge:


\subsection{Proxy Users}
\label{administration_portal/platform/infrastructure/proxy_users:proxy-users}\label{administration_portal/platform/infrastructure/proxy_users:proxyusers}\label{administration_portal/platform/infrastructure/proxy_users::doc}
This is the SIP proxy exposed to the external world where users register their
terminals.

The value displayed in the section \textbf{Proxy users} will show the IP address
entered during the installation process.

\begin{notice}{tip}{Tip:}
All domains in \sphinxtitleref{SIP domains} section (except from trunks.ivozprovider.local) should point to this IP address.
\end{notice}


\subsection{Proxy Trunks}
\label{administration_portal/platform/infrastructure/proxy_trunks:proxy-trunks}\label{administration_portal/platform/infrastructure/proxy_trunks::doc}
This is the SIP proxy exposed to the external world in charge of connecting
the provider that brand administrators will configure for \emph{peering}.

The value displayed in the section \textbf{Proxy trunk} will show the IP address
entered during the installation process.

\begin{notice}{note}{Note:}
Only the IP address will be entered as the port will be always 5060
(5061 for SIP over TLS).
\end{notice}

\begin{notice}{danger}{Danger:}
This 2 values can be changed from the portal, but they must always
have the same IP address that proxy process listen to requests.
\end{notice}


\subsection{Media relay sets}
\label{administration_portal/platform/infrastructure/media_relay_sets::doc}\label{administration_portal/platform/infrastructure/media_relay_sets:media-relay-sets}
Media relays are in charge of bridging RTP traffic of established calls. Like
the Application Servers, they can scale horizontally as much as required.

Media relays are organized in groups so they can be assigned to a client. Each
element of the group has a \textbf{metric} that allows non-equal load balancing
within the same group (i.e. media-relay1 metric 1; media-relay2 metric 2:
the second media relay will handle two times the calls than the first one).

\begin{notice}{hint}{Hint:}
The static assignment of media relay groups is not the common practice
but allow us to assign strategic resources to clients that need a warranted
service. The most common usage of this \textbf{groups of media relays} is to
place them near the geographic area of the client (usually far from the
rest of the platform systems) in order to reduce \textbf{latencies} in their
conversations.
\end{notice}

In a standalone installation, only one media relay group will exist. By default this group only has a media server.

\begin{notice}{note}{Note:}
The address displayed is the control socket, not the SDP address that
will be included during SIP negotiation. By default this alone media-relay
will share the same IP address that the User's SIP proxy.
\end{notice}


\subsection{Application Servers}
\label{administration_portal/platform/infrastructure/application_servers::doc}\label{administration_portal/platform/infrastructure/application_servers:application-servers}
The section \textbf{Application Servers} will list the IP address where the existing
Asterisk processes will listen for request, and like previously mentioned,
can scale horizontally to adapt the platform for the required load.

Contrary to the Proxies, Asterisk is not exposed to the external world, so
for a standalone installation there will only be one listening at 127.0.0.1.

\begin{notice}{note}{Note:}
The listening port will not be displayed in the field because it will
always be 6060 (UDP).
\end{notice}

\begin{notice}{important}{Important:}
As soon as another Application Server is added, the proxies will
try to balance load using it. If no response is received from added
Application server, it will be disabled automatically.
\end{notice}


\chapter{Brand Configuration}
\label{administration_portal/brand/index::doc}\label{administration_portal/brand/index:brand-configuration}
This module will describe all the sections shown to brand operators:


\section{Clients}
\label{administration_portal/brand/clients/index:clients}\label{administration_portal/brand/clients/index::doc}
This group will show all available client types for a given (emulated/logged in) brand:


\subsection{Virtual PBX}
\label{administration_portal/brand/clients/virtual_pbx::doc}\label{administration_portal/brand/clients/virtual_pbx:virtual-pbx}
Virtual PBX clients are designed to provide service to clients with multiple terminals
that require feature-full call flows.

\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\end{notice}
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-name}
Sets the name for this client.

\item[{SIP domain\index{SIP domain|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-sip-domain}
DNS for this client. See {\hyperref[getting_started/internal_calls/brand_portal:client\string-sip\string-domain]{\sphinxcrossref{\DUrole{std,std-ref}{Client SIP Domain}}}} section.

\item[{Features\index{Features|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-features}
Allow configuration of available features for this client.
Related sections are hidden consequently and the client cannot use them.

\item[{Billing method\index{Billing method|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-billing-method}
When billing feature is enabled determines when calls will be priced. See {\hyperref[administration_portal/brand/billing/index:billing]{\sphinxcrossref{\DUrole{std,std-ref}{Billing}}}} section.

\item[{Geographic Configuration\index{Geographic Configuration|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-geographic-configuration}
General client configuration for language and timezones. Most of the settings in the section can be
configured per user if required.

\item[{Currency\index{Currency|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-currency}
Chosen currency will be used in price calculation, invoices, balance movements and
remaining money operations of this client.

\item[{Security\index{Security|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-security}
Limits the external concurrent calls and source of calls for this client.

\item[{Invoice data\index{Invoice data|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-invoice-data}
Data included in invoices created by this brand. This section also allows displaying invoices list in
client's portal menu so they can download them.

\item[{Externally rated options\index{Externally rated options|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-externally-rated-options}
For {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carriers}}}} with externally rated enabled, this field can be used to store specific
information for this client.

\item[{Notifications\index{Notifications|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-notifications}
Configure the email {\hyperref[administration_portal/brand/settings/notification_templates:notification\string-templates]{\sphinxcrossref{\DUrole{std,std-ref}{Notification Templates}}}} to use for this client.

\item[{Outgoing DDI\index{Outgoing DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-outgoing-ddi}
Selects a DDI for outgoing calls of this client, if it is no overridden in
a lower level.

\item[{Media relay set\index{Media relay set|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-media-relay-set}
As mentioned above, media-relay can be grouped in sets to reserve capacities
or on a geographical purpose. This section lets you assign them to clients.

\item[{Distribute Method\index{Distribute Method|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-distribute-method}
`Hash based' distributes calls hashing a parameter that is unique per
client, `Round robin' distributes calls equally between AS-es and
`static' is used for debugging purposes.

\item[{Application Server\index{Application Server|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-application-server}
If `static' \emph{distribute method} is used, select an application server here.

\item[{Recordings\index{Recordings|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/virtual_pbx:term-recordings}
Configures a limit for the size of recordings of this client. A
notification is sent to configured address when 80\% is reached and
older recordings are rotated when configured size is reached.

\end{description}

Most of the features are self-explanatory, but \textbf{voice notification} deserves
an explanation: if you enable them, when a call fails, the user will listen a
locution explaining what occurred (``you have no permissions to place this call'',
``the call cannot be billed'', etc.)

\begin{notice}{warning}{Warning:}
Recordings rotation happens at two levels: brand and client. This
means that \textbf{a client's recordings can be rotated even though its limit
has not arrived (or even it has no limit) if brand's limit applies first}.
\end{notice}

\begin{notice}{error}{Error:}
Again: recordings rotation happens at two levels: brand and client. This
means that \textbf{a client's recordings can be rotated even though its limit
has not arrived (or even it has no limit) if brand's limit applies first}.
\end{notice}

\begin{notice}{hint}{Hint:}
To avoid this, make sure that the sum of all clients does not exceed
the size assigned to your brand and make sure that all clients has
a size configured (if 0, it has unlimited size).
\end{notice}

Both \textbf{Distribute method} and \textbf{Application Server} are only visible for God
Administrator.

\begin{notice}{warning}{Warning:}
`Round-robin' distribute method is reserved for huge clients
whose calls cannot be handled in a single AS. \textbf{Use `Hash based'
for remaining ones}, as `Round-robin' imposes some limitations
to client features (no queues, no conferences).
\end{notice}


\subsection{Residential}
\label{administration_portal/brand/clients/residential:residential}\label{administration_portal/brand/clients/residential::doc}
Residential clients are a more lightweight client type than \emph{vPBX clients}.

Their target is to provide these services to residential environments:
\begin{itemize}
\item {} 
Configure one or more residential devices (SIP devices).

\item {} 
Setup one or more DDIs.

\item {} 
\textbf{Place external calls} showing one of those DDIs.

\item {} 
\textbf{Receive external calls} to their DDIs.

\item {} 
Send/Receive virtual faxes.

\item {} 
Record calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No users, no extensions, no internal calls, no hunt groups, no IVRs... just \textbf{incoming and outgoing external
calls (and a few voice services)}.
\end{notice}

\begin{notice}{error}{Error:}
Residential clients and their devices \textbf{MUST use Brand's SIP domain in their SIP messages}.
\end{notice}


\subsubsection{Adding/Editing residential clients}
\label{administration_portal/brand/clients/residential:adding-editing-residential-clients}
\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\end{notice}

These are the fields shown when \textbf{adding} a new residential client:
\begin{description}
\item[{Billing method\index{Billing method|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-billing-method}
To choose among postpaid, prepaid and pseudo-prepaid.

\item[{Country code\index{Country code|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-country-code}
Default country code for DDIs.

\item[{Currency\index{Currency|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-currency}
Chosen currency will be used in price calculation, invoices, balance movements and
remaining money operations of this client.

\item[{Default timezone\index{Default timezone|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-default-timezone}
Used for showing call registries dates.

\item[{Features\index{Features|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-features}
Enable/Disable faxing and call recording for this particular client.

\item[{Filter by IP address\index{Filter by IP address|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-filter-by-ip-address}
If set, the platform will only allow calls coming from allowed IP addresses or network ranges.

\item[{Language\index{Language|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-language}
Used to choose the language of played locutions.

\item[{Max calls\index{Max calls|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-max-calls}
Limits both client generated and external received calls to this value (0 for unlimited). Setting to 2 will allow
setting 2 outgoing calls and received 2 incoming calls (in parallel).

\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-name}
Used to reference this particular client.

\item[{Numeric transformation\index{Numeric transformation|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-numeric-transformation}
Describes the way the client will ``talk'' and the way the client wants to be ``talked''.

\end{description}

When \textbf{editing} a client, these additional fields can be configured:
\begin{description}
\item[{Externally rater custom options\index{Externally rater custom options|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-externally-rater-custom-options}
This field is for setting options for an optional external rating module.

\item[{Invoice data\index{Invoice data|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-invoice-data}
All the fields in this group will be included in invoices generated for this client. This section also allows
displaying invoices list in client's portal menu so they can download them.

\item[{Notification options\index{Notification options|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-notification-options}
This group allows choosing a notification template for both faxes and voicemail notifications.

\item[{Outgoing DDI\index{Outgoing DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-outgoing-ddi}
Fallback DDI for external outgoing calls (can be overridden at residential device level).

\item[{Recordings\index{Recordings|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/residential:term-recordings}
This group allows choosing an on-demand method or disabling this feature and the code used to enable it on call.

\end{description}

\begin{notice}{note}{Note:}
Apart from these fields, main operator (\emph{aka} God) will also see a \textbf{Platform data} group that allows:
\begin{itemize}
\item {} 
Choosing an specific media relay set for the client.

\item {} 
Choose the way that calls of this client will be distributed among existing application servers (\textbf{hash based} is recommended).

\end{itemize}
\end{notice}

\begin{notice}{tip}{Tip:}
For outgoing calls, platform will use the CLID provided by the client as long as it is considered valid, otherwise fallback DDI
will be used. The platform will consider as valid any CLID that matches one of the client's DDIs.
\end{notice}


\subsubsection{Additional subsections}
\label{administration_portal/brand/clients/residential:additional-subsections}
Each entry in this table has these additional options:
\begin{itemize}
\item {} 
\textbf{List of authorized sources}: if \emph{Filter by IP address} is enabled, this subsection allows adding addresses or network ranges.

\end{itemize}

\begin{notice}{error}{Error:}
No outgoing call will be allowed if \emph{Filter by IP address} is enabled and the corresponding list is empty.
\end{notice}
\begin{itemize}
\item {} 
\textbf{List of client admins}: this subsection allows managing portal credentials for this specific client.

\item {} 
\textbf{List of rating profiles}: this subsection allows managing the rating profiles that will be used to bill its outgoing calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No outgoing call will be allowed for this client unless an active rating profiles that can
bill the specific call.
\end{notice}
\begin{itemize}
\item {} 
\textbf{List of Outgoing routes}: this subsections shows routing rules that apply only for this client.

\end{itemize}

\begin{notice}{tip}{Tip:}
As \emph{Apply all clients} routing rules also will apply for this client, the recommended way to manage routes is
using \textbf{Outgoing routings} section instead.
\end{notice}


\subsection{Retail}
\label{administration_portal/brand/clients/retail:retail-clients}\label{administration_portal/brand/clients/retail:retail}\label{administration_portal/brand/clients/retail::doc}
Retail clients are even a more lightweight client type than \emph{Residential clients}.

They just provide a SIP trunking service that include these features:
\begin{itemize}
\item {} 
Configure one or more retail accounts (SIP devices).

\item {} 
Setup one or more DDIs.

\item {} 
\textbf{Place external calls} showing one of those DDIs.

\item {} 
\textbf{Receive external calls} to their DDIs.

\item {} 
Record calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No users, no extensions, no internal calls, no hunt groups, no IVRs, no voicemail...
just \textbf{incoming and outgoing external calls}.
\end{notice}

\begin{notice}{error}{Error:}
Retail clients and their accounts \textbf{MUST use Brand's SIP domain in their SIP messages}.
\end{notice}


\subsubsection{Differences between retail and residential clients}
\label{administration_portal/brand/clients/retail:differences-between-retail-and-residential-clients}
There is an important key difference between these two clients: \textbf{retail client calls do not traverse
any application server}.

As a result:
\begin{itemize}
\item {} 
No virtual faxing service for retail clients.

\item {} 
No voicemail service for retail clients.

\end{itemize}

But they also have benefits that make them ideal for some situations:
\begin{itemize}
\item {} 
No application server traverse, much less load for the platform.

\item {} 
Call transcoding as a feature.

\item {} 
Routing tags for different call routing for same destinations.

\end{itemize}

\begin{notice}{warning}{Warning:}
Residential devices are force to talk the codec selected in their configuration (just one).
Retail clients, on the other hand, can talk in the codecs they offer in their SDP and in the
codecs selected in IvozProvider: IvozProvider will make transcoding when necessary.
\end{notice}

\begin{notice}{tip}{Tip:}
Use retail client type unless you need any of the services provided by application servers (fax or voicemails).
\end{notice}


\subsubsection{Adding/Editing retail clients}
\label{administration_portal/brand/clients/retail:adding-editing-retail-clients}
\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\end{notice}

These are the fields shown when \textbf{adding} a new retail client:
\begin{description}
\item[{Billing method\index{Billing method|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-billing-method}
To choose among postpaid, prepaid and pseudo-prepaid.

\item[{Country code\index{Country code|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-country-code}
Default country code for DDIs.

\item[{Currency\index{Currency|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-currency}
Chosen currency will be used in price calculation, invoices, balance movements and
remaining money operations of this client.

\item[{Default timezone\index{Default timezone|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-default-timezone}
Used for showing call registries dates.

\item[{Filter by IP address\index{Filter by IP address|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-filter-by-ip-address}
If set, the platform will only allow calls coming from allowed IP addresses or network ranges.

\item[{Language\index{Language|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-language}
Used to choose the language of played locutions.

\item[{Max calls\index{Max calls|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-max-calls}
Limits both client generated and external received calls to this value (0 for unlimited). Setting to 2 will allow
setting 2 outgoing calls and received 2 incoming calls (in parallel).

\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-name}
Used to reference this particular client.

\item[{Numeric transformation\index{Numeric transformation|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-numeric-transformation}
Describes the way the client will ``talk'' and the way the client wants to be ``talked''.

\end{description}

When \textbf{editing} a client, these additional fields can be configured:
\begin{description}
\item[{Audio transcoding\index{Audio transcoding|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-audio-transcoding}
This field allows enabling codecs for this specific client. This codecs will be added to
the ones offered by the client in its SDP.

\item[{Externally rater custom options\index{Externally rater custom options|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-externally-rater-custom-options}
This field is for setting options for an optional external rating module.

\item[{Invoice data\index{Invoice data|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-invoice-data}
All the fields in this group will be included in invoices generated for this client. This section also allows
displaying invoices list in client's portal menu so they can download them.

\item[{Outgoing DDI\index{Outgoing DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-outgoing-ddi}
Fallback DDI for external outgoing calls (can be overridden at residential device level).

\item[{Routing tags\index{Routing tags|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/retail:term-routing-tags}
This field allows enabling routing tags for this specific client. Call preceded with this
routing tags will be rated and routed differently.

\end{description}

\begin{notice}{note}{Note:}
Apart from these fields, main operator (\emph{aka} God) will also see a \textbf{Platform data} group that allows:
\begin{itemize}
\item {} 
Choosing an specific media relay set for the client.

\end{itemize}
\end{notice}

\begin{notice}{tip}{Tip:}
For outgoing calls, platform will use the CLID provided by the client as long as it is considered valid, otherwise fallback DDI
will be used. The platform will consider as valid any CLID that matches one of the client's DDIs.
\end{notice}


\subsubsection{Additional subsections}
\label{administration_portal/brand/clients/retail:additional-subsections}
Each entry in this table has these additional options:
\begin{itemize}
\item {} 
\textbf{List of authorized sources}: if \emph{Filter by IP address} is enabled, this subsection allows adding addresses or network ranges.

\end{itemize}

\begin{notice}{error}{Error:}
No outgoing call will be allowed if \emph{Filter by IP address} is enabled and the corresponding list is empty.
\end{notice}
\begin{itemize}
\item {} 
\textbf{List of client admins}: this subsection allows managing portal credentials for this specific client.

\item {} 
\textbf{List of Rating profiles}: this subsection allows managing the rating profiles that will be used to bill its outgoing calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No outgoing call will be allowed for this client unless an active rating profiles that can
bill the specific call.
\end{notice}
\begin{itemize}
\item {} 
\textbf{List of Outgoing routes}: this subsections shows routing rules that apply only for this client.

\end{itemize}

\begin{notice}{tip}{Tip:}
As \emph{Apply all clients} routing rules also will apply for this client, the recommended way to manage routes is
using \textbf{Outgoing routings} section instead.
\end{notice}


\subsection{Wholesale}
\label{administration_portal/brand/clients/wholesale:wholesale}\label{administration_portal/brand/clients/wholesale:wholesale-clients}\label{administration_portal/brand/clients/wholesale::doc}
Wholesale clients are the simplest client type in IvozProvider.

It allows trunking services with Carriers without any application server features,
focusing on concurrency and quality rather on having lots of services.
\begin{itemize}
\item {} 
Just make outgoing calls.

\item {} 
IP authentication only (no register, no SIP auth).

\item {} 
Calls go directly from users to trunks, without any application server involved.

\item {} 
Support for routing tags (client can choose the outgoing route to use)

\item {} 
Support for audio transcoding.

\end{itemize}

\begin{notice}{warning}{Warning:}
No users, no extensions, no internal calls, no DDIs, no voicemail, no call forwards...
just \textbf{outgoing external calls}.
\end{notice}

\begin{notice}{error}{Error:}
Wholesale clients \textbf{do not need to use Brand's SIP domain in their SIP messages}.
\end{notice}


\subsubsection{Adding/Editing clients}
\label{administration_portal/brand/clients/wholesale:adding-editing-clients}
\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\end{notice}

These are the fields shown when \textbf{adding} a new wholesale client:
\begin{description}
\item[{Billing method\index{Billing method|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-billing-method}
To choose among postpaid, prepaid and pseudo-prepaid.

\item[{Currency\index{Currency|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-currency}
Chosen currency will be used in price calculation, invoices, balance movements and
remaining money operations of this client.

\item[{Default timezone\index{Default timezone|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-default-timezone}
Used for showing call registries dates.

\item[{Language\index{Language|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-language}
Used to choose the language of played locutions.

\item[{Max calls\index{Max calls|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-max-calls}
Limits both client generated and external received calls to this value (0 for unlimited). Setting to 2 will allow
setting 2 outgoing calls and received 2 incoming calls (in parallel).

\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-name}
Used to reference this particular client.

\item[{Numeric transformation\index{Numeric transformation|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-numeric-transformation}
Describes the way the client will ``talk'' and the way the client wants to be ``talked''.

\end{description}

When \textbf{editing} a client, these additional fields can be configured:
\begin{description}
\item[{Audio transcoding\index{Audio transcoding|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-audio-transcoding}
This field allows enabling codecs for this specific client. This codecs will be added to
the ones offered by the client in its SDP.

\item[{Externally rater custom options\index{Externally rater custom options|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-externally-rater-custom-options}
This field is for setting options for an optional external rating module.

\item[{Invoice data\index{Invoice data|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-invoice-data}
All the fields in this group will be included in invoices generated for this client. This section also allows
displaying invoices list in client's portal menu so they can download them.

\item[{Routing tags\index{Routing tags|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/clients/wholesale:term-routing-tags}
This field allows enabling routing tags for this specific client. Call preceded with this
routing tags will be rated and routed differently.

\end{description}

\begin{notice}{note}{Note:}
Apart from these fields, main operator (\emph{aka} God) will also see a \textbf{Platform data} group that allows:
\begin{itemize}
\item {} 
Choosing an specific media relay set for the client.

\end{itemize}
\end{notice}


\subsubsection{Additional subsections}
\label{administration_portal/brand/clients/wholesale:additional-subsections}
Each entry in this table has these additional options:
\begin{itemize}
\item {} 
\textbf{List of authorized sources}: client identification will be made looking up the source IP address in this table.

\item {} 
\textbf{List of client admins}: this subsection allows managing portal credentials for this specific client.

\item {} 
\textbf{List of rating profiles}: this subsection allows managing the rating profiles that will be used to bill its outgoing calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No outgoing call will be allowed for this client unless an active rating profiles that can
bill the specific call.
\end{notice}
\begin{itemize}
\item {} 
\textbf{List of Outgoing routes}: this subsections shows routing rules that apply only for this client.

\end{itemize}

\begin{notice}{tip}{Tip:}
As \emph{Apply all clients} routing rules also will apply for this client, the recommended way to manage routes is
using \textbf{Outgoing routings} section instead.
\end{notice}

\begin{notice}{tip}{Tip:}
Available client types can be configured through \emph{Brand Features}.
\end{notice}


\section{Providers}
\label{administration_portal/brand/providers/index::doc}\label{administration_portal/brand/providers/index:providers}
Brand operator must reach agreements with VoIP providers to place calls of its clients and to receive calls to the
DDIs of its clients.

Depending the call direction, they can be divided into:


\subsection{Carriers}
\label{administration_portal/brand/providers/carriers:id1}\label{administration_portal/brand/providers/carriers::doc}\label{administration_portal/brand/providers/carriers:carriers}
Carriers are used to place external outgoing calls.

This are the fields that define a carrier:

\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\end{notice}
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-name}
Used to reference this Carrier.

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-description}
Optional field with any required extra information.

\item[{Numeric Transformation\index{Numeric Transformation|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-numeric-transformation}
Transformation that will be applied to the origin and destination of the
outgoing numbers that use this Carrier
(see {\hyperref[administration_portal/brand/settings/numeric_transformations:numeric\string-transformations]{\sphinxcrossref{\DUrole{std,std-ref}{Numeric transformations}}}}).

\item[{Externally rated\index{Externally rated|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-externally-rated}
This setting requires the external tarification module and allows
tarification on special numbers. This module is not standard so don't
hesitate in {\hyperref[basic_concepts/intro/getting_help:getting\string-help]{\sphinxcrossref{\DUrole{std,std-ref}{contact us}}}} if you are interested.

\item[{Calculate cost\index{Calculate cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-calculate-cost}
If set, IvozProvider will calculate the cost of the call using the carrier's active rating profile.

\item[{Currency\index{Currency|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-currency}
Chosen currency will be used in cost calculation, balance movements and
remaining money operations of this carrier.

\end{description}


\subsubsection{Carrier Servers}
\label{administration_portal/brand/providers/carriers:carrier-servers}
A \textbf{Carrier Server} is a SIP server associated to an IP Provider. Carrier servers
are used for placing outgoing calls by using {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}}.
\begin{description}
\item[{SIP Proxy\index{SIP Proxy|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-sip-proxy}
IP address (or DNS registry) of the Carrier Server. You can also specify
a port if it's different from 5060.

\item[{Outbound Proxy\index{Outbound Proxy|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-outbound-proxy}
Usually this is left empty. It can be filled with the IP address of the
\textbf{SIP Proxy} domain (to avoid DNS resolution, but keeping the domain
in the SIP messages). It works like a web proxy: instead of sending the
SIP messages to destination \textbf{SIP Proxy}, they will be sent to the
IP:PORT of this field.

\item[{URI Scheme\index{URI Scheme|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-uri-scheme}
Supported schemes are sip and sips. Use `sip' in case of doubt.

\item[{Transport\index{Transport|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-transport}
Supported transport protocols. Use `udp' in case of doubt.

\item[{Requires Authentication\index{Requires Authentication|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-requires-authentication}
Some Carriers validate our platform by IP, others require
each session that we want to establish. For this last case, this section
allows to configure user and password for this authentication.

\item[{Call Origin Header\index{Call Origin Header|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-call-origin-header}
Some Providers get origin from SIP From header. Others use the From
header for accounting and need extra headers to identify the origin.
In case of doubt leave \textbf{PAI} checked.

\item[{From header customization\index{From header customization|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/carriers:term-from-header-customization}
For those providers that show origin in other headers (PAI/RPID), it is
possible that request that From User have the account code being used
and from domain their SIP domain. In case of doubt, leave empty.

\end{description}

\begin{notice}{tip}{Tip:}
There are many fields to establish \emph{peering} with multiple kind of
carriers, but usually with the name and SIP Proxy will be enough (for
those that validate our platform by IP) and Authentication (for those that
won't).
\end{notice}

\begin{notice}{warning}{Warning:}
In case of defining multiple Carrier Servers for a single
Carrier, IvozProvider will balance and failover using all of them.
Like with Application Servers, it will disable those who doesn't respond to
our requests.
\end{notice}


\subsection{DDI Providers}
\label{administration_portal/brand/providers/ddi_providers:ddi-providers}\label{administration_portal/brand/providers/ddi_providers::doc}
DDI Providers are the SIP entities that will contact the platform when someone calls to one of our client's DDIs.

This are the fields that define a carrier:

\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\end{notice}
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-name}
Used to reference this Carrier.

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-description}
Optional field with any required extra information.

\item[{Numeric Transformation\index{Numeric Transformation|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-numeric-transformation}
Transformation that will be applied to the origin and destination of the
outgoing numbers that use this Carrier
(see {\hyperref[administration_portal/brand/settings/numeric_transformations:numeric\string-transformations]{\sphinxcrossref{\DUrole{std,std-ref}{Numeric transformations}}}}).

\end{description}


\subsubsection{DDI Provider Addresses}
\label{administration_portal/brand/providers/ddi_providers:ddi-provider-addresses}
The platform will recognize a DDI provider comparing SIP message's source address with the addresses in this list:
\begin{description}
\item[{IP address\index{IP address|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-ip-address}
Used to reference this Carrier.

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-4}
Optional field with any required extra information.

\end{description}

\begin{notice}{tip}{Tip:}
Once the DDI provider is recognized, its numeric transformations will be applied and the DDI will be searched.
\end{notice}


\subsubsection{DDI Provider Registrations}
\label{administration_portal/brand/providers/ddi_providers:ddi-provider-registrations}
Some DDI providers require a \href{https://tools.ietf.org/html/rfc3261\#section-10}{SIP Register} active in order to receive
incoming calls to our DDIs. Some of them, even require this register in order
to process our outgoing calls through their services.

\begin{notice}{note}{Note:}
IvozProvider supports any kind of \emph{peering}, but we highly recommend
\emph{peer to peer peerings}: without authentication, without registry and
validated by IP. This will avoid unnecessary traffic (authentication in each
session and periodic registers) and simplifies its configuration, leaving this list empty.
\end{notice}

To define a registration, these fields are shown:
\begin{description}
\item[{Username\index{Username|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-username}
Account number or similar provider by the provider that requires SIP
register.

\item[{Domain\index{Domain|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-domain}
Domain or IP of the registrar server. Usually the same as the SIP proxy
of the Peer server.

\item[{Password\index{Password|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-password}
Password used in auth process.

\item[{Random contact Username\index{Random contact Username|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-random-contact-username}
If set, no contact username will be needed as a random string will be used. The
DDI Provider is supposed to use the called DDI in the R-URI instead of this random string.

\item[{Contact username\index{Contact username|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-contact-username}
This will be used in REGISTER message Contact header, making DDI provider to
contact us with this in the R-URI.

\item[{Auth username\index{Auth username|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-auth-username}
Authentication user. Most of the time it's the same as username, so
it's recommended to leave empty.

\item[{Register server URI\index{Register server URI|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-register-server-uri}
Usually this can be left empty, as it can be obtained from the
Domain. If it is not the case, enter the IP address with the `sip:'
prefix.

\item[{Realm\index{Realm|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-realm}
Leave empty to accept the authentication realm proposed by the provider.
Define only if you are familiar to the authentication mechanism used
in SIP.

\item[{Expire\index{Expire|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/providers/ddi_providers:term-expire}
Default suggested register expire time.

\end{description}

\begin{notice}{tip}{Tip:}
Similar to the Carrier Servers, there are lots of fields in the screen.
You must have into account that most of the providers don't require register,
and those who do, will only use user, domain and password.
\end{notice}


\section{Routing}
\label{administration_portal/brand/routing/index::doc}\label{administration_portal/brand/routing/index:routing}
Routing is the process in which a carrier is chosen to place an external outgoing call.

All these concepts are taken into account:


\subsection{Outgoing Routings}
\label{administration_portal/brand/routing/outgoing_routings:routes-metrics}\label{administration_portal/brand/routing/outgoing_routings::doc}\label{administration_portal/brand/routing/outgoing_routings:outgoing-routings}
This is the main section in which routing policies are defined.

These are the fields that define an outgoing routing rule:
\begin{description}
\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/routing/outgoing_routings:term-client}
Should this rule apply to all clients or just to one specific client?

\item[{Routing Tag\index{Routing Tag|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/routing/outgoing_routings:term-routing-tag}
Routing tags allow clients to call to the same destination through different carriers. This field makes the
rule valid for just one routing tag (or for none).

\item[{Call destination\index{Call destination|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/routing/outgoing_routings:term-call-destination}
This groups allows selecting if this rule applies for just one destination pattern, for a group or for faxes.

\item[{Route type\index{Route type|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/routing/outgoing_routings:term-route-type}
There are two kind of rules: static and LCR. In static, only one carrier is selected. In LCR, multiple carriers
may be selected.

\item[{Priority\index{Priority|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/routing/outgoing_routings:term-priority}
If a call matches several routes, it will be placed using the outgoing
route with lower priority, as long as it is available.

\item[{Metric\index{Metric|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/routing/outgoing_routings:term-metric}
If a call matches several routes with equal priority, metric will determine
the proportion of calls that will use one route or another.

\end{description}

\begin{notice}{error}{Error:}
\textbf{All clients rules apply to all clients}, even if they have specific matching rules. Matching specific rules and
global rules are merged when selecting a carrier for a given client.
\end{notice}

\begin{notice}{tip}{Tip:}
If you want to achieve ``Fallback for all clients'' rules, make sure you use high priority values.
\end{notice}

\begin{notice}{warning}{Warning:}
When placing a call to a given destination, rules with that pattern will be merged with rules of groups that contain that pattern.
\end{notice}

\begin{notice}{note}{Note:}
In all this rule merging process, priority and metric determine the order.
\end{notice}

\begin{notice}{note}{Note:}
Fax specific routes will apply first for both faxes sent via virtual faxing (see {\hyperref[administration_portal/client/vpbx/faxes:faxes]{\sphinxcrossref{\DUrole{std,std-ref}{Faxes}}}}) or T.38 capable devices. If no fax
specific route found, remaining routes will apply as for a normal voice call to that destination.
\end{notice}

Last two fields, priority and order, are key parameters to achieve two interesting features too: \textbf{load-balancing} and \textbf{failover-routes}.


\subsubsection{Load balancing}
\label{administration_portal/brand/routing/outgoing_routings:load-balancing}
\emph{Load-balancing} lets us distribute calls matching the same pattern using
several valid outgoing routes.
\paragraph{Example 1}
\begin{itemize}
\item {} 
Route A: priority 1, metric 1

\item {} 
Route B: priority 1, metric 1

\end{itemize}

Call matching these routes will use route A for \%50 of the calls and route B for
\%50 of the calls.
\paragraph{Example 2}
\begin{itemize}
\item {} 
Route A: priority 1, metric 1

\item {} 
Route B: priority 1, metric 2

\end{itemize}

Call matching these routes will use route A for \%33 of the calls and route B for
\%66 of the calls.


\subsubsection{Failover routes}
\label{administration_portal/brand/routing/outgoing_routings:failover-routes}
Failover route lets us use another route whenever the main route fails.
\paragraph{Example}
\begin{itemize}
\item {} 
Route A: priority 1, metric 1

\item {} 
Route B: priority 2, metric 1

\end{itemize}

All calls matching these routes will try to use route A. In case the call fails,
the call will be placed using route B.

\begin{notice}{tip}{Tip:}
Although given examples use two routes, more routes can be chained and
failover and load-balancing strategies can be combined.
\end{notice}


\subsubsection{LCR routes}
\label{administration_portal/brand/routing/outgoing_routings:lcr-routes}
LCR (\emph{Least Cost Routing}) routes may select more than one carrier. Whenever a LCR rule is used, the platform will compute the call cost for that
given destination (for a 5 minutes duration) and will order them in increasing order.

\begin{notice}{note}{Note:}
Carriers that cannot compute cost for a given destination are silently ignored (they are not used).
\end{notice}


\subsubsection{LCR and static rules combined}
\label{administration_portal/brand/routing/outgoing_routings:lcr-and-static-rules-combined}
Carrier election process can combine static and LCR rules:
\begin{enumerate}
\item {} 
Static rules result in one carrier with the priority and the weight of the rule.

\item {} 
LCR rules result in \emph{n} carriers, ordered by call cost, all of them with the priority and the weight of the rule.

\item {} 
Carriers are ordered using priority (ascending order).

\item {} 
Carrier's weight is used for load-balancing between carriers with same priority.

\end{enumerate}


\subsection{Routing patterns}
\label{administration_portal/brand/routing/routing_patterns::doc}\label{administration_portal/brand/routing/routing_patterns:routing-patterns}\label{administration_portal/brand/routing/routing_patterns:id1}
When a user dials an external phone number, IvozProvider tries to categorize
this call into one of the routing patterns defined in this section. Once categorized,
the pattern will be used in routing process described in {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}}.

Usually, it will we useful to have one routing pattern for the countries
defined in the \href{https://en.wikipedia.org/wiki/ISO\_3166}{ISO 3166}. That's why IvozProvider automatically
includes all this countries and their prefixes.

\begin{notice}{tip}{Tip:}
Brand operator can choose between keeping this routing pattern if
finds them useful or deleting them an creating the ones that meet his needs.
\end{notice}


\subsection{Routing pattern groups}
\label{administration_portal/brand/routing/routing_patterns_groups::doc}\label{administration_portal/brand/routing/routing_patterns_groups:routing-pattern-groups}
As we will see in {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}} section, every routing
pattern will be linked to a Carrier.

That's why it can be useful to group the {\hyperref[administration_portal/brand/routing/routing_patterns:routing\string-patterns]{\sphinxcrossref{\DUrole{std,std-ref}{Routing patterns}}}} in \textbf{routing pattern groups}
so that we can use a whole group in a routing rule.

By default we can see the countries grouped in the continents defined in
\href{https://en.wikipedia.org/wiki/ISO\_3166}{ISO 3166}.

\begin{notice}{tip}{Tip:}
Brand operator can choose between keeping this routing pattern groups if
finds them useful or deleting them an creating the ones that meet his needs.
\end{notice}


\subsection{Routing tags}
\label{administration_portal/brand/routing/routing_tags:routing-tags}\label{administration_portal/brand/routing/routing_tags::doc}
In most scenarios, Brands administrators are responsible for configuring
{\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carriers}}}} and {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}} to provide connectivity for
their clients. But in some cases, clients want to choose the outgoing routing to
use per call.

A Routing tag is \textbf{a code that will prefix the destination number when placing calls to IvozProvider} and allow clients
to choose different routes for same destinations.


\subsubsection{Add/Edit/Delete a routing tag}
\label{administration_portal/brand/routing/routing_tags:add-edit-delete-a-routing-tag}
Routing tag definition only implies these two fields:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/routing/routing_tags:term-name}
Name used for referencing (e.g. ``Premium'')

\item[{Tag\index{Tag|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/routing/routing_tags:term-tag}
Prefix itself

\end{description}


\subsubsection{Using routing tags}
\label{administration_portal/brand/routing/routing_tags:using-routing-tags}
Once created, routing tags can be used in three different sections:
\begin{itemize}
\item {} 
In \textbf{client edit screen}, to allow a client to use a routing tag.

\end{itemize}

\begin{notice}{error}{Error:}
Using a non enabled routing tag will cause the call to be declined.
\end{notice}
\begin{itemize}
\item {} 
In \textbf{Outgoing routings} to modify the way those calls are routed.

\item {} 
In \textbf{client - rating profiles association}, so that different routes imply different billing.

\end{itemize}

\begin{notice}{important}{Important:}
Route tags are only available to wholesale and retail clients at the moment.
\end{notice}


\section{Billing}
\label{administration_portal/brand/billing/index::doc}\label{administration_portal/brand/billing/index:billing}
Billing a call is the \textbf{action of setting a price} to a call that implies cost.

Billing calls depends upon an automatic process:
\begin{itemize}
\item {} 
When a call is about to be established, IvozProvider verifies that it will be able to bill it.

\end{itemize}

\begin{notice}{error}{Error:}
If with the current configuration (active and applicable rating plans for
a given client and for the specific destination) it won't be possible to
bill the call, IvozProvider will prevent its establishment.
\end{notice}
\begin{itemize}
\item {} 
Once a call that implies cost is hung up and is parsed by an asynchronous process, it is listed in {\hyperref[administration_portal/platform/external_calls:external\string-calls]{\sphinxcrossref{\DUrole{std,std-ref}{External calls}}}}.

\end{itemize}


\subsection{Billing methods}
\label{administration_portal/brand/billing/index:billing-methods}
IvozProvider supports 3 different billing methods. Billing method is configured at client level via \emph{Billing method} parameter.


\subsubsection{Postpaid billing}
\label{administration_portal/brand/billing/index:postpaid-billing}\begin{itemize}
\item {} 
Call rating is done after the call ends.

\item {} 
No configurable limit or balances involved.

\end{itemize}


\subsubsection{Prepaid billing}
\label{administration_portal/brand/billing/index:prepaid-billing}\begin{itemize}
\item {} 
Call rating is done during the call.

\item {} 
Clients with prepaid billing method have a preconfigured balance that will be decrement during the call.

\item {} 
When the balance reaches zero, all established calls for the client will hang up.

\item {} 
Clients cannot place new calls with zero or negative balance.

\item {} 
Low balance email notifications can be configured.

\end{itemize}


\subsubsection{Pseudo-prepaid billing}
\label{administration_portal/brand/billing/index:pseudo-prepaid-billing}\begin{itemize}
\item {} 
Call rating is done after the call ends.

\item {} 
Clients with pseudo-prepaid billing method have a preconfigured balance that will be decrement after the call ends.

\item {} 
Clients cannot place new calls with zero or below balance.

\item {} 
Low balance email notifications can be configured.

\end{itemize}

\begin{notice}{warning}{Warning:}
Call duration is limited to the maximum duration possible with available balance at the moment of call establishment.
\end{notice}


\subsection{Price and cost}
\label{administration_portal/brand/billing/index:price-and-cost}\begin{itemize}
\item {} 
Call \textbf{price} is the amount of money the brand operator will charge to its \textbf{client} for every call.

\item {} 
Call \textbf{cost} is the amount of money the brand operator will be charged by the \textbf{carrier} for every call.

\end{itemize}

\textbf{Call cost calculation is optional}, as no every carrier has \emph{Calculate Cost?} setting enabled. On the other hand, \textbf{call
price calculation is mandatory} for every outgoing call.

\begin{notice}{note}{Note:}
Carrier call cost calculation, if enabled, is always done postpaid. Carriers with negative balance are allowed and
no call will be hung up when carrier balance reaches 0.
\end{notice}


\subsection{Concepts}
\label{administration_portal/brand/billing/index:concepts}
This topic will cover every topic involved in the billing process:


\subsubsection{Rating plans}
\label{administration_portal/brand/billing/rating_plans:rating-plans}\label{administration_portal/brand/billing/rating_plans::doc}
Rating plans describe how calls are rated for different destinations at different times of the day.


\paragraph{Rating plan definition}
\label{administration_portal/brand/billing/rating_plans:rating-plan-definition}
{\hyperref[administration_portal/brand/billing/destination_rates:destination\string-rates]{\sphinxcrossref{\DUrole{std,std-ref}{Destination Rates}}}} are grouped using Rating plans. This offers the possibility to have base pricing data and customize
some destinations with different prices at different times of the day.

This are the fields that define a Rating plan:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/rating_plans:term-name}
Name that will be use to reference this rating plan.

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/rating_plans:term-description}
A field to enter additional information. Not used anywhere.

\item[{Currency\index{Currency|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/rating_plans:term-currency}
All destination rates grouped must use this currency.

\end{description}

\begin{notice}{tip}{Tip:}
Rating plan names appear on final clients' invoices, choose something with commercial sense.
\end{notice}


\paragraph{Adding Destination rates to Rating Plan}
\label{administration_portal/brand/billing/rating_plans:adding-destination-rates-to-rating-plan}
Rating plans group several {\hyperref[administration_portal/brand/billing/destination_rates:destination\string-rates]{\sphinxcrossref{\DUrole{std,std-ref}{Destination Rates}}}} to allow flexible configuration that rate destinations differently
at different times of the day (\textbf{List of destination rates} subsection).
\begin{description}
\item[{Destination rate\index{Destination rate|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/rating_plans:term-destination-rate}
Adds selected destination rate to rating plan

\item[{Weight\index{Weight|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/rating_plans:term-weight}
If a given call can be billed with more than one destination rate within the rating plan,
it will be billed using the one with highest weight.

\item[{Timing type\index{Timing type|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/rating_plans:term-timing-type}
Should this association apply always or just at given times of the week?

\end{description}

\begin{notice}{tip}{Tip:}
Weight allows having a general \emph{Destination rate} and concrete the price of
an specific destination in another \emph{destination rate} with higher weight (free cell
phone calls, for example).
\end{notice}

\begin{notice}{warning}{Warning:}
A rating plan MUST be capable of rating calls 24x7. Adding the timings of all destination rates in a rating
plan MUST cover every moment of the week.
\end{notice}
\paragraph{Checking Rating plans}

To check the configuration so far we can \textbf{Simulate a call} from the rating plans list.

We introduce the destination number in {\hyperref[administration_portal/brand/settings/numeric_transformations:e164]{\sphinxcrossref{\DUrole{std,std-ref}{E.164 format}}}}, and we can check the price every rating plan on the
list will charge for that call.


\paragraph{Assigning rating plans to clients}
\label{administration_portal/brand/billing/rating_plans:assigning-rating-plans-to-clients}
An specific \textbf{rating plan} can be linked to multiple clients.

In the section \textbf{Brand configuration} \textgreater{} \textbf{Virtual PBXs} (\textbf{Residential}, \textbf{Retail} and \textbf{Wholesale}) we select
\textbf{List of Rating Plans} subsection.

\begin{notice}{note}{Note:}
Every \textbf{Rating plan} has an activation time and only one can be active for each
client at an specific moment (the one whose activation time is nearer in the past).
\end{notice}
\paragraph{Simulating a call of a specific client}

In this list we can also simulate a call for a given client like we did previously
in the rating plan list and check the price it will imply. This way, we can be sure
that the configuration is ok.


\subsubsection{Destination Rates}
\label{administration_portal/brand/billing/destination_rates:destination-rates}\label{administration_portal/brand/billing/destination_rates::doc}\label{administration_portal/brand/billing/destination_rates:destination-rate}
A \emph{Destination rate} groups some prefixes with their cost details.

They only have two fields:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/destination_rates:term-name}
Name to reference the destination rate

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/destination_rates:term-description}
Additional details

\item[{Currency\index{Currency|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/destination_rates:term-currency}
All rates imported/added will use this currency

\end{description}

\begin{notice}{tip}{Tip:}
Destination rate names are not shown to the final client, you can use whatever makes sense to you.
\end{notice}


\paragraph{Add rates manually}
\label{administration_portal/brand/billing/destination_rates:add-rates-manually}
Brand operator can add rates by hand, filling these fields (\textbf{List of rates} subsection):
\begin{description}
\item[{Destination\index{Destination|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/destination_rates:term-destination}
Pre-created destination that specifies a concrete prefix.

\item[{Connection fee\index{Connection fee|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/destination_rates:term-connection-fee}
The amount that is charged just for call establishment.

\item[{Interval start\index{Interval start|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/destination_rates:term-interval-start}
When should the billing engine start rating the calls. If you set it to 10, first 10 seconds will be for free.

\item[{Per minute rate\index{Per minute rate|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/destination_rates:term-per-minute-rate}
Price per minute of conversation.

\item[{Charge period\index{Charge period|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/billing/destination_rates:term-charge-period}
Increase cost every seconds? Or in 10 second intervals? Or every minute?

\end{description}

\begin{notice}{note}{Note:}
A call with less duration that the one defined in interval start will have the price of the \textbf{Connection fee}.
\end{notice}

\begin{notice}{warning}{Warning:}
All decimals must use point as decimal delimiter. 4 decimals precision is used.
\end{notice}
\paragraph{How it works}

Call cost/price is increased by (\emph{Per minute rate} / 60 ) * \emph{charge period} every \emph{charge period} seconds:
\begin{itemize}
\item {} 
If \emph{billing period} is set to 1, every second the price will be increased
\emph{price per minute} divided by 60 (bill by seconds).

\item {} 
If \emph{billing period} is set to 60, every minute the price will be increased
\emph{price per minute} (bill by minutes).

\end{itemize}


\paragraph{Importing a CSV file}
\label{administration_portal/brand/billing/destination_rates:importing-a-csv-file}
At this point, the brand operator may have noticed that adding thousands
of rates would be a really annoying and time consuming task, as there
are 254 countries, each of them with their mobile networks, landline networks,
special service numbers, etc.

That's why the creation of destination rates is done using a
\href{https://es.wikipedia.org/wiki/CSV}{CSV} file.

The first step is creating an empty \emph{Destination rate} to import the prices in and using \textbf{Import rates} option.

We can select which column contains which field, in case we want to import a
\href{https://es.wikipedia.org/wiki/CSV}{CSV} file in a non-recommended format. We
can also decide whether to import the first line or discard it as it may have
titles instead of data.

\begin{notice}{hint}{Hint:}
The importing process is done in background, letting the brand operator
continue doing other stuff while it is finished.
\end{notice}


\subparagraph{CSV format}
\label{administration_portal/brand/billing/destination_rates:csv-format}
Although the import window allows importing non-recommended format CSV files,
we encourage you to import a file in the proposed format, as it will make
this process much easier.

You can find a sample CSV for importing \href{https://raw.githubusercontent.com/irontec/ivozprovider/artemis/web/admin/samples/pricesSample.csv}{here}.

The order of the columns should be:
\begin{itemize}
\item {} 
Destination name

\item {} 
Destination prefix (E.164 with + sign)

\item {} 
Per minute charge

\item {} 
Establishment cost

\item {} 
Billing period in seconds

\end{itemize}

\begin{notice}{note}{Note:}
It is recommended to double quote alphanumeric entries, though
it is not compulsory for single word entries (or entries without odd symbols).
\textbf{If they contain any comma, they MUST be quoted}.
\end{notice}

\begin{notice}{error}{Error:}
Floating numbers \textbf{MUST use point as decimal separator}.
\end{notice}

\begin{notice}{note}{Note:}
Numeric entries can be quoted with double quotes, but it is
not mandatory.
\end{notice}

You can download the imported file of the destination rate. Take into account that while importing
over existing data, the matching values are overwritten and the not matching are kept. This allows
downloading the imported file, changing some values and importing pricing back.

\begin{notice}{note}{Note:}
When re-importing, non-existent prefixes are kept.
\end{notice}

Once the import process is over, we only have to include this destination rate into some
rating plan and bind it to the clients we want following the procedure explained in
{\hyperref[administration_portal/brand/billing/rating_plans:rating\string-plans]{\sphinxcrossref{\DUrole{std,std-ref}{Rating plans}}}}.


\subsubsection{Destinations}
\label{administration_portal/brand/billing/destinations::doc}\label{administration_portal/brand/billing/destinations:destinations}
\emph{Destinations} section binds prefixes (always starting with +) with names.

\begin{notice}{tip}{Tip:}
These names will be used in invoices to identify matching destinations.
\end{notice}

Adding destination by hand is only needed is you want to add \emph{destination rates} by hand as explained in {\hyperref[administration_portal/brand/billing/destination_rates:add\string-rates\string-manually]{\sphinxcrossref{\DUrole{std,std-ref}{Add rates manually}}}}.

All non-existent prefixes found in CSV importing process described in {\hyperref[administration_portal/brand/billing/destination_rates:importing\string-a\string-csv\string-file]{\sphinxcrossref{\DUrole{std,std-ref}{Importing a CSV file}}}} will added to this list
automatically.


\subsubsection{Prepaid balances}
\label{administration_portal/brand/billing/prepaid_balances::doc}\label{administration_portal/brand/billing/prepaid_balances:prepaid-balances}
This section displays the balance status for {\hyperref[administration_portal/brand/billing/index:prepaid\string-billing]{\sphinxcrossref{\DUrole{std,std-ref}{Prepaid billing}}}} and {\hyperref[administration_portal/brand/billing/index:pseudo\string-prepaid\string-billing]{\sphinxcrossref{\DUrole{std,std-ref}{Pseudo-prepaid billing}}}} clients.

Following options are available for each client:


\paragraph{Balance Operations}
\label{administration_portal/brand/billing/prepaid_balances:balance-operations}
Brand administrators increase/decrease the balance of a given client using this option.


\paragraph{Balance Movements List}
\label{administration_portal/brand/billing/prepaid_balances:balance-movements-list}
Brand administrators can keep track the balance movements (increase or decrease) on this account and their status
after the movement.


\paragraph{Balance Notifications}
\label{administration_portal/brand/billing/prepaid_balances:balance-notifications}
Brand administrators can configure email notifications when the balance is below a given threshold. See
{\hyperref[administration_portal/brand/settings/notification_templates:notification\string-templates]{\sphinxcrossref{\DUrole{std,std-ref}{Notification Templates}}}} to customize the sent email.


\section{Invoicing}
\label{administration_portal/brand/invoicing/index::doc}\label{administration_portal/brand/invoicing/index:invoicing}
The final goal of this section is to generate invoices with the calls that imply
cost of a given client.

These topics will be covered:


\subsection{Invoices}
\label{administration_portal/brand/invoicing/invoices:invoices}\label{administration_portal/brand/invoicing/invoices::doc}
\textbf{Invoices} section lets \textbf{brand operator} generate invoices to issue to its clients and lists all invoices of all
clients, no matter if they were generated automatically or manually.

\begin{notice}{tip}{Tip:}
Brand administrators can also enable view mode on this section to their clients. Check Client's Invoice data
configuration section for more information.
\end{notice}


\subsubsection{Generating a new invoice}
\label{administration_portal/brand/invoicing/invoices:generating-a-new-invoice}
These are the fields shown when \emph{Add Invoice} options is used:
\begin{description}
\item[{Invoice number sequence\index{Invoice number sequence|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoices:term-invoice-number-sequence}
Use next number of a predefined sequence or use custom number

\item[{Number\index{Number|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoices:term-number}
Only shown if no sequence number is used, lets brand operator to introduce a custom number

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoices:term-client}
The client whose calls will be invoiced

\item[{Template\index{Template|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoices:term-template}
Invoice template that will be used to generate the PDF invoice file

\item[{In/Out date\index{In/Out date|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoices:term-in-out-date}
The time period of the calls that will be invoiced

\item[{Call discount\index{Call discount|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoices:term-call-discount}
Percentage to discount calls, prior to tax rate calculation. No effect on fixed concepts.

\item[{Tax rate\index{Tax rate|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoices:term-tax-rate}
Taxes to add to the final cost (e.g. VAT)

\end{description}

Once saved, some {\hyperref[administration_portal/brand/invoicing/fixed_costs:fixed\string-costs]{\sphinxcrossref{\DUrole{std,std-ref}{Fixed costs}}}} can be added before generating the final invoice. This is achieved with \textbf{Fixed costs}
subsection, that allows adding several positive concepts to the invoice:
\begin{description}
\item[{Fixed cost\index{Fixed cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoices:term-fixed-cost}
Choose a predefined cost

\item[{Quantity\index{Quantity|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoices:term-quantity}
How many of this must be included

\end{description}

The last step is pressing \textbf{Generate invoice} suboption to create the final PDF. Afterwards, we can see which calls have been
included in a particular invoice with \textbf{List of External Calls} option or download the PDF file.

\begin{notice}{warning}{Warning:}
Only outbound external calls are included into invoices
\end{notice}

\begin{notice}{tip}{Tip:}
\textbf{Status} column shows if the PDF generation task is waiting for async worker (\emph{waiting}), in process (\emph{processing}),
ended with errors (\emph{failed}) or ended successfully (\emph{created}). On blank, \emph{Generate invoice} needs to be pressed.
\end{notice}


\paragraph{Rules}
\label{administration_portal/brand/invoicing/invoices:rules}
Invoice subsystem enforces several rules before generating a new invoice:
\begin{itemize}
\item {} 
\textbf{Proper date interval}: \emph{out date} must be bigger (after) than \emph{in date}.

\item {} 
\textbf{Out date must be previous than today}: Future dates or today's calls cannot be invoiced.

\item {} 
\textbf{One call, one invoice:} All calls in time interval cannot be included in any other invoice.

\item {} 
\textbf{All calls in interval must be billed}.

\end{itemize}

\begin{notice}{warning}{Warning:}
If any of these rules is not fulfilled, the invoice won't be created and the system will warn.
\end{notice}


\paragraph{Timezones}
\label{administration_portal/brand/invoicing/invoices:timezones}
\emph{In date} and \emph{Out date} will be interpreted using brand timezone. On the other hand, call times in invoices are converted
to client timezone, leading to situations like this:
\begin{itemize}
\item {} 
\emph{In date}: 01/10/2018 00:00:00

\item {} 
\emph{Out date}: 31/10/2018 23:59:59

\item {} 
Brand timezone: UTC + 1

\item {} 
Client timezone: UTC - 1

\item {} 
Time interval in brand timezone: 01/10/2018 00:00 - 31/10/2018 23:59:59

\item {} 
Time interval in client timezone: 30/09/2018 22:00 - 31/10/2018 21:59:59

\end{itemize}

Invoice generated for the client will have calls from 30nd of september at 22:00 to 31st of october at 21:59:59, which
may seem awkward to the client.


\subsubsection{Regenerating an existing invoice}
\label{administration_portal/brand/invoicing/invoices:regenerating-an-existing-invoice}
Brand operator can edit any invoice parameter (as long as rules above are fulfilled), add/remove fixed concepts, etc. and
press \textbf{Generate invoice} again.

\begin{notice}{tip}{Tip:}
Whenever a change is made, \emph{Status} column will change to blank to show that \emph{Generate invoice} must be pressed.
\end{notice}


\paragraph{Generate invoice for rerated calls}
\label{administration_portal/brand/invoicing/invoices:generate-invoice-for-rerated-calls}
If rating of any call included in an invoice is wrong, {\hyperref[administration_portal/platform/external_calls:external\string-calls]{\sphinxcrossref{\DUrole{std,std-ref}{External calls}}}} section allows rerating it, as long as the
invoice that includes the call is previously deleted.

Once deleted and rerated, a new row can be added in \emph{Invoices} section to include rerated calls.


\subsection{Invoice schedulers}
\label{administration_portal/brand/invoicing/invoice_schedulers::doc}\label{administration_portal/brand/invoicing/invoice_schedulers:invoice-schedulers}
This section allows programming the automatic periodical creation of invoices.

When adding a new definition, these fields are shown:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_schedulers:term-name}
Name of the scheduled invoice

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_schedulers:term-client}
Which client calls should be included

\item[{Email\index{Email|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_schedulers:term-email}
Send generated invoices via email. Empty if no automatic mail is wanted.

\item[{Frequency/Unit\index{Frequency/Unit|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_schedulers:term-frequency-unit}
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\item[{Invoice number sequence\index{Invoice number sequence|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_schedulers:term-invoice-number-sequence}
Scheduled invoices will use the next invoice number available in a given predefined sequence

\item[{Call discount\index{Call discount|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_schedulers:term-call-discount}
Percentage to discount calls, prior to tax rate calculation. No effect on fixed concepts.

\item[{Tax rate\index{Tax rate|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_schedulers:term-tax-rate}
Taxes to add to the final cost (e.g. VAT)

\end{description}

\begin{notice}{tip}{Tip:}
Fixed concepts can be added in the same way as in manual invoice definitions
\end{notice}

Invoices generated due to an schedule can be seen in two ways:
\begin{itemize}
\item {} 
In each row of \emph{Invoice schedulers} section, \textbf{List of Invoices} option.

\item {} 
In \emph{Invoices} section, indistinguishable to manually generated invoices.

\end{itemize}


\subsubsection{Frequency definition}
\label{administration_portal/brand/invoicing/invoice_schedulers:frequency-definition}
It is interesting to understand how \emph{Frequency} and \emph{Unit} fields define the periodical task:
\begin{itemize}
\item {} 
Invoices are programmed at 08:00:00 by default on mondays, 1st of month or 1st of January (depending on Unit value).

\item {} 
Once created a new schedule, \textbf{Next execution} shows when will happen next invoice generation.

\end{itemize}

\textbf{Next execution} value can be mangled, but generated invoice always will:
\begin{itemize}
\item {} 
Discard current day (2018/11/01 08:00:00 will set 2018/10/31 23:59:59 as \emph{Out date}).

\item {} 
\emph{In date} will be \emph{out date} minus X week(s), X month(s) or X year(s) (X equals to \emph{Frequency} value) + 1 second.

\end{itemize}
\paragraph{Example 1: Unit: week - Frequency 2}

Next execution will be set to next monday at 08:00 and invoices will include calls of last 2 weeks.
\paragraph{Example 1: Unit: month - Frequency 3}

Next execution will be set to next 1st of month at 08:00 and invoices will include calls of last 3 months.
\paragraph{Example 1: Unit: month - Frequency 1 - Next execution mangling}

Next execution will be set to next 1st of month at 08:00 but we mangle it to 3rd of month at 10:00:00.

Invoice will include calls from 3nd of previous month at 00:00:00 to 2nd to current month at 23:59:59.

\begin{notice}{tip}{Tip:}
\emph{Last execution} shows the date of last execution and its result (success/error).
\end{notice}

\begin{notice}{note}{Note:}
Both \emph{next execution} and \emph{last execution} are shown using brand timezone.
\end{notice}


\subsection{Invoice number sequences}
\label{administration_portal/brand/invoicing/invoice_number_sequences:invoice-number-sequences}\label{administration_portal/brand/invoicing/invoice_number_sequences::doc}
In order to allow programming automatic invoice generation using {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} section, invoice
numbers must be created using a defined sequence number.

This section allows brand operator to create as many sequences as needed filling these fields:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_number_sequences:term-name}
Used for referencing this sequence in Invoice generation window.

\item[{Prefix\index{Prefix|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_number_sequences:term-prefix}
Prepended in any number generated by this sequence.

\item[{Sequence length\index{Sequence length|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_number_sequences:term-sequence-length}
Zeroes will be prepended to enforce this length.

\item[{Increment\index{Increment|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/invoicing/invoice_number_sequences:term-increment}
Units between subsequent invoice numbers.

\end{description}

\begin{notice}{note}{Note:}
Invoice number sequences are mandatory for scheduled invoices and optional for manual invoices.
\end{notice}
\paragraph{Example (prefix: TEST, sequence length: 4, increment: 1)}

Generated sequence numbers will be: TEST0001, TEST0002, TEST0003 and so on.

\begin{notice}{tip}{Tip:}
\textbf{Latest value} field shows the value of last invoice number that used a given sequence.
\end{notice}


\subsection{Fixed costs}
\label{administration_portal/brand/invoicing/fixed_costs:fixed-costs}\label{administration_portal/brand/invoicing/fixed_costs::doc}
Fixed costs are a positive concepts that can be added to invoices prior to generating the final PDF.

It may be useful for services with fixed cost (e.g. FTTH 100 Mbps) of certain clients.

\begin{notice}{tip}{Tip:}
Use invoice templates that show a custom table for these concepts if your invoice will have any fixed cost.
\end{notice}


\subsection{Invoice templates}
\label{administration_portal/brand/invoicing/invoice_templates::doc}\label{administration_portal/brand/invoicing/invoice_templates:invoice-templates}
Before generating an example invoice, it is important to understand that invoice
creation process uses templates.

\begin{notice}{note}{Note:}
This way, every \textbf{brand operator} can adapt which information
is shown and how this information is shown, add logos, graphs, etc..
\end{notice}

Templates are parsed by \href{https://github.com/XaminProject/handlebars.php}{handlebars} and rendered
using \href{https://wkhtmltopdf.org/}{wkhtmltopdf} library.

The helper in the section \textbf{Brand configuration} \textgreater{} \textbf{Invoice templates} include
a summarized explanation of the creation of templates. In the \href{https://wkhtmltopdf.org/usage/wkhtmltopdf.txt}{official site of wkhtmltopdf} there is plenty additional information.
You can delve into template expressions \href{http://handlebarsjs.com/expressions.html}{here} as well.

\begin{notice}{tip}{Tip:}
Use \emph{Template testing} option to see a demo invoice for each template.
\end{notice}


\section{Calls}
\label{administration_portal/brand/calls/index::doc}\label{administration_portal/brand/calls/index:calls}
This group shows call lists and allows brand operator a few operations on them:


\subsection{External calls}
\label{administration_portal/brand/calls/external_calls:id1}\label{administration_portal/brand/calls/external_calls::doc}\label{administration_portal/brand/calls/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{description}
\item[{Start time\index{Start time|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-start-time}
Date and time of the call establishment.

\item[{Brand\index{Brand|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-brand}
Only visible for \emph{god}, shows the brand of each call.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-client}
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller\index{Caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-caller}
DDI presented for the outgoing call.

\item[{Callee\index{Callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-callee}
External number dialed.

\item[{Duration\index{Duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-duration}
Shows how long the call lasted.

\item[{Price\index{Price|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-price}
The money amount for the client.

\item[{Cost\index{Cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-cost}
The money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan\index{Rating Plan|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-rating-plan}
Rating plan used to set price for the call.

\item[{Destination\index{Destination|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-destination}
Destination that matched the call for billing.

\item[{Carrier\index{Carrier|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-carrier}
Shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for
each call.

\item[{Invoice\index{Invoice|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-invoice}
Shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID\index{Call ID|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-call-id}
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type\index{Endpoint Type|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-endpoint-type}
For retail client calls, shows ``RetailAccount''. Empty for remaining client types.

\item[{Endpoint Id\index{Endpoint Id|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/external_calls:term-endpoint-id}
For retail client calls, shows the retail account's id of the call. Empty for remaining client types.

\end{description}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\subsubsection{Call rerating}
\label{administration_portal/brand/calls/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\subsection{Call CSV schedulers}
\label{administration_portal/brand/calls/call_csv_schedulers:call-csv-schedulers}\label{administration_portal/brand/calls/call_csv_schedulers::doc}
This section allows programming the automatic periodical creation of CSV reports to:
\begin{itemize}
\item {} 
Clients (no matter type).

\item {} 
Brand operators.

\end{itemize}

\begin{notice}{note}{Note:}
This section is almost identical to {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} except to the
fields that do not apply to CSVs (Invoice number sequence, Tax rate...)
\end{notice}

\begin{notice}{tip}{Tip:}
Brand operators can schedule a CSV containing calls of all its clients.
In this kind of schedules, a notification template can be chosen. In remaining
schedules, the notification template assigned to the specific client will be used.
\end{notice}

When adding a new definition, these fields are shown:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-name}
Name of the scheduled Call CSV

\item[{Call direction:\index{Call direction:|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-call-direction}
Which kind of calls should be included: Inbound, outbound or both.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-client}
Which client calls should be included

\item[{Email\index{Email|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-email}
Send generated Call CSV via email. Empty if no automatic mail is wanted.

\item[{Notification template:\index{Notification template:|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-notification-template}
Used on email notifications

\item[{Frequency/Unit\index{Frequency/Unit|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-frequency-unit}
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\end{description}

Once created, some new fields and subsections are accesible:
\begin{itemize}
\item {} 
Next execution date.

\item {} 
Last execution date and result (success/error).

\item {} 
Generated CSVs in \textbf{List of Call CSV reports}.

\end{itemize}

\begin{notice}{tip}{Tip:}
Brand operator can generate CSV containing calls of all clients.
\end{notice}


\subsubsection{CSV fields}
\label{administration_portal/brand/calls/call_csv_schedulers:csv-fields}
These are the fields of the generated CSV files:
\begin{description}
\item[{callid\index{callid|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-callid}
Call-ID of the SIP dialog

\item[{startTime\index{startTime|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-starttime}
Time and date of the call establishment

\item[{duration\index{duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-duration}
Call duration in seconds

\item[{caller\index{caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-caller}
Caller number in E.164 format (with `+')

\item[{callee\index{callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-callee}
Callee number in E.164 format (with `+')

\item[{price\index{price|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-price}
Calculated price for the given call

\item[{direction\index{direction|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-direction}
call direction

\end{description}

In Brand CSVs, these additional fields will be included too:
\begin{description}
\item[{endpointType\index{endpointType|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-endpointtype}
`RetailAccount' for retail clients, empty for remaining types.

\item[{endpointId\index{endpointId|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-endpointid}
Retail Account ID for retail clients, empty for remaining types.

\item[{cost\index{cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-cost}
Calculated cost for the given call

\item[{companyId\index{companyId|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/calls/call_csv_schedulers:term-companyid}
Client ID

\end{description}


\section{Settings}
\label{administration_portal/brand/settings/index::doc}\label{administration_portal/brand/settings/index:settings}
This group contains two kind of sections:
\begin{itemize}
\item {} 
Brand global configuration

\item {} 
Brand defaults for new clients

\end{itemize}

These will be covered topics:


\subsection{Client Portals}
\label{administration_portal/brand/settings/client_portals:client-portals}\label{administration_portal/brand/settings/client_portals::doc}\label{administration_portal/brand/settings/client_portals:id1}
This section allows configuration of client portals:
\begin{itemize}
\item {} 
\textbf{Client}: Administration portal for all client types

\item {} 
\textbf{User}: Special portal for Virtual PBXs users

\end{itemize}

\begin{notice}{warning}{Warning:}\begin{itemize}
\item {} 
URLs MUST be HTTPS

\item {} 
URLs MUST not end with slash /

\end{itemize}
\end{notice}

Each URL can also configure a logo per URL, a theme and a phrase to use as
the title of the portal allowing creation of corporate portals per client.


\subsection{Numeric transformations}
\label{administration_portal/brand/settings/numeric_transformations::doc}\label{administration_portal/brand/settings/numeric_transformations:transformations}\label{administration_portal/brand/settings/numeric_transformations:numeric-transformations}
\textbf{IvozProvider} is designed to provide service \textbf{anywhere in the planet}, not
only the original country where the platform is installed.

A very important concept to achieve this goal is the numeric transformation,
that \textbf{adapts the different number format systems of the countries of the world}
defined in \href{https://www.itu.int/rec/T-REC-E.164/es}{E.164} \textbf{to a neutral format}.

\begin{notice}{note}{Note:}
Numeric transformation \emph{sets} must be assigned to {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carriers}}}}, {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Providers}}}}, \textbf{Clients} and \textbf{User
endpoints} (Users, Friends, retail accounts, residential devices, etc.) to define the way every entity talks
with IvozProvider.
\end{notice}

There are two different transformation scenarios:


\subsubsection{Incoming transformations}
\label{administration_portal/brand/settings/numeric_transformations:incoming-transformations}
When a new call is received in IvozProvider matching a provider that has been
configured for \emph{peering}, we must adapt the numbers that make reference to:
\begin{itemize}
\item {} 
Origin of the call

\item {} 
Destination of the call

\end{itemize}

Depending on the country of the provider, the international numbers will have
a format or another. In this case, the spanish provider will use, for example:
\begin{itemize}
\item {} 
00 + 33 + number belonging to France

\item {} 
It's possible that the international numbers came without the 00 code.

\item {} 
It's possible that, if the call comes from the same country that the provider,
the number comes without the calling code (911234567 instead of 00 + 34 +
911234567 for Spain).

\end{itemize}

For an Ukranian provider, that doesn't use the 00 as international code:
\begin{itemize}
\item {} 
It will use 810 + 33 + number belonging to France.

\item {} 
It's possible that even part of the international code (00 in most of the
countries of the world) the provider use specific codes as prefix.

\end{itemize}

The goal of the incoming transformation is that, no matter what numeric system
the provider uses, the number will end in a general and common format.
\phantomsection\label{administration_portal/brand/settings/numeric_transformations:e164}
\begin{notice}{important}{Important:}
This common format is usually called E.164 and shows the numbers
without international code, but with country calling code: i.e. +34911234567
\end{notice}


\subsubsection{Outgoing transformations}
\label{administration_portal/brand/settings/numeric_transformations:outgoing-transformations}
In the same way the origin and destination must adapt incoming numbers, it
will be required to adapt outgoing dialed numbers to properly work with each
of the providers that will route our call.

For example, for a number with spanish number system:
\begin{itemize}
\item {} 
\emph{Spanish provider}: Destination will come in E164 (+34911234567) and for this
provider, we can remove the calling code (will understand it belongs to
its country), so the number sent to them will be 911234567.

\item {} 
\emph{French provider}: The destination will come in E164 (+34911234567) and we must
add the international code for France, so the number sent to them will be
0034911234567.

\end{itemize}

\begin{notice}{note}{Note:}
To sum up, we aim to send the origin and destination in the format the
provider is expecting.
\end{notice}

\begin{notice}{tip}{Tip:}
Numeric transformation uses \href{https://es.wikipedia.org/wiki/Expresi\%C3\%B3n\_regular}{simple regular expressions} to describe the
changes done to the numbers. You can find multiple tutorials on net with the
basic regular expression format.
\end{notice}


\paragraph{Add a new transformation set}
\label{administration_portal/brand/settings/numeric_transformations:add-a-new-transformation-set}
IvozProvider comes with an automatic transformation rules generator that fits
with most of the countries.

In order to create a new set of transformations use \textbf{Add Numeric transformations}:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/numeric_transformations:term-name}
Use to reference this numeric transformation set

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/numeric_transformations:term-description}
Additional information for each set

\item[{Automatic creation of rules\index{Automatic creation of rules|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/numeric_transformations:term-automatic-creation-of-rules}
If set, \emph{Geographic Configuration} fields will be used to automatically configure the rules of the set.

\item[{Geographic Configuration\index{Geographic Configuration|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/numeric_transformations:term-geographic-configuration}
International Code of the country, country code, trunk prefix if any, area code if any and national subscriber
number length

\end{description}


\subparagraph{Example for Spain}
\label{administration_portal/brand/settings/numeric_transformations:example-for-spain}
Fulfilling Geographic Configuration with:
\begin{itemize}
\item {} 
International Code: 00

\item {} 
Country Code: +34

\item {} 
Trunk Prefix: \textless{}empty\textgreater{}

\item {} 
Area Code: \textless{}empty\textgreater{}

\item {} 
National number length: 9

\end{itemize}

Auto-created rules will transform the numbers for spanish providers that follow these rules:
\begin{itemize}
\item {} 
A spanish number: Neither international nor calling code (34).

\item {} 
Not a spanish number: International code (00) and calling code (34).

\end{itemize}

Let's check this \emph{set} to understand what transformation rule does:

\begin{notice}{attention}{Attention:}
The automatic rule generation will create 8 common rules based on
the given parameters. This rules can be edited later to match the provider
requirements.
\end{notice}


\subsubsection{Spanish incoming transformation}
\label{administration_portal/brand/settings/numeric_transformations:spanish-incoming-transformation}
Displayed in blue in the previous image:
\begin{itemize}
\item {} 
Left called/destination

\item {} 
Right callee/origin

\end{itemize}

The same rules will be applied for the origin and destination:
\begin{itemize}
\item {} 
The \textbf{metric} field will be used to order the rules (smaller first).
\begin{itemize}
\item {} 
If a rule doesn't \emph{match}, the next rule is evaluated.

\item {} 
If a rule \emph{matches}, no more rules are evaluated.

\item {} 
If no rule \emph{matches}, no change is applied.

\end{itemize}

\item {} 
The \textbf{Search} field is evaluated against the number (depending of the
transformation type it will be destination or origin).

\item {} 
The \textbf{Replace} field will use the capture groups that matched the Search
field (displayed between brackets, 1 for the first one, 2 for the second
one, and so on) to determine how the number will end.

\end{itemize}


\subsubsection{Spanish outgoing transformation}
\label{administration_portal/brand/settings/numeric_transformations:spanish-outgoing-transformation}
Following the same logic, this 2 rules make the change of the outgoing external
destination numbers.

\begin{notice}{attention}{Attention:}
\textbf{To sum up}: numeric transformation can adapt origin and
destination numbers to E.164 for the platform, and to providers expected
formats, based on regular expressions and metric that can be grouped in \emph{sets}
to be shared between multiple \textbf{Carriers}.
\end{notice}


\paragraph{Conclusion}
\label{administration_portal/brand/settings/numeric_transformations:conclusion}
This is a key section that allows creating sets that will allow IvozProvider make needed numeric translations to `talk'
with all the external entities:
\begin{itemize}
\item {} 
Providers (carriers and DDI Providers)

\item {} 
Client endpoints (Users, Friends, Retail accounts, Residential accounts, Wholesale clients)

\end{itemize}

Those sets will:
\begin{itemize}
\item {} 
Convert custom external format to E.164 for internal usage.

\item {} 
Convert E.164 to custom external format for external usage.

\end{itemize}

Converted SIP headers:
\begin{itemize}
\item {} 
Destination headers (R-URI/To/Refer-To)

\item {} 
Source headers (From/RPID/PAI/Diversion)

\end{itemize}

For all these transformations \href{http://php.net/manual/en/reference.pcre.pattern.syntax.php}{Regular Expressions} knowledge
is needed, unless automatic created rules work out of the box.


\subsection{Notification Templates}
\label{administration_portal/brand/settings/notification_templates::doc}\label{administration_portal/brand/settings/notification_templates:notification-templates}\label{administration_portal/brand/settings/notification_templates:id1}
Brand administrators can configure the notifications sent by IvozProvider:
\begin{itemize}
\item {} 
Email sent when a new voicemail is received

\item {} 
Email sent when a new fax is received

\item {} 
Email sent when a balance is below configured threshold

\item {} 
Email sent when an automatic invoice is generated

\item {} 
Email sent when scheduled CDR CSVs are generated

\end{itemize}

\begin{notice}{hint}{Hint:}
When no custom notification is configured, default ones will be used
\end{notice}

Notifications are created in two steps: Create a notification type and add contents to the notification for each
required language.


\subsubsection{Creating a new notification}
\label{administration_portal/brand/settings/notification_templates:creating-a-new-notification}
Brand administrators can create new notification templates in \textbf{Brand configuration} \textgreater{} \textbf{Notification templates}:

Fields are nearly self-explanatory:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/notification_templates:term-name}
Used to identify this notification template

\item[{Type\index{Type|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/notification_templates:term-type}
Determine the notification type. Each notification type has its own substitution variables available to replace
the contents of the subject and body.

\end{description}


\subsubsection{Adding Notification contents}
\label{administration_portal/brand/settings/notification_templates:adding-notification-contents}
Once the notification has been created, you can add different language contents. IvozProvider will automatically use
the proper language based on the destination:
\begin{itemize}
\item {} 
For Voicemails, the user language will be used

\item {} 
For Faxes, the client language will be used.

\end{itemize}

Configurable fields of each content:
\begin{description}
\item[{Language\index{Language|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/notification_templates:term-language}
Language of the contents.

\item[{From Name\index{From Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/notification_templates:term-from-name}
The from name used while sending emails (p.e. IvozProvider Voicemail Notifications)

\item[{From Address\index{From Address|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/notification_templates:term-from-address}
The from address used while sending emails (p.e. \href{mailto:no-reply@ivozprovider.com}{no-reply@ivozprovider.com})

\item[{Substitution variables\index{Substitution variables|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/notification_templates:term-substitution-variables}
Available variables that can be used in subject and body that will be replaced before sending the email. Each
notification type has its own variables.

\item[{Subject\index{Subject|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/notification_templates:term-subject}
Subject of the email to be sent. You can include Substitution variables here.

\item[{Body type\index{Body type|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/notification_templates:term-body-type}
Body of the mail can be both plaintext or html.

\item[{Body\index{Body|textbf}}] \leavevmode\phantomsection\label{administration_portal/brand/settings/notification_templates:term-body}
Body of the email to be sent. You can include Substitution variables here.

\end{description}

\begin{notice}{hint}{Hint:}
There is no need to create all content languages. If custom notification has some languages not defined the
default contents will be used for that notification type.
\end{notice}


\subsubsection{Assigning templates to clients}
\label{administration_portal/brand/settings/notification_templates:assigning-templates-to-clients}
Once the notification has been configured for the desired languages, Brand administrator must assign it to the
client that will use it. This can be done in the Notification configuration section of each client.


\subsection{Generic Music on Hold}
\label{administration_portal/brand/settings/generic_music_on_hold:generic-music-on-hold}\label{administration_portal/brand/settings/generic_music_on_hold::doc}
{\hyperref[administration_portal/client/vpbx/multimedia/music_on_hold:music\string-on\string-hold]{\sphinxcrossref{\DUrole{std,std-ref}{Music on Hold}}}} will be played when the user holds the call and the other
member waits until the call is resumed.

If a vPBX client has defined a music on hold, it will be played. Otherwise, the
one defined by the brand administrator in this section. If none of this is configured,
a global music will be played.

Multiple files can be added to be played as Music on Hold. The system will choose them randomly for each call.

\begin{notice}{warning}{Warning:}
IvozProvider will play MOH only for vPBX and Residential clients. Remaining client
types don't have MOH capabilities as their calls don't traverse any Application Server.
\end{notice}

\begin{notice}{note}{Note:}
Residential client listen the MOH defined by the brand operator in this section. If none is configured,
a global music will be played.
\end{notice}


\subsection{Generic Services}
\label{administration_portal/brand/settings/generic_services:generic-services}\label{administration_portal/brand/settings/generic_services::doc}\label{administration_portal/brand/settings/generic_services:brand-services}
This section allows the brand operator to change the default services and default service codes for new clients.

By default this list has all the services and codes from the god level \textbf{Service} section.

\begin{notice}{warning}{Warning:}
Changing the default code in this section will only affect new created clients. Existing clients codes won't
be modified.
\end{notice}

\begin{notice}{warning}{Warning:}
Deleting a service will delete this service for all existing clients.
\end{notice}


\subsection{Generic Match Lists}
\label{administration_portal/brand/settings/generic_match_lists:generic-match-lists}\label{administration_portal/brand/settings/generic_match_lists::doc}\label{administration_portal/brand/settings/generic_match_lists:brand-match-lists}
{\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}} are designed to group well known numbers or patterns in order to use them in specific treatments.

Brand administrators can create generic Match lists to have it available for new clients.

\begin{notice}{tip}{Tip:}
Existing matchlists will be copied for new vPBX clients. Already existing clients won't be affected at all by
by changes made here.
\end{notice}


\section{Views}
\label{administration_portal/brand/views/index::doc}\label{administration_portal/brand/views/index:views}
Sections in this group list read-only handy information for brand operators:


\subsection{DDIs}
\label{administration_portal/brand/views/ddis:ddis}\label{administration_portal/brand/views/ddis::doc}
This section lists \textbf{all configured DDIs} in all the clients of the brand.

It makes easy to answer to these questions:
\begin{itemize}
\item {} 
Is this DDI of one of my clients? If so, whose?

\item {} 
Who DDI Provider provides it?

\item {} 
How many DDIs of country X does client Y have?

\item {} 
Etc.

\end{itemize}


\subsection{Retail accounts}
\label{administration_portal/brand/views/retail_accounts::doc}\label{administration_portal/brand/views/retail_accounts:retail-accounts}
This section lists \textbf{all existing retail accounts} of every retail client of the brand.

As all retail accounts of all retail clients use the same SIP domain (brand's SIP domain), collision has to be
avoided using some kind of numeric sequence. This section may be handy for this purpose.


\subsection{Residential devices}
\label{administration_portal/brand/views/residential_devices::doc}\label{administration_portal/brand/views/residential_devices:residential-devices}
This section lists \textbf{all existing residential devices} of every residential client of the brand.

As all residential devices of all residential clients use the same SIP domain (brand's SIP domain), collision has to be
avoided using some kind of numeric sequence. This section may be handy for this purpose.


\chapter{Client Configuration}
\label{administration_portal/client/index:client-configuration}\label{administration_portal/client/index::doc}
Currently, there are 4 different types of client in IvozProvider.

Each of them is thoroughly described in the following sections:


\section{vPBX Clients}
\label{administration_portal/client/vpbx/index:vpbx-clients}\label{administration_portal/client/vpbx/index::doc}
This section will explain all these topics related to the most feature-full type of client in IvozProvider:


\subsection{Users}
\label{administration_portal/client/vpbx/users::doc}\label{administration_portal/client/vpbx/users:users}\label{administration_portal/client/vpbx/users:id1}
The installation process creates \emph{Alice} and \emph{Bob} users, allowing us
to test internals calls between them without too much effort.

We skipped most of the settings in \textbf{Users} configuration that we will described
in this section.


\subsubsection{Personal data}
\label{administration_portal/client/vpbx/users:personal-data}\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-name}
Used to identify this user in most of the screens. This is also the
name that will be displayed in internal calls made from this user.

\item[{Lastname\index{Lastname|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-lastname}
Most of the times this is used to complete the previous field.

\item[{Email\index{Email|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-email}
Email used to send the user's received voicemails. This is also used to
identify the user in their portal.

\item[{Country code / Area code\index{Country code / Area code|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-country-code-area-code}
Defines the way the user calls and the way the numbers are presented to
this user.

\item[{Language\index{Language|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-language}
When a locution is played to this user, this language is used.

\item[{Timezone\index{Timezone|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-timezone}
User portal call list times will use this timezone.

\end{description}


\subsubsection{Login Info}
\label{administration_portal/client/vpbx/users:login-info}\begin{description}
\item[{Active\index{Active|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-active}
Allows administrators to grant or disable user's acces to the
{\hyperref[user_portal/index:userportal]{\sphinxcrossref{\DUrole{std,std-ref}{user's portal}}}}.

\item[{Password\index{Password|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-password}
Password used to access the {\hyperref[user_portal/index:userportal]{\sphinxcrossref{\DUrole{std,std-ref}{user's portal}}}}.

\item[{QR Code\index{QR Code|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-qr-code}
If enabled, a QR code for Grandstream Wave softphone configuration
will be shown.

\end{description}


\subsubsection{Basic Configuration}
\label{administration_portal/client/vpbx/users:basic-configuration}\begin{description}
\item[{Terminal\index{Terminal|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-terminal}
The available terminals created in {\hyperref[administration_portal/client/vpbx/terminals:terminals]{\sphinxcrossref{\DUrole{std,std-ref}{Terminals}}}} are listed here
for assignment.

\item[{Screen Extension\index{Screen Extension|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-screen-extension}
One of the available {\hyperref[administration_portal/client/vpbx/extensions:extensions]{\sphinxcrossref{\DUrole{std,std-ref}{Extensions}}}} that this user will display when
placing internal calls. While multiple extensions can be routed to the
user, only one of them will be presented when the user calls.

\item[{Outgoing DDI\index{Outgoing DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-outgoing-ddi}
As described in {\hyperref[getting_started/external_outgoing_calls/outgoing_ddi:external\string-ddi]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing DDI configuration}}}}, determines the number that will
present when placing external outgoing calls.

\item[{Outgoing DDI Rules\index{Outgoing DDI Rules|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-outgoing-ddi-rules}
Manages exceptions to previous setting. Read {\hyperref[administration_portal/client/vpbx/user_configuration/outgoing_ddi_rules:outgoingddi\string-rules]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing DDI Rules}}}}
for further reference.

\item[{Call ACL\index{Call ACL|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-call-acl}
One of the created {\hyperref[administration_portal/client/vpbx/user_configuration/call_acls:call\string-permissions]{\sphinxcrossref{\DUrole{std,std-ref}{Call ACL}}}} groups, described
it the previous sections.

\item[{Do not disturb\index{Do not disturb|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-do-not-disturb}
When this setting is enabled, the user won't receive any call but can
still place calls.

\item[{Max Calls\index{Max Calls|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-max-calls}
Limits the number of concurrent received calls. Set 0 for unlimited calls.

\item[{Calls from non-granted IPs:\index{Calls from non-granted IPs:|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-calls-from-non-granted-ips}
Enable calling from non-granted IP addresses for this user.
It limits the number of outgoing calls to avoid toll-fraud.
`None' value makes outgoing calls unlimited as long as client IP
policy is fulfilled. Read {\hyperref[security_and_maintenance/security/authorized_ip_ranges:roadwarrior\string-users]{\sphinxcrossref{\DUrole{std,std-ref}{Roadwarrior users}}}} for further reference.

\end{description}


\subsubsection{Voicemail}
\label{administration_portal/client/vpbx/users:voicemail}\begin{description}
\item[{VoiceMail enabled\index{VoiceMail enabled|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-voicemail-enabled}
Enables or disables the \textbf{existance} of a users voicemail.
This only makes the voicemail available to be routed as destination of a call forwarding.

\item[{Voicemail Locution\index{Voicemail Locution|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-voicemail-locution}
If set, this locution is played as voicemail welcome message when a voicemail
for this user is going to be recorded. This only applies for call forwards
to voicemail.

\item[{Email notification\index{Email notification|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-email-notification}
Send an email to the configured user address when a new voicemail is
received.

\item[{Attach sounds:\index{Attach sounds:|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-attach-sounds}
Attach the audio message to the sent email.

\end{description}

\begin{notice}{note}{Note:}
If voicemail locution is not assigned, default locution will be used as long as
the user has not recorded a custom message through the voicemail menu (calling to
voicemail service code).
\end{notice}


\subsubsection{Boss-Assistant}
\label{administration_portal/client/vpbx/users:boss-assistant}
This feature will turn the user into a boss that can only be directly call by:
\begin{itemize}
\item {} 
The selected assistant.

\item {} 
Any origin that matches the white list.

\end{itemize}

The rest of the calls to \emph{a boss} will be redirected to the assistant.
\begin{description}
\item[{Is boss\index{Is boss|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-is-boss}
Determines if this user is a boss.

\item[{Assistant\index{Assistant|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-assistant}
Who will receive the redirected calls of this boss.

\item[{Whitelist\index{Whitelist|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-whitelist}
{\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}} with origins that are allowed to call directly to
the boss.

\end{description}

With the setup in the image, every call to \emph{Alice} will be redirected to \emph{Bob},
except the ones placed by \emph{Bob} itself and those coming from any origin that matches
\emph{Alice's friends} matchlist.


\subsubsection{Group Configuration}
\label{administration_portal/client/vpbx/users:group-configuration}
As described in the sections {\hyperref[administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups]{\sphinxcrossref{\DUrole{std,std-ref}{Hunt groups}}}} and {\hyperref[administration_portal/client/vpbx/user_configuration/pick_up_groups:capture\string-groups]{\sphinxcrossref{\DUrole{std,std-ref}{Pick up groups}}}}, the
user can be part of one or more hunt groups and pickup groups.

Those groups can be configured from the sections {\hyperref[administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups]{\sphinxcrossref{\DUrole{std,std-ref}{Hunt groups}}}} and
{\hyperref[administration_portal/client/vpbx/user_configuration/pick_up_groups:capture\string-groups]{\sphinxcrossref{\DUrole{std,std-ref}{Pick up groups}}}} or the user's screen if the groups already exists.

You can also configure the user's \textbf{hunt groups} from the icon in each user
line of the users list.


\subsubsection{User Call Forward}
\label{administration_portal/client/vpbx/users:user-call-forward}
The user's call forward can be configured with the \textbf{List of call forward settings}  button.

These are the fields and available values:
\begin{description}
\item[{Call Type\index{Call Type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-call-type}
Determines if the forward must be applied to external, internal or any
type of call.

\item[{Forward type\index{Forward type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-forward-type}\begin{description}
\item[{When this forward must be applied:}] \leavevmode\begin{itemize}
\item {} 
Unconditional: always

\item {} 
No answer: when the call is not answered in X seconds

\item {} 
Busy: When the user is talking to someone (and call waiting is
disabled), when \emph{Do not disturb} is enabled or when the user
rejects an incoming call.

\item {} 
Not registered: when the user SIP terminal is not registered
against IvozProvider.

\end{itemize}

\end{description}

\item[{Target type\index{Target type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-target-type}\begin{description}
\item[{What route will use the forwarded call.}] \leavevmode\begin{itemize}
\item {} 
VoiceMail

\item {} 
Number (external)

\item {} 
Extension (internal)

\end{itemize}

\end{description}

\end{description}

\begin{notice}{hint}{Hint:}
If we want to forward to other process, we can create an extension
routed to that object and use the target type \emph{Extension}.
\end{notice}


\subsection{Terminals}
\label{administration_portal/client/vpbx/terminals:terminals}\label{administration_portal/client/vpbx/terminals::doc}\label{administration_portal/client/vpbx/terminals:id1}
The section \textbf{Client configuration} \textgreater{} \textbf{Terminals} allows creating new
SIP credentials that can be used by multiple SIP devices to place and receive
calls from IvozProvider.

The best way to understand this section is creating a new item and see the
fields that must be filled.
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/terminals:term-name}
Username that will use the terminal during the SIP authentication phase
with IvozProvider.

\item[{Password\index{Password|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/terminals:term-password}
Password that will use the terminal to answer the SIP authentication
challenge. You can use the automatic password generator to fulfill the
secure password requirements.

\item[{Allowed/Disallowed codecs\index{Allowed/Disallowed codecs|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/terminals:term-allowed-disallowed-codecs}
Determines what audio and video codecs will be used with the terminal.

\item[{CallerID update method\index{CallerID update method|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/terminals:term-callerid-update-method}
Choose the SIP method the terminal prefers to received the session
update information: INVITE or UPDATE. The help hint can be used as
guide to configure different terminal manufacturers. Use \emph{INVITE} in
case of doubt.

\item[{Terminal model\index{Terminal model|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/terminals:term-terminal-model}
Determines the provisioning type that will receive this terminal.
The section {\hyperref[administration_portal/platform/terminal_manufacturers:provisioning]{\sphinxcrossref{\DUrole{std,std-ref}{terminal provisioning}}}} will explain
in depth the different models for automatic provision. If your device
does not require provisioning, just select \emph{Generic}.

\item[{MAC\index{MAC|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/terminals:term-mac}
Optional field that is only required if you plan to use IvozProvider
{\hyperref[administration_portal/platform/terminal_manufacturers:provisioning]{\sphinxcrossref{\DUrole{std,std-ref}{terminal provisioning}}}}. This is the \href{https://wikipedia.org/wiki/MAC\_Address}{physical
address} of the network
adapter of the SIP device.

\item[{Enable T.38 passthrough\index{Enable T.38 passthrough|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/terminals:term-enable-t-38-passthrough}
If set to `yes', this SIP endpoint must be a \textbf{T.38 capable fax sender/receiver}. IvozProvider
application servers will act as T.38 gateways, routing calls through a T.38 capable carrier and
bridging signalling and media from one to another. See {\hyperref[security_and_maintenance/security/firewall:firewall]{\sphinxcrossref{\DUrole{std,std-ref}{Firewall}}}} for port exposing concerns
related to this kind of traffic.

\end{description}

\begin{notice}{note}{Note:}
For \textbf{most of devices} that doesn't require provisioning just
filling \textbf{username} and \textbf{password} will be enough.
\end{notice}

\begin{notice}{hint}{Hint:}
Once the terminal has been created, most devices will only
require the name, password and {\hyperref[getting_started/internal_calls/brand_portal:domain\string-per\string-client]{\sphinxcrossref{\DUrole{std,std-ref}{Client SIP domain}}}}
in order to place calls.
\end{notice}


\subsection{Extensions}
\label{administration_portal/client/vpbx/extensions:extensions}\label{administration_portal/client/vpbx/extensions::doc}
\begin{notice}{note}{Note:}
\textbf{An extensions is}, by definition, \textbf{an internal number with an
assigned logic}.
\end{notice}
\paragraph{Create a new extension}
\begin{description}
\item[{Number\index{Number|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/extensions:term-number}
The number that must be dialed by the internal user that will trigger
the configured logic. It must have a minimum length of 2 and must be
a number.

\item[{Route\index{Route|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/extensions:term-route}
This select will allow us to choose the logic that will use this
extension when is dialed from an internal user. Depending on the selected
route, and additional select or input will be shown to select the
hunt group, conference room, user, etc.

\end{description}

\begin{notice}{warning}{Warning:}
If an extension has a number that conflicts with an external
number, this external number will be masked and, in practice, will be
unavailable for the whole client.
\end{notice}


\subsection{DDIs}
\label{administration_portal/client/vpbx/ddis:ddis}\label{administration_portal/client/vpbx/ddis::doc}\label{administration_portal/client/vpbx/ddis:pbx-ddis}\begin{description}
\item[{Country\index{Country|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/ddis:term-country}
The country of the new created DDI. Used for E164 standardization.

\item[{DDI\index{DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/ddis:term-ddi}
The number, without country code.

\item[{DDI Provider\index{DDI Provider|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/ddis:term-ddi-provider}
The {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} that provides this number. This relation allow
the platform to apply the required {\hyperref[administration_portal/brand/settings/numeric_transformations:transformations]{\sphinxcrossref{\DUrole{std,std-ref}{Numeric transformations}}}} in
order to determine its standard form.

\item[{External Call Filter\index{External Call Filter|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/ddis:term-external-call-filter}
Allows configuration based on Calendars and Schedulers as shown in
{\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-call\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}}. Leave empty if you don't need to apply any
kind of filter.

\item[{Route\index{Route|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/ddis:term-route}
A DDI can have different {\hyperref[administration_portal/client/vpbx/ddis:routing\string-logics]{\sphinxcrossref{\DUrole{std,std-ref}{treatments}}}}. For our
current goal, set route to user and select \emph{Alice}.

\item[{Record calls\index{Record calls|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/ddis:term-record-calls}
Can be used to record external calls (see {\hyperref[administration_portal/client/vpbx/calls/call_recordings:call\string-recordings]{\sphinxcrossref{\DUrole{std,std-ref}{Call recordings}}}}).

\item[{Tarificate incoming calls\index{Tarificate incoming calls|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/ddis:term-tarificate-incoming-calls}
This setting requires the external tarification module and allows
tarification on special numbers. This module is not standard so don't
hesitate in {\hyperref[basic_concepts/intro/getting_help:getting\string-help]{\sphinxcrossref{\DUrole{std,std-ref}{contact us}}}} if you are interested.

\end{description}


\subsubsection{DDI external filters}
\label{administration_portal/client/vpbx/ddis:ddi-external-filters}
We can assign a \textbf{external call filter} configured in {\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-call\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}}.


\subsubsection{DDI routes}
\label{administration_portal/client/vpbx/ddis:routing-logics}\label{administration_portal/client/vpbx/ddis:ddi-routes}
Once the call has passed all the checks in the filter (schedules and calendars)
and after the welcome locution has been played (if there is any configured),
we can route the call to the following processes:
\begin{itemize}
\item {} 
{\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{Users}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups]{\sphinxcrossref{\DUrole{std,std-ref}{Hunt groups}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/ivrs:ivrs]{\sphinxcrossref{\DUrole{std,std-ref}{IVRs}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/conference_rooms:conference\string-rooms]{\sphinxcrossref{\DUrole{std,std-ref}{Conference rooms}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/conditional_routes:conditional\string-routes]{\sphinxcrossref{\DUrole{std,std-ref}{Conditional routes}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/queues:queues]{\sphinxcrossref{\DUrole{std,std-ref}{Queues}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/index:friends]{\sphinxcrossref{\DUrole{std,std-ref}{Friends}}}}

\end{itemize}

\begin{notice}{hint}{Hint:}
We can also route the DDI to a {\hyperref[administration_portal/client/vpbx/faxes:faxing\string-system]{\sphinxcrossref{\DUrole{std,std-ref}{Virtual Fax}}}}, but
this is something we will explain in the following block.
\end{notice}


\subsection{Routing endpoints}
\label{administration_portal/client/vpbx/routing_endpoints/index:routing-endpoints}\label{administration_portal/client/vpbx/routing_endpoints/index::doc}
Sections in this group can be selected as a Route option for external DDIs and internal extensions:


\subsubsection{Interactive Voice Responses (IVRs)}
\label{administration_portal/client/vpbx/routing_endpoints/ivrs:interactive-voice-responses-ivrs}\label{administration_portal/client/vpbx/routing_endpoints/ivrs::doc}
IVRs are the most common way to make \textbf{audio menus} where the caller must
choose the destination of the call by \textbf{pressing codes} based on the locutions
instructions that will be played.


\paragraph{IVRs}
\label{administration_portal/client/vpbx/routing_endpoints/ivrs:ivrs}
IVRs support specifying actions for dialed digits, but also they can be also be used
to route any existing client extension.

IVRs have the following fields:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/ivrs:term-name}
Descriptive name of the IVR that will be used in other sections.

\item[{Timeout\index{Timeout|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/ivrs:term-timeout}
Time that caller has to enter the digits of the target extension.

\item[{Max digits\index{Max digits|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/ivrs:term-max-digits}
Maximum number of digits allowed in this IVR.

\item[{Welcome locution\index{Welcome locution|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/ivrs:term-welcome-locution}
This locution will be played as soon as the caller enters the IVR.

\item[{Success locution\index{Success locution|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/ivrs:term-success-locution}
In case the dialed number matches one of the IVR entries or extension
exists in the client (and allow extensions is enabled), this locution
will be played (usually something like `Connecting, please wait...').

\item[{Allow dialing extensions\index{Allow dialing extensions|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/ivrs:term-allow-dialing-extensions}
When this setting is enabled, the caller can directly press the extension
that must previously know (or the welcome locution suggests) and the system
will automatically connect with that extension.

\item[{Excluded Extensions\index{Excluded Extensions|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/ivrs:term-excluded-extensions}
When Allow extensions is enabled, you can exclude some extensions to be
directly dialed adding them to the exclusion list.

\item[{No input process\index{No input process|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/ivrs:term-no-input-process}
If the caller does not input any digit in the timeout value, the
no input process will trigger, playing the configured locution and
redirecting the call to another number, extension or voicemail.

\item[{Error process\index{Error process|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/ivrs:term-error-process}
If the dialed extension does not match any IVR entry, any client extensions
(when allow extensions is enabled), or it matches one of the extensions in the
excluded Extensions list, the error process will trigger, playing the configured
locution and redirecting the call to another number, extension or voicemail.

\end{description}


\paragraph{IVR Entries}
\label{administration_portal/client/vpbx/routing_endpoints/ivrs:ivr-entries}
\begin{notice}{hint}{Hint:}
The most common usage for IVR is combining them with a welcome
locution that says something like `Press 1 to contact XXX, Press 2 to
contact YYY, ...''
\end{notice}

The process of each entry of the IVR can be defined in the following button:

In this example, the caller can dial 1, 2 or 3 (the rest will be considered as
an error and will trigger the \textbf{Error process}):
\begin{itemize}
\item {} 
1: Call to the internal extension 200, created in {\hyperref[administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups]{\sphinxcrossref{\DUrole{std,std-ref}{previous section}}}} that routes to hunt group \emph{Reception}.

\item {} 
2: Call to the internal extension 101.

\item {} 
3: Route this call to the external number 676 676 676.

\end{itemize}

\begin{notice}{note}{Note:}
Each of the IVR entries supports a locution that, if set,
will be played instead of the IVR \textbf{success locution}. This way, you can
configure a generic locution (like `Connecting....') or a custom one for
a given entry (like `Connecting reception department, please wait...').
\end{notice}
\paragraph{Entries are regular expressions}

You can specify IVR entries as Regular Expressions. If entry is just
a numeric value, it will be handled as a sequence of digits, otherwise it
will be handled a regular expression. This can be handy if you have the
same behaviour for a group of dialed numbers.


\subsubsection{Hunt groups}
\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:hunt-groups}\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups::doc}\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups}
The hunt groups allows configuring more complex \emph{ringing} process that the
traditional \textbf{call to a user}.

These are the fields shown for new hunt groups:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:term-name}
Used to reference this hunt group

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:term-description}
Additional information

\item[{Strategy\index{Strategy|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:term-strategy}
Describes how will the calls be delivered. See details in glossary below.

\item[{Ring all timeout\index{Ring all timeout|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:term-ring-all-timeout}
For \emph{Ringall} strategy, defines for how long will the members be called.

\item[{Prevent missed calls\index{Prevent missed calls|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:term-prevent-missed-calls}
When `Yes', calls will never generate a missed call. When `No', missed calls will be prevented only for RingAll
hunt groups if someone answers.

\item[{No answer configuration\index{No answer configuration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:term-no-answer-configuration}
Policy when hunt group members do not answer the call after defined timeouts.

\end{description}

\begin{notice}{tip}{Tip:}
When configuring a hunt group, you can prevent missed calls on called members with \textbf{Prevent missed calls} setting:
\begin{itemize}
\item {} 
\textbf{Yes}: calls generated by the hunt group will never generate missed calls on called members.

\item {} 
\textbf{No}: The behaviour of this setting depends on the hunt group type:

\item {} 
\textbf{RingAll}: calls generated by the hunt group will generate missed calls on called members only if none of them answers the call.

\item {} 
\textbf{Remaining types}: calls generated by the hunt group will generate missed calls on every called member that does not answer the call.

\end{itemize}
\end{notice}

There are 4 strategies available:
\begin{description}
\item[{Ringall\index{Ringall|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:term-ringall}
The call will make all the terminals of the group during a predefined
time.

\item[{Linear\index{Linear|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:term-linear}
The call will \emph{jump} from one user to another in a predefined order
ringing during the configured time. If the call is not answered by any
user of the group, it will be hung up (or will trigger the no answer logic).

\item[{Round robin\index{Round robin|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:term-round-robin}
The call will \emph{jump} from one user to another in a predefined order
ringing during the configured time. If the call is not answered by any
user of the group, the call will \emph{jump} again to the first member of the
group and keep looping.

\item[{Random\index{Random|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:term-random}
The call will \emph{jump} from one user to another in a random order,
ringing during the configured time.  If the call is not answered by any
user of the group, it will be hung up (or will trigger the no answer logic).

\end{description}


\paragraph{Adding members to hunt group}
\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:adding-members-to-hunt-group}
\textbf{List of users} subsection allows adding users to each group:
\begin{itemize}
\item {} 
For \emph{RingAll hunt groups}, users will be added without any additional parameters.

\item {} 
For remaining groups, priority and timeout will be specified for each member. Priority determines the order, timeout ring
duration for each member.

\end{itemize}

Section {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{Users}}}} also allows adding member to existing hunt groups using \textbf{List of hunt groups} option.


\subsubsection{Queues}
\label{administration_portal/client/vpbx/routing_endpoints/queues:queues}\label{administration_portal/client/vpbx/routing_endpoints/queues::doc}
Easy queue behaviour was included in IvozProvider in 1.3 version. It is a simple
approach with \textbf{the unique goal to provide the capability to handle more calls
than users attending them}.

\begin{notice}{warning}{Warning:}
Queues and callcenter are close terms but different. \textbf{IvozProvider
is not a suitable product for callcenters}, as it does not provide
advanced features that are crucial to them (reports, RT visualization,
queue related stat, etc.).
\end{notice}

\textbf{In distributed installations} using Queues is only compatible with an static
assignment or `hash based' distribution (see \textbf{Distribute method} {\hyperref[administration_portal/brand/clients/virtual_pbx:virtual\string-pbx]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}).

\begin{notice}{hint}{Hint:}
Brand operators can choose which Clients have queues (see \textbf{Features}
in {\hyperref[getting_started/internal_calls/brand_portal:brand\string-configuration]{\sphinxcrossref{\DUrole{std,std-ref}{Brand Configuration}}}} and {\hyperref[getting_started/internal_calls/client_portal:client\string-configuration]{\sphinxcrossref{\DUrole{std,std-ref}{Client Configuration}}}}).
\end{notice}


\paragraph{Queue configuration}
\label{administration_portal/client/vpbx/routing_endpoints/queues:queue-configuration}
This are the settings related to a queue:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-name}
Use to reference this queue

\item[{Weight\index{Weight|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-weight}
Prioritizes calls to an agent that attends calls in two (or more) calls. The
higher, the more prioritized.

\item[{Strategy\index{Strategy|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-strategy}
How will the queue deliver the calls? Calling to all agents, calling to a
random one?

\item[{Member call seconds\index{Member call seconds|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-member-call-seconds}
Defines how long will a call to an agent last.

\item[{Member rest seconds\index{Member rest seconds|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-member-rest-seconds}
Seconds between calls for an agent.

\item[{Announce\index{Announce|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-announce}
Select a locution and its frequency. Caller waiting in the call will listen
to this locution.

\item[{Timeout configuration\index{Timeout configuration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-timeout-configuration}
Limits the time that a call can wait in a queue and the following behaviour.

\item[{Full Queue configuration\index{Full Queue configuration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-full-queue-configuration}
Limits the amount of people waiting in a call and the behaviour when this limit
it reached.

\end{description}

Apart from creating a queue, you have to assign users to it. This users will have
a \textbf{penalty: a user will not be selected to deliver a call if any user with lower
penalty is available}.

\begin{notice}{hint}{Hint:}
A call can be sent to a queue selecting it in the ``Route type'' selectors
available in multiple sections of IvozProvider (extension to queue, DDI
to queue, etc.)
\end{notice}


\paragraph{Queue strategy}
\label{administration_portal/client/vpbx/routing_endpoints/queues:queue-strategy}
The queue strategy \textbf{always applies to current penalty members} starting with
the smallest penalty value and only going to the next penalty if all members of
current one are busy or unavailable.
\begin{description}
\item[{Ring all\index{Ring all|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-ring-all}
The call will make all the members of the current priority during a
predefined time.

\item[{Least recent\index{Least recent|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-least-recent}
The call will \emph{jump} from one member to another in a predefined order
based on the last time the member attended a call. Members whose latest
call is older will be called first.

\item[{Fewer calls\index{Fewer calls|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-fewer-calls}
The call will \emph{jump} from one member to another in a predefined order
based on the number of attended calls. Members that have attended less
calls will be called first.

\item[{Random\index{Random|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-random}
The call will \emph{jump} from one member to another in a random order,
ringing during the configured time.

\item[{Round Robin memory\index{Round Robin memory|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-round-robin-memory}
The call will \emph{jump} from one member to another in a predefined order
starting past the last member that attended a call.

\item[{Linear\index{Linear|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/queues:term-linear}
The call will \emph{jump} from one member to another in a predefined order
based on the creation time of the member.

\end{description}

\begin{notice}{warning}{Warning:}
A given penalty will never the called until all users with lower priority are on call.
\end{notice}

\begin{notice}{error}{Error:}
\emph{Linear} queues are special: a non-linear queue cannot be converted to linear.
\end{notice}


\subsubsection{Conditional routes}
\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes::doc}\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:conditional-routes}\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:id1}
Conditional routes allows changing a call logic depending on:
\begin{itemize}
\item {} 
Who is calling.

\item {} 
What time is calling.

\item {} 
What day is calling.

\item {} 
Status of selected route locks.

\end{itemize}

These routes are electable in three sections:
\begin{itemize}
\item {} 
DDIs

\item {} 
Extensions

\item {} 
IVR custom options

\end{itemize}

\begin{notice}{tip}{Tip:}
Remaining sections could use conditional routes creating an extension
that point to a conditional route first, and routing to this extension.
\end{notice}


\paragraph{Creating a conditional route}
\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:creating-a-conditional-route}
First of all we create a conditional route in \textbf{Conditional routes} section:

On creation we define what should be done with a call that does not satisfy any
of the rules described below.


\paragraph{Adding rules}
\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:adding-rules}
Once created, we need to add rules, for example:
\paragraph{Calls from Japan and Germany received in the morning to an specific user}
\paragraph{Calls from Japan and Germany received in the afternoon to another user}
\paragraph{Override the reception IVR for summer days}

With this example rules, our example conditional route will look like this:

Some notes about this example:
\begin{itemize}
\item {} 
Rules are evaluated following the metric parameter. Once a rule matches, its
logic is applied.

\item {} 
Rules may have from 1 to 4 criteria:
\begin{itemize}
\item {} 
None, one or more matchlist (pre-created, see {\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}})

\item {} 
None, one or more schedules (pre-created, see {\hyperref[administration_portal/client/vpbx/routing_tools/schedules:schedules]{\sphinxcrossref{\DUrole{std,std-ref}{Schedules}}}})

\item {} 
None, one or more calendar (pre-created, see {\hyperref[administration_portal/client/vpbx/routing_tools/calendars:calendars]{\sphinxcrossref{\DUrole{std,std-ref}{Calendars}}}})

\item {} 
None, one or more route locks (pre-created, see {\hyperref[administration_portal/client/vpbx/routing_tools/route_locks:route\string-locks]{\sphinxcrossref{\DUrole{std,std-ref}{Route locks}}}})

\end{itemize}

\item {} 
These 4 criteria are combined (applying an AND logic).

\end{itemize}

\begin{notice}{tip}{Tip:}
If one of selected route locks is open, this criteria is considered fulfilled.
\end{notice}


\paragraph{Using a conditional route}
\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:using-a-conditional-route}
The behaviour when an IVR option or an extension is routed to a conditional
route is easy to understand, but using conditional routes with DDIs need an
additional explanation.

Imagine this scenario:

DDI has an external call filter and is routed to the new conditional route.

When a call is received:
\begin{itemize}
\item {} 
External call filter is evaluated:
\begin{itemize}
\item {} 
If current day is marked in any calendar, the holiday logic applies.

\item {} 
If current time is not inside any time-gap, out-of-schedule logic applies.

\end{itemize}

\item {} 
If external call filter logics have not applied, conditional route is evaluated.

\end{itemize}

\begin{notice}{attention}{Attention:}
Conditional route is not intended as an external call filter
replacement. Filter is evaluated first, conditional route afterwards.
\end{notice}


\subsubsection{Friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/index:friends}\label{administration_portal/client/vpbx/routing_endpoints/friends/index::doc}
\textbf{Friends} section in the \textbf{Client configuration} allows interconnection of
IvozProvider with other SIP PBX systems through a SIP \emph{trunk}. The most typical
use case is when a client have multiple PBX systems that want to integrate in
a single flow.

Since 2.10, \textbf{Friends} also lets a vPBX client to call to extensions of another
vPBX client in the same brand.

\begin{notice}{warning}{Warning:}
It's important to understand the difference between \textbf{Carrier}
defined by the \textbf{brand operator} to connect with the public network
and \textbf{Friends}, defined by \textbf{client administrators} to connect the
system with other PBXs.
\end{notice}

\begin{notice}{hint}{Hint:}
\textbf{Friends} are so similar to \textbf{Users} that both talk SIP with the
{\hyperref[administration_portal/platform/infrastructure/proxy_users:proxyusers]{\sphinxcrossref{\DUrole{std,std-ref}{Proxy Users}}}}.
\end{notice}


\paragraph{Types of friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/index:types-of-friends}
There are 2 main types of Friends:
\begin{itemize}
\item {} 
\textbf{Remote friends}: SIP trunks to external SIP PBX system.

\item {} 
\textbf{Internal friends}: connection between extensions of two vPBX client in the same brand.

\end{itemize}

Following sections explain both kind of friends:


\subparagraph{Remote friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:remote-friends}\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends::doc}
Remote friends connect a vPBX client with an external SIP entity.


\subparagraph{Types of remote friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:types-of-remote-friends}
There are 2 main types of SIP PBX that can be integrate with IvozProvider:
\begin{itemize}
\item {} 
\textbf{Direct connection PBX} (Connectivity mode: direct): IvozProvider must be able to talk SIP directly with
this kind of friends by just redirecting the traffic to the proper port of
the public IP address of the PBX.

\item {} 
\textbf{PBX behind NAT} (Connectivity mode: register): Not directly accessible. This kind of PBX must register at
IvozProvider (just like all the {\hyperref[administration_portal/client/vpbx/terminals:terminals]{\sphinxcrossref{\DUrole{std,std-ref}{Terminals}}}} do).

\end{itemize}


\subparagraph{What do remote friends allow?}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:what-do-remote-friends-allow}
This section allows not just communication between users at boths ends of the
SIP \emph{trunk}, but also:
\begin{itemize}
\item {} 
Users ``from the other side'' can call to the public network just like native
Ivozprovider {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{Users}}}}.

\item {} 
Public network calls can be routed to the other SIP \emph{trunk} end.

\end{itemize}


\subparagraph{What kind of calls can be routed through a \emph{remote friend}?}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:what-kind-of-calls-can-be-routed-through-a-remote-friend}
IvozProvider must know what calls must be routed to the different defined \emph{friends} (both internal and remote friends).
For that, \textbf{client administrator} will configure regular expressions that
describe the numbers that \emph{can be reached} through the \textbf{friend}.

\begin{notice}{note}{Note:}
Internal {\hyperref[administration_portal/client/vpbx/extensions:extensions]{\sphinxcrossref{\DUrole{std,std-ref}{extensions}}}} have priority over any expression
defined in the \emph{friends}.
\end{notice}

To sum up, IvozProvider will route a call received by a {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{user}}}} or
a {\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/index:friends]{\sphinxcrossref{\DUrole{std,std-ref}{friend}}}} following this logic:
\begin{enumerate}
\item {} 
Destination matches an existing IvozProvider extension?

\item {} 
If not: Destination matches any \emph{friend} regular expression?

\item {} 
If not: This is an external call.

\end{enumerate}

\begin{notice}{important}{Important:}
Avoid PCRE regular expressions in friend configuration: use {[}0-9{]} instead of \textbackslash{}d.
\end{notice}


\subparagraph{Configuration of remote friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:configuration-of-remote-friends}
The \textbf{Friend} configuration is a merge between a \textbf{User} and a \textbf{Terminal}

These are the configurable settings of \emph{friends}:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-name}
Name of the \textbf{friend}, like in \textbf{Terminals}. This will also be used
in SIP messages (sent \textbf{From User}).

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-description}
Optional. Extra information for this \textbf{friend}.

\item[{Priority\index{Priority|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-priority}
Used to solve conflicts while routing calls through \textbf{friends}.
If a call destination \textbf{matches} more than one friend regular expression
the call will be routed through the friend with \textbf{less priority value}.

\item[{Password\index{Password|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-password}
When the \emph{friend} send requests, IvozProvider will authenticate it using
this password. Like in terminals \textbf{using password IS A MUST}.

\item[{Connectivity mode\index{Connectivity mode|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-connectivity-mode}
Choose between ``Direct'' and ``Register'' for a remote friend.

\item[{Call ACL\index{Call ACL|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-call-acl}
Similar to {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{internal users}}}}, friends can place internal
client calls without restriction (including Extension or other Friends).
When calling to external numbers, this ACL will be checked if set.

\item[{Fallback Outgoing DDI\index{Fallback Outgoing DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-fallback-outgoing-ddi}
External calls from this \emph{friend} will be presented with this DDI, \textbf{unless
the source presented by friend is a DDI that exists in DDIs section}.

\item[{Country and Area code\index{Country and Area code|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-country-and-area-code}
Used for number transformation from and to this friend.

\item[{Allowed codecs\index{Allowed codecs|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-allowed-codecs}
Like a terminal, \emph{friends} will talk the selected codec.

\item[{From domain\index{From domain|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-from-domain}
Request from IvozProvider to this friend will include this domain in
the From header.

\item[{DDI In\index{DDI In|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-ddi-in}
If set to `Yes', use endpoint username in R-URI when calling this friend. If set to `No', use called
number instead.

\item[{Enable T.38 passthrough\index{Enable T.38 passthrough|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:term-enable-t-38-passthrough}
If set to `yes', this SIP endpoint must be a \textbf{T.38 capable fax sender/receiver}. IvozProvider
application servers will act as T.38 gateways, routing calls through a T.38 capable carrier and
bridging signalling and media from one to another. See {\hyperref[security_and_maintenance/security/firewall:firewall]{\sphinxcrossref{\DUrole{std,std-ref}{Firewall}}}} for port exposing concerns
related to this kind of traffic.

\end{description}

\begin{notice}{note}{Note:}
Calls to \emph{friends} are considered internal. That means that ACLs won't
be checked when calling a friend, no matter if the origin of the call
is a user or another friend.
\end{notice}


\subparagraph{Asterisk as a remote friend}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:asterisk-as-a-remote-friend}
At the other end of a friend can be any kind of SIP entity. This section takes
as example an Asterisk PBX system using SIP channel driver that wants to connect
to IvozProvider.
\paragraph{register}

If the system can not be directly access, Asterisk will have to register in the
platform (like a terminal will do).

Configuration will be something like this:

\begin{Verbatim}[commandchars=\\\{\}]
register =\PYGZgt{} friendName:friendPassword@ivozprovider\PYGZhy{}client.sip\PYGZhy{}domain.com
\end{Verbatim}
\paragraph{peer}

\begin{Verbatim}[commandchars=\\\{\}]
[friendName]
type=peer
host=ivozprovider\PYGZhy{}client.sip\PYGZhy{}domain.com
context=XXXXXX
disallow=all
allow=alaw
defaultuser=friendName
secret=friendPassword
fromuser=friendName
fromdomain=ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
insecure=port,invite
sendrpid=pai
directmedia=no
\end{Verbatim}

\begin{notice}{warning}{Warning:}
\emph{Friends}, like terminals, MUST NOT challenge IvozProvider. That's
why the \emph{insecure} setting is used here.
\end{notice}

\begin{notice}{note}{Note:}
As from username is used to identify the friend, P-Asserted-Identity must be used to specify caller number.
\end{notice}


\subparagraph{Summary of remote friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:summary-of-remote-friends}
The key point is understanding that a \emph{remote friend} has a direct relation with the
extension-user-terminal trio:
\begin{itemize}
\item {} 
Can place calls to all internal extensions and other friends.

\item {} 
Can place external calls that its ACL allows

\item {} 
Display their configured outgoing DDI when calling to external entities

\item {} 
Never challenge IvozProvider requests (don't request authentication on received requests)

\item {} 
Answers IvozProvider authentication challenges (All request from them to
IvozProvider must be authenticated for security reasons)

\item {} 
Only connects with \emph{Users SIP Proxy}, like terminals. In fact, SIP traffic from
friends are identical to any other user terminal traffic in format.

\end{itemize}


\subparagraph{Internal friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends::doc}\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:internal-friends}
Internal friends allows a vPBX client to call to \textbf{Extensions} of another vPBX client in the same brand.

\begin{notice}{important}{Important:}
Only extensions in {\hyperref[administration_portal/client/vpbx/extensions:extensions]{\sphinxcrossref{\DUrole{std,std-ref}{Extensions}}}} section.
\end{notice}

If calling to an extension in another vPBX causes an external call, it is allowed:
\begin{itemize}
\item {} 
Calling to a user with an external call forwarding settings.

\item {} 
Calling to an extension routed to an external number.

\item {} 
Calling to an extension routed to a IVR with an option pointing an external number.

\item {} 
Etc.

\end{itemize}


\subparagraph{What kind of calls can be routed through an \emph{internal friend}?}
\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:what-kind-of-calls-can-be-routed-through-an-internal-friend}
IvozProvider must know what calls must be routed to the different defined \emph{friends} (both internal and remote friends).
For that, \textbf{client administrator} will configure regular expressions that
describe the numbers that \emph{can be reached} through the \textbf{internal friend}.

\begin{notice}{note}{Note:}
Internal {\hyperref[administration_portal/client/vpbx/extensions:extensions]{\sphinxcrossref{\DUrole{std,std-ref}{extensions}}}} have priority over any expression
defined in the \emph{friends}.
\end{notice}

To sum up, IvozProvider will route a call received by a {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{user}}}} or
a {\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/index:friends]{\sphinxcrossref{\DUrole{std,std-ref}{friend}}}} following this logic:
\begin{enumerate}
\item {} 
Destination matches an existing IvozProvider extension?

\item {} 
If not: Destination matches any \emph{friend} regular expression?

\item {} 
If not: This is an external call.

\end{enumerate}

\begin{notice}{important}{Important:}
Avoid PCRE regular expressions in friend configuration: use {[}0-9{]} instead of \textbackslash{}d.
\end{notice}


\subparagraph{Configuration of internal friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:configuration-of-internal-friends}
These are the configurable settings of \emph{internal friends}:
\begin{description}
\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:term-description}
Optional. Extra information for this \textbf{friend}.

\item[{Priority\index{Priority|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:term-priority}
Used to solve conflicts while routing calls through \textbf{friends}.
If a call destination \textbf{matches} more than one friend regular expression
the call will be routed through the friend with \textbf{less priority value}.

\item[{Connectivity mode\index{Connectivity mode|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:term-connectivity-mode}
Choose ``IntervPBX'' for internal friends.

\item[{Target Client\index{Target Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:term-target-client}
vPBX client inside the same brand you want to connect.

\item[{Fallback Outgoing DDI\index{Fallback Outgoing DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:term-fallback-outgoing-ddi}
If called extension causes an external call, this DDI will be used as source number.

\end{description}

\begin{notice}{note}{Note:}
Calls to \emph{friends} are considered internal. That means that ACLs won't
be checked when calling a friend, no matter if the origin of the call
is a user or another friend.
\end{notice}


\subparagraph{Summary of internal friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:summary-of-internal-friends}
These are key points to understand \emph{internal friends}:
\begin{itemize}
\item {} 
They have been designed to allow users from a vPBX to call to extensions (normally users)
of another vPBX of the same brand.

\item {} 
Usually they will allow user-user calls.

\item {} 
You cannot use an internal friend to generate external calls paid by the other client.

\item {} 
But external calls may happen if extensions are pointed to external numbers (controlled external calls).

\end{itemize}


\subsubsection{Conference rooms}
\label{administration_portal/client/vpbx/routing_endpoints/conference_rooms::doc}\label{administration_portal/client/vpbx/routing_endpoints/conference_rooms:conference-rooms}\label{administration_portal/client/vpbx/routing_endpoints/conference_rooms:id1}
IvozProvider supports Conference rooms that can be configured in the section
\textbf{Client configuration} \textgreater{} \textbf{Conference rooms}.

\textbf{In distributed installations} using Conferences is only compatible with an static
assignment or `hash based' distribution (see \textbf{Distribute method} {\hyperref[administration_portal/brand/clients/virtual_pbx:virtual\string-pbx]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}).

\begin{notice}{hint}{Hint:}
Brand operators can choose which Clients have conferences (see \textbf{Features}
in {\hyperref[getting_started/internal_calls/brand_portal:brand\string-configuration]{\sphinxcrossref{\DUrole{std,std-ref}{Brand Configuration}}}} and {\hyperref[getting_started/internal_calls/client_portal:client\string-configuration]{\sphinxcrossref{\DUrole{std,std-ref}{Client Configuration}}}}).
\end{notice}
\paragraph{Create a new audio conference}

The following image shows the process of creating a new conference room:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/conference_rooms:term-name}
Name that will used to identify this conference room in other sections

\item[{Max members\index{Max members|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/conference_rooms:term-max-members}
Maximum number of participants in the conference. When this limit is
reached, join requests will be rejected.

\item[{Pin protected\index{Pin protected|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/conference_rooms:term-pin-protected}
Conference rooms can be pin protected. The pin will be requested before
entering and must be numeric.

\end{description}

\begin{notice}{note}{Note:}
Member limit can be disabled by setting it to 0.
\end{notice}
\paragraph{Route an extension or DDI to the conference}

In order to enter a conference there must be a number that is route to them:

In the following section we will see how to configure a {\hyperref[administration_portal/client/vpbx/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{external DDI}}}} to a conference room so it can be used by external callers.

\begin{notice}{hint}{Hint:}
There are other ways to make external callers join a conference room
without using a DDI: it can be assigned to an Extension. This way, any user
can transfer the call to the conference extension, or can be routed, for
example using an IVR entry.
\end{notice}


\subsection{Routing tools}
\label{administration_portal/client/vpbx/routing_tools/index::doc}\label{administration_portal/client/vpbx/routing_tools/index:routing-tools}
Sections in this group are used to modify the routing policy of calls:


\subsubsection{External call filters}
\label{administration_portal/client/vpbx/routing_tools/external_call_filters:external-call-filters}\label{administration_portal/client/vpbx/routing_tools/external_call_filters:external-filters}\label{administration_portal/client/vpbx/routing_tools/external_call_filters::doc}
One of the most common task a client's administrator will do is to
configure schedules and calendars to apply to existing {\hyperref[administration_portal/client/vpbx/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{DDIs}}}}.

Once we have our new created {\hyperref[administration_portal/client/vpbx/routing_tools/schedules:schedules]{\sphinxcrossref{\DUrole{std,std-ref}{Schedules}}}} and {\hyperref[administration_portal/client/vpbx/routing_tools/calendars:calendars]{\sphinxcrossref{\DUrole{std,std-ref}{Calendars}}}}, it's time to apply them
in what we call \textbf{External call filter}.

The client admin can configure them in the following screen:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:term-name}
Descriptive name that will reference this filter in DDIs configuration.

\item[{Welcome locution\index{Welcome locution|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:term-welcome-locution}
This locution will be played if the call is not going to be
forwarded by out of schedule or holiday filtering (in other words if
the normal routing of the DDI is going to be applied).

\item[{Black list\index{Black list|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:term-black-list}
External origin will be checked against the associated {\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}},
if a coincidence is found, the call will be rejected immediately.

\item[{White list\index{White list|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:term-white-list}
External origin will be checked against the associated {\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}},
if a coincidence is found, the call will be directly routed to the DDI
destination, skipping the filter process. Take into account that black
listed are checked before white lists.

\item[{Holiday locution\index{Holiday locution|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:term-holiday-locution}
The locution will be  played when the day is marked as holiday in any
of the calendars associated with the filter \textbf{if the calendar entry has
no locution} for that day.

\item[{Holiday forward type\index{Holiday forward type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:term-holiday-forward-type}
After playing the above locution (if configured), call can be forwarded
to a voicemail, external number or internal extension. For example, the
filter of the image will redirect calls during holidays to the external
number 676 676 676.

\item[{Out of schedule locution\index{Out of schedule locution|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:term-out-of-schedule-locution}
The locution will be played when, not being holiday, the current time
is not in any of the time gaps defined in the schedules assigned to the
filter.

\item[{Out of schedule forward type\index{Out of schedule forward type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:term-out-of-schedule-forward-type}
Like in the holidays forward, but for out of schedule. The image above
won't apply any forward (and the call will be hung up).

\item[{Calendars\index{Calendars|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:term-calendars}
One or more calendars can be associated with the filter. The combination
of all the calendars will be applied.

\item[{Schedules\index{Schedules|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:term-schedules}
One or more schedules can be applied. The combination of all the time
gaps defined in the schedules will be applied.

\end{description}

\begin{notice}{attention}{Attention:}
Holidays are processed \textbf{before} out of schedule events.
\end{notice}

In the next section we will use this new created filter with
{\hyperref[administration_portal/client/vpbx/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{DDIs}}}} so we can configure a welcome locution for normal days,
and especial behaviours for holidays and out of schedule events.


\subsubsection{Calendars}
\label{administration_portal/client/vpbx/routing_tools/calendars:calendars}\label{administration_portal/client/vpbx/routing_tools/calendars::doc}
Calenders are used to define what days are considered as holiday. Like
schedules, multiples calendars can be combined.

Let's imagine three calendars with the following configuration:

Calendar creation process only requires a name. Once created, we can add what
days will be holidays using the buttons in its row:

From this moment on, the calendar has the 1st of January of 2016 as holiday
date with the locution ``Happy New Year''.
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/calendars:term-name}
Unique name to identify this holiday date

\item[{Locution\index{Locution|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/calendars:term-locution}
Override default External call filter holiday locution

\item[{Event Date\index{Event Date|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/calendars:term-event-date}
Day of the calendar to be marked as holiday

\item[{Whole day event\index{Whole day event|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/calendars:term-whole-day-event}
Enable this to create an event that lasts all the day

\item[{Time In/Time out\index{Time In/Time out|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/calendars:term-time-in-time-out}
For not whole day events, specify the time interval the event will be active

\item[{Routing options\index{Routing options|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/calendars:term-routing-options}
Override default External call filter holiday routing

\end{description}

\begin{notice}{warning}{Warning:}
Calendars logic is opposite to Schedulers: If a day is not defined
as holiday in any of the calendars, it will considered a normal day and no
filtering will be applied.
\end{notice}

\begin{notice}{hint}{Hint:}
Holidays without special locutions will apply the external call filter
holiday locution.
\end{notice}

\begin{notice}{hint}{Hint:}
Holidays without special routing will apply the external call filter
holiday routing.
\end{notice}


\subsubsection{Schedules}
\label{administration_portal/client/vpbx/routing_tools/schedules::doc}\label{administration_portal/client/vpbx/routing_tools/schedules:schedules}
The section \textbf{Client configuration} \textgreater{} \textbf{Schedule} allows to configure
different time gaps when an {\hyperref[administration_portal/client/vpbx/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{external DDI}}}} will be available.

The screen displayed to the client administrator looks like this:

With the above configuration, we have defined a morning schedule that will be
applied from Monday to Thursday.

We can also define an afternoon schedule for Monday to Thursday too:

And apply a different time gap for the Fridays:

We have the following time gaps that combined will determine our client
office schedule.

\begin{notice}{warning}{Warning:}
The schedule will be defined by combining the active time gaps:
Any time outside this grouped gaps will be considered out-of-schedule.
\end{notice}


\subsubsection{Match Lists}
\label{administration_portal/client/vpbx/routing_tools/match_lists:match-lists}\label{administration_portal/client/vpbx/routing_tools/match_lists::doc}\label{administration_portal/client/vpbx/routing_tools/match_lists:id1}
Mach Lists are designed to group well known numbers or patterns in order to use
them in specific treatments.

Depending on the section used, this numbers can be matched with the origin or
the destination of the call, so be sure to use distinctive names for your match
lists.

For example, like mentioned in the previous section {\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}},
white and black lists contain one or more match lists. In this case, the
\textbf{origin} of the call will be matched against the list entries to determine if
the treatment of \textbf{skipping} the filter or \textbf{rejecting} the call will be applied.

\begin{notice}{note}{Note:}
Match lists themselves have no behaviour associated, they only provide
a common way for all process to determine if a number has a treatment.
\end{notice}

\begin{notice}{attention}{Attention:}
Beware that numbers of a Match list are checked against origins
or destinations depending on the configuration section that use them.
\end{notice}

The section \textbf{Client configuration} \textgreater{} \textbf{Match Lists} allows to configure
different items that will group the numbers and patterns.

As shown in \textbf{List of Match List Patterns}, a match list can contain specific numbers or groups using
\href{http://php.net/manual/en/reference.pcre.pattern.syntax.php}{Regular Expressions}


\subsubsection{Route locks}
\label{administration_portal/client/vpbx/routing_tools/route_locks:id1}\label{administration_portal/client/vpbx/routing_tools/route_locks::doc}\label{administration_portal/client/vpbx/routing_tools/route_locks:route-locks}
Route locks are a simple but powerful way to fork route logics when delivering calls. This fork is done depending on the
state of the lock on a particular moment:
\begin{itemize}
\item {} 
\textbf{Opened}: green light, go ahead.

\item {} 
\textbf{Closed}: red light, no trespassing allowed.

\end{itemize}

They are used as conditional route rule criteria (see how in {\hyperref[administration_portal/client/vpbx/routing_endpoints/conditional_routes:conditional\string-routes]{\sphinxcrossref{\DUrole{std,std-ref}{Conditional routes}}}}).


\paragraph{Route lock creation}
\label{administration_portal/client/vpbx/routing_tools/route_locks:route-lock-creation}
When you add a new route lock in \textbf{Route Locks} section, you are asked for the following fields:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/route_locks:term-name}
This name will be used in conditional routes to identify the lock.

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/route_locks:term-description}
Just a description.

\item[{Status\index{Status|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_tools/route_locks:term-status}
Set the initial status of the lock: opened or closed.

\end{description}


\paragraph{Route locks service codes}
\label{administration_portal/client/vpbx/routing_tools/route_locks:route-locks-service-codes}
Although you can set the initial lock status on creation and change it using the admin portal too, the usual way to
handle the status changes of a lock is to use the service codes listed in \textbf{Route locks} section.

These services codes have two parts:
\begin{itemize}
\item {} 
\textbf{Service code}: configured in \textbf{Services} section per brand/client.

\item {} 
\textbf{Lock id}: immutable numeric id assigned to each lock.

\end{itemize}

\begin{notice}{tip}{Tip:}
There are 3 service codes available for most common operations on locks:
\begin{itemize}
\item {} 
Open Lock

\item {} 
Close Lock

\item {} 
Toggle Lock.

\end{itemize}

Read {\hyperref[administration_portal/platform/services:services]{\sphinxcrossref{\DUrole{std,std-ref}{Services}}}} for further details.
\end{notice}


\subsection{User configuration}
\label{administration_portal/client/vpbx/user_configuration/index:user-configuration}\label{administration_portal/client/vpbx/user_configuration/index::doc}
This section groups features that may be assigned to users/friends:


\subsubsection{Outgoing DDI Rules}
\label{administration_portal/client/vpbx/user_configuration/outgoing_ddi_rules:outgoing-ddi-rules}\label{administration_portal/client/vpbx/user_configuration/outgoing_ddi_rules:outgoingddi-rules}\label{administration_portal/client/vpbx/user_configuration/outgoing_ddi_rules::doc}
Most calling entities in IvozProvider require an outgoing DDI when placing calls
to external numbers. This includes: Users, Friends, Faxes, Retail Accounts, and
so on..

But there are some cases when a single outgoing DDI is not enough, and the
presented DDI depends on the called number. To archive this dynamic outgoing DDI
selection you can use Outgoing DDI rules.

Before creating a new rule, it would be required to first group the destination
numbers in {\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}}.

For this example, we will create a match list of corporate mobiles with all
the mobile numbers of our client workers. When we call to those numbers, we
will keep the original outgoing DDI assigned to the user, and for the rest of
the cases we will force the DDI to the main client outgoing DDI.
\paragraph{Create a new Outgoing DDI Rule}

The main creation screen defines the action that will take place when no rule
matches the dialed destination, so we define to force the main client DDI here.
\paragraph{Assign rule lists actions}

Now we add a new rule that will match our mobiles to make the user's outgoing
DDI be kept untouched.
\paragraph{Assign rule to callers}

At last, we have to configure who will use this rule to dynamically change it's
presentation number. We can do this in the \textbf{Client's edit screen} or the
\textbf{Users's edit screen}.

In this case, the User will present 777777777 DDI when calling corporate mobiles
and 666666666 when calling the rest of the external numbers.

\begin{notice}{attention}{Attention:}
Current implementation of Outgoing DDI rules won't work for
diverted calls (out of schedule, holidays or user's call forward settings).
\end{notice}


\subsubsection{Pick up groups}
\label{administration_portal/client/vpbx/user_configuration/pick_up_groups:capture-groups}\label{administration_portal/client/vpbx/user_configuration/pick_up_groups:pick-up-groups}\label{administration_portal/client/vpbx/user_configuration/pick_up_groups::doc}
Call pickup is the process where a user can answer a call that is being ringing
in another terminal. No need to say that, somehow (sound, flashing lights,
notification, etc) the users must know that the call is ringing elsewhere.

IvozProvider supports two kind of call pickups:
\begin{description}
\item[{Direct pickup\index{Direct pickup|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/user_configuration/pick_up_groups:term-direct-pickup}
In this type of pickup, the user that is trying to capture the ringing
call must include the extension of the target phone after the service
code. For example, if the direct pickup code is *95, the user must
dial *95101 to capture a call that is ringing in the extension 101.

\item[{Group pickup\index{Group pickup|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/user_configuration/pick_up_groups:term-group-pickup}
In this type of pickup, the user that is trying to capture the ringing
call will just dial the service code. If anyone in any of the pickup
groups of the user has a ringing call, it will be answered by the
capturer.

\end{description}


\paragraph{Call pickup groups}
\label{administration_portal/client/vpbx/user_configuration/pick_up_groups:call-pickup-groups}
In order to make \textbf{call group pickups}, the capturer user must be part of the
same group that the target user that wants to capture.

The section \textbf{Pickup groups} allows the client administrator to configure
what users will be in each group:

As shown in the section {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{Users}}}}, we can add or edit the groups of a user
in the user's edit screen.

\begin{notice}{note}{Note:}
A user can be part of multiple pickup groups. The system will take
all of them into account when using the group pickup service.
\end{notice}


\paragraph{Group pickup service code}
\label{administration_portal/client/vpbx/user_configuration/pick_up_groups:group-pickup-service-code}
IvozProvider supports 2 different configuration levels for defining the service
codes for pickup:
\begin{itemize}
\item {} 
At brand level: \textbf{Brand configuration} \textgreater{} \textbf{Services}.

\item {} 
At client level: \textbf{Client configuration} \textgreater{} \textbf{Services}.

\end{itemize}

The brand administrator can configure generic codes that all the clients will
use. Clients can customize this codes if they are used to another ones.

The {\hyperref[administration_portal/platform/services:services]{\sphinxcrossref{\DUrole{std,std-ref}{following section}}}} explains the services in depth, with
all the additional services that can be accessed by dialing codes starting with
*.


\subsubsection{Call ACLs}
\label{administration_portal/client/vpbx/user_configuration/call_acls:call-permissions}\label{administration_portal/client/vpbx/user_configuration/call_acls::doc}\label{administration_portal/client/vpbx/user_configuration/call_acls:call-acls}
The \textbf{Call ACLs} determines what users can call to external numbers.

\begin{notice}{attention}{Attention:}
The internal extensions (the ones listed in {\hyperref[administration_portal/client/vpbx/extensions:extensions]{\sphinxcrossref{\DUrole{std,std-ref}{Extensions}}}}) are allowed to all users, the \textbf{Call
ACLs only apply to external numbers}. Calls to friends extensions are considered internal too, no call ACL is needed.
\end{notice}

The \textbf{Call ACL} setup has two different parts:
\begin{itemize}
\item {} 
Classify the call in different types based on \textbf{match lists}:
\begin{itemize}
\item {} 
Brand level: \textbf{Brand Configuration} \textgreater{} \textbf{Generic Match Lists}

\item {} 
Client level: \textbf{Client Configuration} \textgreater{} \textbf{Match Lists}

\end{itemize}

\item {} 
Choose policies for groups of patterns: \textbf{Client Configuration} \textgreater{} \textbf{Call
ACLs}

\end{itemize}


\paragraph{Call ACL Matchlists}
\label{administration_portal/client/vpbx/user_configuration/call_acls:call-acl-matchlists}
The destination number is matched against the \textbf{ACL MatchLists} to determine
the call permission.

\begin{notice}{note}{Note:}
Brand matchlists can be used by any of its clients, so most common
ACL Patterns (p.e. country prefixes) can be reused easily.
\end{notice}

For more information of how MatchLists patterns are created, please refer to section
{\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}}.

\begin{notice}{attention}{Attention:}
\textbf{Regular expressions of Match List patterns must be in E.164 format}.
\end{notice}


\paragraph{Call ACL}
\label{administration_portal/client/vpbx/user_configuration/call_acls:call-acl}
When a new \textbf{Call ACL} is created, these two fields turn up:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/user_configuration/call_acls:term-name}
Used to reference this Call ACL.

\item[{Default policy\index{Default policy|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/user_configuration/call_acls:term-default-policy}
If no rule matches, this ACL will deny the call or allow it?

\end{description}

After creating the \textbf{Call ACL} we can edit it to add the required rules:
\begin{itemize}
\item {} 
Rules to deny some specific destinations.

\item {} 
Rules to allow some specific destinations.

\end{itemize}

\begin{notice}{note}{Note:}
The \textbf{metric} determines the evaluation order of the rules.
\end{notice}


\subparagraph{Assign Call ACLs}
\label{administration_portal/client/vpbx/user_configuration/call_acls:assign-call-acls}
Created \emph{Call ACLs} can be assigned to:
\begin{itemize}
\item {} 
Friends through \emph{Call ACL} parameter.

\item {} 
Users through \emph{Call ACL} parameter.

\end{itemize}


\subsection{Multimedia}
\label{administration_portal/client/vpbx/multimedia/index:multimedia}\label{administration_portal/client/vpbx/multimedia/index::doc}
This two sections involve media files:


\subsubsection{Locutions}
\label{administration_portal/client/vpbx/multimedia/locutions:locutions}\label{administration_portal/client/vpbx/multimedia/locutions::doc}
The locutions of the platform are created and uploaded just like the files of
{\hyperref[administration_portal/client/vpbx/multimedia/music_on_hold:musiconhold]{\sphinxcrossref{\DUrole{std,std-ref}{Music on Hold}}}}.

The section \textbf{Client configuration} \textgreater{} \textbf{Locutions}  allows the client admin
to choose the sounds that will be played in many configuration places (IVR, etc)
accross the platform.

\begin{notice}{attention}{Attention:}
Locutions can be recorded from any terminal by dialing the
Recording extension displayed in their edit screen.
\end{notice}

\begin{notice}{hint}{Hint:}
The main difference between a \textbf{locution} and \textbf{music on hold} is
that the administrator chooses when the first one will be played (out of
schedule, IVRs, and so on) and the second one will be played when a call is
held by an user.
\end{notice}


\subsubsection{Music on Hold}
\label{administration_portal/client/vpbx/multimedia/music_on_hold:music-on-hold}\label{administration_portal/client/vpbx/multimedia/music_on_hold::doc}\label{administration_portal/client/vpbx/multimedia/music_on_hold:musiconhold}
The music on hold will be played when the user holds the call and the other
member waits until the call is resumed.

If a client has defined a music on hold, it will be played. Otherwise, the
one defined by the brand administrator. If none of this is configured, a global
music will be played.

\begin{notice}{note}{Note:}
Multiple files can be added to be played as Music on Hold. The system
will choose them randomly for each call.
\end{notice}
\paragraph{Add a new music on hold}

Once the music has been \emph{encoded} the \textbf{Status} fill will display \emph{ready} and
the music will be used for the next calls.

\begin{notice}{tip}{Tip:}
IvozProvider supports most of the common audio formats and \emph{encodes}
them to the optimal format for the platform.
\end{notice}

After the \emph{encoding}, we can download both the original and the converted
version in the edit screen.


\subsection{Faxes}
\label{administration_portal/client/vpbx/faxes:faxes}\label{administration_portal/client/vpbx/faxes::doc}\label{administration_portal/client/vpbx/faxes:faxing-system}
IvozProvider includes a simple but efficient \emph{virtual faxing} solution that allows:
\begin{itemize}
\item {} 
Sending PDF files via Fax.

\item {} 
Receiving faxes through email or check them through the web portal.

\end{itemize}

\begin{notice}{error}{Error:}
IvozProvider uses
\href{http://www.voip-info.org/wiki/view/T.38}{T.38} for both sending and receiving
faxes. Brand Operator must use \emph{peering contracts} that have support for it.
\end{notice}


\subsubsection{Creating a virtual fax}
\label{administration_portal/client/vpbx/faxes:creating-a-virtual-fax}
These are the fields that turn up when we create a new fax:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/faxes:term-name}
Used by remaining section to reference a fax

\item[{Email\index{Email|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/faxes:term-email}
Email address when we want to receive incoming faxes (if we check `Send
by email')

\item[{Outbound DDI\index{Outbound DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/faxes:term-outbound-ddi}
DDI used as source number for outgoing faxes

\end{description}

To receive faxes in this DDI, we need to point it to our new fax in the section
\textbf{DDIs}.

Brand Operator can choose one or more {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}} for sending faxes.

\begin{notice}{note}{Note:}
\emph{load-balancing} y \emph{failover} logics described in {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}}
apply to faxes too.
\end{notice}

\begin{notice}{important}{Important:}
If no fax-specific route is defined, faxes will be routed using
standard call routes.
\end{notice}


\subsubsection{Sending a fax}
\label{administration_portal/client/vpbx/faxes:sending-a-fax}
Sending a fax is an easy task that is done through \textbf{List of outgoing faxfiles} subsection.

First, we upload de PDF file and set the destination. When we save the entry, the list shows the fax and its status.


\subsubsection{Incoming faxes display}
\label{administration_portal/client/vpbx/faxes:incoming-faxes-display}
Apart from being received by mail, faxes can be watched and downloaded within
the web portal too in \textbf{List of incoming faxfiles} subsection.


\subsection{Services}
\label{administration_portal/client/vpbx/services:services}\label{administration_portal/client/vpbx/services:client-services}\label{administration_portal/client/vpbx/services::doc}
\begin{notice}{danger}{Danger:}
Services defined in this section \textbf{are not accessible during a
conversation}. They are activated by \textbf{calling the codes}, not using
DTMF codes while talking.
\end{notice}

Each client can \emph{customize} the default values assigned by the \emph{brand operator}
using the section \textbf{Client configuration} \textgreater{} \textbf{Services} and changing the codes
listed there.

\begin{notice}{hint}{Hint:}
Services deleted by the \emph{client admin} will not available to users.
\end{notice}


\subsection{Rating profiles}
\label{administration_portal/client/vpbx/rating_profiles:rating-profiles}\label{administration_portal/client/vpbx/rating_profiles::doc}
This section allows the client to:
\begin{itemize}
\item {} 
See the list of rating plans and their activation time.

\item {} 
Download a CSV with each rating plan.

\item {} 
Simulate a call and guess the cost of a given call.

\end{itemize}


\subsection{Calls}
\label{administration_portal/client/vpbx/calls/index::doc}\label{administration_portal/client/vpbx/calls/index:calls}
These are the call-list sections for vPBX clients:


\subsubsection{Call registry}
\label{administration_portal/client/vpbx/calls/call_registry::doc}\label{administration_portal/client/vpbx/calls/call_registry:call-registry}\label{administration_portal/client/vpbx/calls/call_registry:id1}
Lists all the calls of the client, even those that do not imply cost.

\begin{notice}{note}{Note:}
\href{https://es.wikipedia.org/wiki/CSV}{CSV} export makes possible to
download the list for its later analysis.
\end{notice}


\subsubsection{External calls}
\label{administration_portal/client/vpbx/calls/external_calls:id1}\label{administration_portal/client/vpbx/calls/external_calls::doc}\label{administration_portal/client/vpbx/calls/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{description}
\item[{Start time\index{Start time|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-start-time}
Date and time of the call establishment.

\item[{Brand\index{Brand|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-brand}
Only visible for \emph{god}, shows the brand of each call.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-client}
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller\index{Caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-caller}
DDI presented for the outgoing call.

\item[{Callee\index{Callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-callee}
External number dialed.

\item[{Duration\index{Duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-duration}
Shows how long the call lasted.

\item[{Price\index{Price|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-price}
The money amount for the client.

\item[{Cost\index{Cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-cost}
The money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan\index{Rating Plan|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-rating-plan}
Rating plan used to set price for the call.

\item[{Destination\index{Destination|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-destination}
Destination that matched the call for billing.

\item[{Carrier\index{Carrier|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-carrier}
Shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for
each call.

\item[{Invoice\index{Invoice|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-invoice}
Shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID\index{Call ID|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-call-id}
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type\index{Endpoint Type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-endpoint-type}
For retail client calls, shows ``RetailAccount''. Empty for remaining client types.

\item[{Endpoint Id\index{Endpoint Id|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/external_calls:term-endpoint-id}
For retail client calls, shows the retail account's id of the call. Empty for remaining client types.

\end{description}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\paragraph{Call rerating}
\label{administration_portal/client/vpbx/calls/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\subsubsection{Call CSV schedulers}
\label{administration_portal/client/vpbx/calls/call_csv_schedulers:call-csv-schedulers}\label{administration_portal/client/vpbx/calls/call_csv_schedulers::doc}
This section allows programming the automatic periodical creation of CSV reports to:
\begin{itemize}
\item {} 
Clients (no matter type).

\item {} 
Brand operators.

\end{itemize}

\begin{notice}{note}{Note:}
This section is almost identical to {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} except to the
fields that do not apply to CSVs (Invoice number sequence, Tax rate...)
\end{notice}

\begin{notice}{tip}{Tip:}
Brand operators can schedule a CSV containing calls of all its clients.
In this kind of schedules, a notification template can be chosen. In remaining
schedules, the notification template assigned to the specific client will be used.
\end{notice}

When adding a new definition, these fields are shown:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-name}
Name of the scheduled Call CSV

\item[{Call direction:\index{Call direction:|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-call-direction}
Which kind of calls should be included: Inbound, outbound or both.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-client}
Which client calls should be included

\item[{Email\index{Email|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-email}
Send generated Call CSV via email. Empty if no automatic mail is wanted.

\item[{Notification template:\index{Notification template:|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-notification-template}
Used on email notifications

\item[{Frequency/Unit\index{Frequency/Unit|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-frequency-unit}
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\end{description}

Once created, some new fields and subsections are accesible:
\begin{itemize}
\item {} 
Next execution date.

\item {} 
Last execution date and result (success/error).

\item {} 
Generated CSVs in \textbf{List of Call CSV reports}.

\end{itemize}

\begin{notice}{tip}{Tip:}
Brand operator can generate CSV containing calls of all clients.
\end{notice}


\paragraph{CSV fields}
\label{administration_portal/client/vpbx/calls/call_csv_schedulers:csv-fields}
These are the fields of the generated CSV files:
\begin{description}
\item[{callid\index{callid|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-callid}
Call-ID of the SIP dialog

\item[{startTime\index{startTime|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-starttime}
Time and date of the call establishment

\item[{duration\index{duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-duration}
Call duration in seconds

\item[{caller\index{caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-caller}
Caller number in E.164 format (with `+')

\item[{callee\index{callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-callee}
Callee number in E.164 format (with `+')

\item[{price\index{price|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-price}
Calculated price for the given call

\item[{direction\index{direction|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-direction}
call direction

\end{description}

In Brand CSVs, these additional fields will be included too:
\begin{description}
\item[{endpointType\index{endpointType|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-endpointtype}
`RetailAccount' for retail clients, empty for remaining types.

\item[{endpointId\index{endpointId|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-endpointid}
Retail Account ID for retail clients, empty for remaining types.

\item[{cost\index{cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-cost}
Calculated cost for the given call

\item[{companyId\index{companyId|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/calls/call_csv_schedulers:term-companyid}
Client ID

\end{description}


\subsubsection{Call recordings}
\label{administration_portal/client/vpbx/calls/call_recordings::doc}\label{administration_portal/client/vpbx/calls/call_recordings:call-recordings}\label{administration_portal/client/vpbx/calls/call_recordings:id1}
\begin{notice}{attention}{Attention:}
Beware that local legislation may enforce to announce that the
call is being recorded (sometimes to both parties). You should include
a recording disclaimer in your welcome locutions for DDIs with automatic
recording enabled.
\end{notice}

IvozProvider supports two different ways of recording calls:
\begin{itemize}
\item {} 
\textbf{Automatic recordings} for the incoming/outgoing calls that use a
{\hyperref[administration_portal/client/vpbx/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{External DDI}}}}.

\item {} 
\textbf{On demand recordings} requested by a user during a call.

\end{itemize}


\paragraph{Automatic DDI recordings}
\label{administration_portal/client/vpbx/calls/call_recordings:automatic-ddi-recordings}
In this type of recording, \textbf{the whole conversation will be recorded}: from
the start until it finishes.

Two different scenarios:
\begin{itemize}
\item {} 
\textbf{Incoming calls to a DDI}: The call will continue until the external
dialer hangups (no matter whom is talking to).

\item {} 
\textbf{Outgoing calls using a DDI} as {\hyperref[administration_portal/client/vpbx/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing DDI}}}}: the
recording will continue as long as the external destination keeps in the
conversation.

\end{itemize}

\begin{notice}{attention}{Attention:}
Take into account that the call will be recorded while the
external entity is present, even it the call is being transferred between
multiple users of the platform.
\end{notice}
\paragraph{Record all the calls of a DDI}

To enable this feature, edit the DDI and configure the field under the section
recording data:

There are 4 available options:
\begin{itemize}
\item {} 
Disable recordings

\item {} 
Enable incoming recordings

\item {} 
Enable outgoing recordings

\item {} 
Enable all call recordings

\end{itemize}


\paragraph{On demand recordings}
\label{administration_portal/client/vpbx/calls/call_recordings:on-demand-recordings}
The \emph{on-demand} recordings must be enabled by the \emph{brand administrator} for the
clients that request it. This can be done in the client edit screen:

\begin{notice}{warning}{Warning:}
Contrary to the {\hyperref[administration_portal/platform/services:services]{\sphinxcrossref{\DUrole{std,std-ref}{Services}}}} mentioned in the
previous section, the on demand record are activated within a conversation.
\end{notice}

Contrary to automatic ones, on demand recording can be stopped using the same
process that started them.


\subparagraph{Activated using the \emph{Record} key}
\label{administration_portal/client/vpbx/calls/call_recordings:activated-using-the-record-key}
Some terminals (for example, \emph{Yealink}) support sending a \href{https://tools.ietf.org/html/rfc6086}{SIP INFO} message during the conversation with a
special \emph{Record} header (see \href{http://www.yealink.com/Upload/document/UsingCallRecordingFeatureonYealinkPhones/UsingCallRecordingFeatureonYealinkSIPT2XPphonesRev\_610-20561729764.pdf}{reference}).
This is not a standard for the protocol, but being Yealink one of the supported
manufacturers of the solution, we include this kind of on-demand recording.

\begin{notice}{important}{Important:}
For this recording requests, the configured code doesn't matter
but the client still must have on demand records enabled.
\end{notice}

To start or stop this kind of recordings, just press the Record key in the
terminal and the system will handle the sent message.


\subparagraph{Activated using \emph{DTMF} codes}
\label{administration_portal/client/vpbx/calls/call_recordings:activated-using-dtmf-codes}
The more traditional approach for this feature is to press a combination of
keys during the call. Some notification will be played and the recording will
start or stop. This combination is sent to the system using \href{https://es.wikipedia.org/wiki/Marcaci\%C3\%B3n\_por\_tonos}{DTMF tones} using the same audio
stream that the conversation (as mentioned in \href{https://tools.ietf.org/html/rfc4733}{RFC 4733}).

IvozProvider supports this kind of on demand record activation but with an
important downside. In order to capture this codes, the pbx must process each
audio packet to detect the code, avoiding the direct flow of media between the
final endpoints.

\begin{notice}{important}{Important:}
Enabling this record mode highly affects the performance of the
platform. Use at your own risk.
\end{notice}


\paragraph{Recordings list}
\label{administration_portal/client/vpbx/calls/call_recordings:recordings-list}
The \emph{client administrator} can access to all the recordings in the section
\textbf{Client configuration} \textgreater{} \textbf{Recordings}:

Recordings can be heard from the \emph{web} or downloaded in MP3 format:

If the recording has been started on demand, it will also include the user
that requested it:


\section{Residential Clients}
\label{administration_portal/client/residential/index:residential-clients}\label{administration_portal/client/residential/index::doc}
Residential clients are a special type of client that only provides a connectivity
service with carriers through residential devices.

\begin{notice}{attention}{Attention:}
Contrary to the Virtual PBX clients, all Residential clients use the
brand domain to unequivocally identify their devices. You'll need to configure
Brand's domain to use this feature.
\end{notice}

\begin{notice}{hint}{Hint:}
Residential clients can be enabled per Brand basis via Features.
\end{notice}

The goal of this section will be describe each of the configuration settings
associated with Residential clients included in IvozProvider:


\subsection{Residential devices}
\label{administration_portal/client/residential/residential_devices:id1}\label{administration_portal/client/residential/residential_devices::doc}\label{administration_portal/client/residential/residential_devices:residential-devices}
Residential Devices are the main routable option in Residential clients.
More or less like {\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/index:friends]{\sphinxcrossref{\DUrole{std,std-ref}{Friends}}}} are to Virtual PBX Clients, devices
contain the required configurable options to provide a SIP connectivity
service with IvozProvider and an external SIP entity.

\begin{notice}{warning}{Warning:}
Although both \textbf{Carriers/DDI Providers} and \textbf{Residential Devices} are defined by the
\textbf{brand operator}, the former are designed to connect with the public switched telephony network
while the latter connects the system with our clients' SIP entities.
\end{notice}


\subsubsection{Types of residential devices}
\label{administration_portal/client/residential/residential_devices:types-of-residential-devices}
There are 2 main types of SIP endpoints that can use residential with IvozProvider:
\begin{itemize}
\item {} 
\textbf{Direct connection endpoint}: IvozProvider must be able to talk SIP directly with
this kind of devices by just forwarding the traffic to the proper port of
the public IP address of the PBX.

\item {} 
\textbf{Endpoint behind NAT}: Not directly reachable. This kind of endpoint must register at
IvozProvider (just like all the {\hyperref[administration_portal/client/vpbx/terminals:terminals]{\sphinxcrossref{\DUrole{std,std-ref}{Terminals}}}} do).

\end{itemize}


\subsubsection{What kind of calls can be routed through a \emph{Residential Device}?}
\label{administration_portal/client/residential/residential_devices:what-kind-of-calls-can-be-routed-through-a-residential-device}
Contrary to Friends, \textbf{Residential Devices} have some simplifications and limitations:
\begin{itemize}
\item {} 
Residential Devices only route their assigned DDIs

\item {} 
Residential Devices only place externals calls to Carriers

\item {} 
Residential Devices only receive external calls from DDI Providers

\end{itemize}


\subsubsection{Residential Devices Configuration}
\label{administration_portal/client/residential/residential_devices:residential-devices-configuration}
These are the configurable settings of \emph{Residential devices}:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-name}
Name of the \textbf{residential device}. This name must be unique in the whole brand so
it's recommended to use some kind of sequential identifier. This will also be used
in SIP messages (sent \textbf{From User}).

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-description}
Optional. Extra information for this \emph{residential device}.

\item[{Password\index{Password|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-password}
When the \emph{residential device} send requests, IvozProvider will authenticate it using
this password. Like remaining SIP entities in IvozProvider (except Wholesale) \textbf{using password IS MANDATORY}.

\item[{Direct connectivity\index{Direct connectivity|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-direct-connectivity}
If you choose `Yes' here, you'll have to fill the protocol, address and
port where this \emph{residential device} can be contacted.

\item[{Language\index{Language|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-language}
Locutions will be played in this language

\item[{Numeric transformation\index{Numeric transformation|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-numeric-transformation}
Numeric transformation set that will be applied when communicating with this device.

\item[{Fallback Outgoing DDI\index{Fallback Outgoing DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-fallback-outgoing-ddi}
External calls from this \emph{residential device} will be presented with this DDI, \textbf{unless
the source presented matches a DDI belonging to the residential device}.

\item[{Allowed codec\index{Allowed codec|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-allowed-codec}
Like vPBX terminals, \emph{residential devices} will talk only the selected codec.

\item[{From domain\index{From domain|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-from-domain}
Request from IvozProvider to this device will include this domain in
the From header.

\item[{DDI In\index{DDI In|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-ddi-in}
If set to `Yes', use endpoint username in R-URI when calling this residential device. If set to `No', use called
number instead.

\item[{Max Calls\index{Max Calls|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-max-calls}
Limits the number of concurrent received calls. Set 0 for unlimited calls.

\item[{Enable T.38 passthrough\index{Enable T.38 passthrough|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/residential_devices:term-enable-t-38-passthrough}
If set to `yes', this SIP endpoint must be a \textbf{T.38 capable fax sender/receiver}. IvozProvider
application servers will act as T.38 gateways, routing calls through a T.38 capable carrier and
bridging signalling and media from one to another. See {\hyperref[security_and_maintenance/security/firewall:firewall]{\sphinxcrossref{\DUrole{std,std-ref}{Firewall}}}} for port exposing concerns
related to this kind of traffic.

\end{description}


\subsubsection{Voicemail settings}
\label{administration_portal/client/residential/residential_devices:voicemail-settings}
Every residential device has a voicemail that can be accessed using voicemail service code defined at brand level.


\subsubsection{Call forwarding settings}
\label{administration_portal/client/residential/residential_devices:call-forwarding-settings}
Apart from unconditional call forwarding to external number through {\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-call\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}} applied to DDI,
residential devices may have additional call forwarding settings that allow:
\begin{itemize}
\item {} 
Forwarding to another external number.

\item {} 
Forwarding to voicemail associated to each residential device.

\item {} 
Supported forwarding types: unconditional, no-answer, non-registered, busy.

\end{itemize}

\begin{notice}{warning}{Warning:}
{\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-call\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}} have precedence over residential devices call forwarding settings.
\end{notice}


\subsubsection{Asterisk as a residential device}
\label{administration_portal/client/residential/residential_devices:asterisk-as-a-residential-device}
At the other end of a device can be any kind of SIP entity. This section takes
as example an Asterisk PBX system using SIP channel driver that wants to connect
to IvozProvider.


\paragraph{Device register}
\label{administration_portal/client/residential/residential_devices:device-register}
If the system can not be directly access, Asterisk will have to register in the
platform (like a terminal will do).

Configuration will be something like this:

\begin{Verbatim}[commandchars=\\\{\}]
register =\PYGZgt{} residentialDeviceName:residentialDevicePassword@ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
\end{Verbatim}


\paragraph{Device peer}
\label{administration_portal/client/residential/residential_devices:device-peer}
\begin{Verbatim}[commandchars=\\\{\}]
[residentialDeviceName]
type=peer
host=ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
context=XXXXXX
disallow=all
allow=alaw
defaultuser=residentialDeviceName
secret=residentialDevicePassword
fromuser=residentialDeviceName
fromdomain=ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
insecure=port,invite
sendrpid=pai
directmedia=no
\end{Verbatim}

\begin{notice}{warning}{Warning:}
\emph{Residential devices} MUST NOT challenge IvozProvider. That's
why the \emph{insecure} setting is used here.
\end{notice}

\begin{notice}{note}{Note:}
As from username is used to identify the retail account, P-Asserted-Identity must be used to specify caller number.
\end{notice}


\subsection{DDIs}
\label{administration_portal/client/residential/ddis:ddis}\label{administration_portal/client/residential/ddis:residential-ddis}\label{administration_portal/client/residential/ddis::doc}
DDIs are the external entry point from DDI Providers to Residential Clients that
can be routed through Residential Devices.

We can assign an {\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-call\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}}. Contrary to vPBX External Call filters, Residential DDIs
filters only allow static redirection to another external number.


\subsubsection{Residential DDI routes}
\label{administration_portal/client/residential/ddis:residential-ddi-routes}
Residential DDIs can only be routed to a {\hyperref[administration_portal/client/residential/residential_devices:residential\string-devices]{\sphinxcrossref{\DUrole{std,std-ref}{Residential Devices}}}}
or {\hyperref[administration_portal/client/vpbx/faxes:faxing\string-system]{\sphinxcrossref{\DUrole{std,std-ref}{Virtual Fax}}}}.

\begin{notice}{hint}{Hint:}
Routing a DDI through a Residential device will allow to place external calls
from that device presenting that DDI as origin.
\end{notice}


\subsubsection{Residential Recordings}
\label{administration_portal/client/residential/ddis:residential-recordings}
If Residential Client has \emph{Recordings} feature enabled, DDIs can also record incoming and/or
outgoing calls.


\subsection{External call filters}
\label{administration_portal/client/residential/external_call_filters:external-call-filters}\label{administration_portal/client/residential/external_call_filters:residential-filters}\label{administration_portal/client/residential/external_call_filters::doc}
Residential External Filters can be assigned to DDIs to temporary
forward calls to an external number.


\subsubsection{Filters Configuration}
\label{administration_portal/client/residential/external_call_filters:filters-configuration}
This are the configurable settings of \emph{Residential external filters}:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/external_call_filters:term-name}
Name of the filter.

\item[{Number\index{Number|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/external_call_filters:term-number}
External Destination for this filter.

\end{description}

\begin{notice}{attention}{Attention:}
Calls forwarded by a filter will keep the original
caller identification, adding the forwarding info in a SIP
\emph{Diversion} header.
\end{notice}


\subsection{Faxes}
\label{administration_portal/client/residential/faxes:faxes}\label{administration_portal/client/residential/faxes::doc}\label{administration_portal/client/residential/faxes:faxing-system}
IvozProvider includes a simple but efficient \emph{virtual faxing} solution that allows:
\begin{itemize}
\item {} 
Sending PDF files via Fax.

\item {} 
Receiving faxes through email or check them through the web portal.

\end{itemize}

\begin{notice}{error}{Error:}
IvozProvider uses
\href{http://www.voip-info.org/wiki/view/T.38}{T.38} for both sending and receiving
faxes. Brand Operator must use \emph{peering contracts} that have support for it.
\end{notice}


\subsubsection{Creating a virtual fax}
\label{administration_portal/client/residential/faxes:creating-a-virtual-fax}
These are the fields that turn up when we create a new fax:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/faxes:term-name}
Used by remaining section to reference a fax

\item[{Email\index{Email|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/faxes:term-email}
Email address when we want to receive incoming faxes (if we check `Send
by email')

\item[{Outbound DDI\index{Outbound DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/faxes:term-outbound-ddi}
DDI used as source number for outgoing faxes

\end{description}

To receive faxes in this DDI, we need to point it to our new fax in the section
\textbf{DDIs}.

Brand Operator can choose one or more {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}} for sending faxes.

\begin{notice}{note}{Note:}
\emph{load-balancing} y \emph{failover} logics described in {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}}
apply to faxes too.
\end{notice}

\begin{notice}{important}{Important:}
If no fax-specific route is defined, faxes will be routed using
standard call routes.
\end{notice}


\subsubsection{Sending a fax}
\label{administration_portal/client/residential/faxes:sending-a-fax}
Sending a fax is an easy task that is done through \textbf{List of outgoing faxfiles} subsection.

First, we upload de PDF file and set the destination. When we save the entry, the list shows the fax and its status.


\subsubsection{Incoming faxes display}
\label{administration_portal/client/residential/faxes:incoming-faxes-display}
Apart from being received by mail, faxes can be watched and downloaded within
the web portal too in \textbf{List of incoming faxfiles} subsection.


\subsection{Calls}
\label{administration_portal/client/residential/calls/index::doc}\label{administration_portal/client/residential/calls/index:calls}
These are the call-list sections for residential clients:


\subsubsection{Call registry}
\label{administration_portal/client/residential/calls/call_registry::doc}\label{administration_portal/client/residential/calls/call_registry:call-registry}\label{administration_portal/client/residential/calls/call_registry:id1}
Lists all the calls of the client, even those that do not imply cost.

\begin{notice}{note}{Note:}
\href{https://es.wikipedia.org/wiki/CSV}{CSV} export makes possible to
download the list for its later analysis.
\end{notice}


\subsubsection{External calls}
\label{administration_portal/client/residential/calls/external_calls:id1}\label{administration_portal/client/residential/calls/external_calls::doc}\label{administration_portal/client/residential/calls/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{description}
\item[{Start time\index{Start time|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-start-time}
Date and time of the call establishment.

\item[{Brand\index{Brand|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-brand}
Only visible for \emph{god}, shows the brand of each call.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-client}
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller\index{Caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-caller}
DDI presented for the outgoing call.

\item[{Callee\index{Callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-callee}
External number dialed.

\item[{Duration\index{Duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-duration}
Shows how long the call lasted.

\item[{Price\index{Price|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-price}
The money amount for the client.

\item[{Cost\index{Cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-cost}
The money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan\index{Rating Plan|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-rating-plan}
Rating plan used to set price for the call.

\item[{Destination\index{Destination|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-destination}
Destination that matched the call for billing.

\item[{Carrier\index{Carrier|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-carrier}
Shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for
each call.

\item[{Invoice\index{Invoice|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-invoice}
Shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID\index{Call ID|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-call-id}
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type\index{Endpoint Type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-endpoint-type}
For retail client calls, shows ``RetailAccount''. Empty for remaining client types.

\item[{Endpoint Id\index{Endpoint Id|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/external_calls:term-endpoint-id}
For retail client calls, shows the retail account's id of the call. Empty for remaining client types.

\end{description}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\paragraph{Call rerating}
\label{administration_portal/client/residential/calls/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\subsubsection{Call CSV schedulers}
\label{administration_portal/client/residential/calls/call_csv_schedulers:call-csv-schedulers}\label{administration_portal/client/residential/calls/call_csv_schedulers::doc}
This section allows programming the automatic periodical creation of CSV reports to:
\begin{itemize}
\item {} 
Clients (no matter type).

\item {} 
Brand operators.

\end{itemize}

\begin{notice}{note}{Note:}
This section is almost identical to {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} except to the
fields that do not apply to CSVs (Invoice number sequence, Tax rate...)
\end{notice}

\begin{notice}{tip}{Tip:}
Brand operators can schedule a CSV containing calls of all its clients.
In this kind of schedules, a notification template can be chosen. In remaining
schedules, the notification template assigned to the specific client will be used.
\end{notice}

When adding a new definition, these fields are shown:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-name}
Name of the scheduled Call CSV

\item[{Call direction:\index{Call direction:|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-call-direction}
Which kind of calls should be included: Inbound, outbound or both.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-client}
Which client calls should be included

\item[{Email\index{Email|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-email}
Send generated Call CSV via email. Empty if no automatic mail is wanted.

\item[{Notification template:\index{Notification template:|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-notification-template}
Used on email notifications

\item[{Frequency/Unit\index{Frequency/Unit|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-frequency-unit}
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\end{description}

Once created, some new fields and subsections are accesible:
\begin{itemize}
\item {} 
Next execution date.

\item {} 
Last execution date and result (success/error).

\item {} 
Generated CSVs in \textbf{List of Call CSV reports}.

\end{itemize}

\begin{notice}{tip}{Tip:}
Brand operator can generate CSV containing calls of all clients.
\end{notice}


\paragraph{CSV fields}
\label{administration_portal/client/residential/calls/call_csv_schedulers:csv-fields}
These are the fields of the generated CSV files:
\begin{description}
\item[{callid\index{callid|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-callid}
Call-ID of the SIP dialog

\item[{startTime\index{startTime|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-starttime}
Time and date of the call establishment

\item[{duration\index{duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-duration}
Call duration in seconds

\item[{caller\index{caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-caller}
Caller number in E.164 format (with `+')

\item[{callee\index{callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-callee}
Callee number in E.164 format (with `+')

\item[{price\index{price|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-price}
Calculated price for the given call

\item[{direction\index{direction|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-direction}
call direction

\end{description}

In Brand CSVs, these additional fields will be included too:
\begin{description}
\item[{endpointType\index{endpointType|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-endpointtype}
`RetailAccount' for retail clients, empty for remaining types.

\item[{endpointId\index{endpointId|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-endpointid}
Retail Account ID for retail clients, empty for remaining types.

\item[{cost\index{cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-cost}
Calculated cost for the given call

\item[{companyId\index{companyId|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/residential/calls/call_csv_schedulers:term-companyid}
Client ID

\end{description}


\subsubsection{Call recordings}
\label{administration_portal/client/residential/calls/call_recordings::doc}\label{administration_portal/client/residential/calls/call_recordings:call-recordings}\label{administration_portal/client/residential/calls/call_recordings:id1}
\begin{notice}{attention}{Attention:}
Beware that local legislation may enforce to announce that the
call is being recorded (sometimes to both parties). You should include
a recording disclaimer in your welcome locutions for DDIs with automatic
recording enabled.
\end{notice}

IvozProvider supports two different ways of recording calls:
\begin{itemize}
\item {} 
\textbf{Automatic recordings} for the incoming/outgoing calls that use a
{\hyperref[administration_portal/client/vpbx/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{External DDI}}}}.

\item {} 
\textbf{On demand recordings} requested by a user during a call.

\end{itemize}


\paragraph{Automatic DDI recordings}
\label{administration_portal/client/residential/calls/call_recordings:automatic-ddi-recordings}
In this type of recording, \textbf{the whole conversation will be recorded}: from
the start until it finishes.

Two different scenarios:
\begin{itemize}
\item {} 
\textbf{Incoming calls to a DDI}: The call will continue until the external
dialer hangups (no matter whom is talking to).

\item {} 
\textbf{Outgoing calls using a DDI} as {\hyperref[administration_portal/client/vpbx/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing DDI}}}}: the
recording will continue as long as the external destination keeps in the
conversation.

\end{itemize}

\begin{notice}{attention}{Attention:}
Take into account that the call will be recorded while the
external entity is present, even it the call is being transferred between
multiple users of the platform.
\end{notice}
\paragraph{Record all the calls of a DDI}

To enable this feature, edit the DDI and configure the field under the section
recording data:

There are 4 available options:
\begin{itemize}
\item {} 
Disable recordings

\item {} 
Enable incoming recordings

\item {} 
Enable outgoing recordings

\item {} 
Enable all call recordings

\end{itemize}


\paragraph{On demand recordings}
\label{administration_portal/client/residential/calls/call_recordings:on-demand-recordings}
The \emph{on-demand} recordings must be enabled by the \emph{brand administrator} for the
clients that request it. This can be done in the client edit screen:

\begin{notice}{warning}{Warning:}
Contrary to the {\hyperref[administration_portal/platform/services:services]{\sphinxcrossref{\DUrole{std,std-ref}{Services}}}} mentioned in the
previous section, the on demand record are activated within a conversation.
\end{notice}

Contrary to automatic ones, on demand recording can be stopped using the same
process that started them.


\subparagraph{Activated using the \emph{Record} key}
\label{administration_portal/client/residential/calls/call_recordings:activated-using-the-record-key}
Some terminals (for example, \emph{Yealink}) support sending a \href{https://tools.ietf.org/html/rfc6086}{SIP INFO} message during the conversation with a
special \emph{Record} header (see \href{http://www.yealink.com/Upload/document/UsingCallRecordingFeatureonYealinkPhones/UsingCallRecordingFeatureonYealinkSIPT2XPphonesRev\_610-20561729764.pdf}{reference}).
This is not a standard for the protocol, but being Yealink one of the supported
manufacturers of the solution, we include this kind of on-demand recording.

\begin{notice}{important}{Important:}
For this recording requests, the configured code doesn't matter
but the client still must have on demand records enabled.
\end{notice}

To start or stop this kind of recordings, just press the Record key in the
terminal and the system will handle the sent message.


\subparagraph{Activated using \emph{DTMF} codes}
\label{administration_portal/client/residential/calls/call_recordings:activated-using-dtmf-codes}
The more traditional approach for this feature is to press a combination of
keys during the call. Some notification will be played and the recording will
start or stop. This combination is sent to the system using \href{https://es.wikipedia.org/wiki/Marcaci\%C3\%B3n\_por\_tonos}{DTMF tones} using the same audio
stream that the conversation (as mentioned in \href{https://tools.ietf.org/html/rfc4733}{RFC 4733}).

IvozProvider supports this kind of on demand record activation but with an
important downside. In order to capture this codes, the pbx must process each
audio packet to detect the code, avoiding the direct flow of media between the
final endpoints.

\begin{notice}{important}{Important:}
Enabling this record mode highly affects the performance of the
platform. Use at your own risk.
\end{notice}


\paragraph{Recordings list}
\label{administration_portal/client/residential/calls/call_recordings:recordings-list}
The \emph{client administrator} can access to all the recordings in the section
\textbf{Client configuration} \textgreater{} \textbf{Recordings}:

Recordings can be heard from the \emph{web} or downloaded in MP3 format:

If the recording has been started on demand, it will also include the user
that requested it:

\begin{notice}{tip}{Tip:}
Check {\hyperref[administration_portal/brand/clients/retail:differences\string-between\string-retail\string-and\string-residential\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Differences between retail and residential clients}}}} to understand the difference between these two
client types.
\end{notice}


\section{Retail Clients}
\label{administration_portal/client/retail/index:retail-clients}\label{administration_portal/client/retail/index::doc}
Retail clients are a special type of client that only provides a connectivity
service with carriers through retail accounts.

\begin{notice}{attention}{Attention:}
Contrary to the Virtual PBX clients, all Retail clients use the
brand domain to unequivocally identify their accounts. You'll need to configure
Brand's domain to use this feature.
\end{notice}

\begin{notice}{hint}{Hint:}
Retail clients can be enabled per Brand basis via Features.
\end{notice}

The goal of this section will be describe each of the configuration settings
associated with Retail clients included in IvozProvider:


\subsection{Retail Accounts}
\label{administration_portal/client/retail/retail_accounts::doc}\label{administration_portal/client/retail/retail_accounts:retail-accounts}\label{administration_portal/client/retail/retail_accounts:id1}
Retail Accounts are the main routable option in Retail clients.
More or less like {\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/index:friends]{\sphinxcrossref{\DUrole{std,std-ref}{Friends}}}} are to Virtual PBX Clients, devices
contain the required configurable options to provide a SIP connectivity
service with IvozProvider and an external SIP entity.

\begin{notice}{warning}{Warning:}
Although both \textbf{Carriers/DDI Providers} and \textbf{Retail Accounts} are defined by the
\textbf{brand operator}, the former are designed to connect with the public switched telephony network
while the latter connects the system with our clients' SIP entities.
\end{notice}


\subsubsection{Types of retail accounts}
\label{administration_portal/client/retail/retail_accounts:types-of-retail-accounts}
There are 2 main types of SIP endpoints that can use retail with IvozProvider:
\begin{itemize}
\item {} 
\textbf{Direct connection endpoint}: IvozProvider must be able to talk SIP directly with
this kind of devices by just forwarding the traffic to the proper port of
the public IP address of the PBX.

\item {} 
\textbf{Endpoint behind NAT}: Not directly reachable. This kind of endpoint must register at
IvozProvider (just like all the {\hyperref[administration_portal/client/vpbx/terminals:terminals]{\sphinxcrossref{\DUrole{std,std-ref}{Terminals}}}} do).

\end{itemize}


\subsubsection{What kind of calls can be routed through a \emph{Retail Account}?}
\label{administration_portal/client/retail/retail_accounts:what-kind-of-calls-can-be-routed-through-a-retail-account}
Contrary to Friends, \textbf{Retail Accounts} have some simplifications and limitations:
\begin{itemize}
\item {} 
Retail Accounts only route their assigned DDIs

\item {} 
Retail Accounts only place externals calls to Carriers

\item {} 
Retail Accounts only receive external calls from DDI Providers

\end{itemize}


\subsubsection{Retail Accounts Configuration}
\label{administration_portal/client/retail/retail_accounts:retail-accounts-configuration}
These are the configurable settings of \emph{Retail accounts}:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/retail_accounts:term-name}
Name of the \textbf{retail account}. This name must be unique in the whole brand so
it's recommended to use some kind of sequential identifier. This will also be used
in SIP messages (sent \textbf{From User}).

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/retail_accounts:term-description}
Optional. Extra information for this \emph{retail account}.

\item[{Password\index{Password|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/retail_accounts:term-password}
When the \emph{retail account} send requests, IvozProvider will authenticate it using
this password. Like remaining SIP entities in IvozProvider (except Wholesale) \textbf{using password IS MANDATORY}.

\item[{Direct connectivity\index{Direct connectivity|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/retail_accounts:term-direct-connectivity}
If you choose `Yes' here, you'll have to fill the protocol, address and
port where this \emph{retail account} can be contacted.

\item[{Numeric transformation\index{Numeric transformation|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/retail_accounts:term-numeric-transformation}
Numeric transformation set that will be applied when communicating with this device.

\item[{Fallback Outgoing DDI\index{Fallback Outgoing DDI|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/retail_accounts:term-fallback-outgoing-ddi}
External calls from this \emph{retail account} will be presented with this DDI, \textbf{unless
the source presented matches a DDI belonging to the retail account}.

\item[{From domain\index{From domain|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/retail_accounts:term-from-domain}
Request from IvozProvider to this account will include this domain in
the From header.

\item[{DDI In\index{DDI In|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/retail_accounts:term-ddi-in}
If set to `Yes', use endpoint username in R-URI when calling this retail account. If set to `No', use called
number instead.

\item[{Enable T.38 passthrough\index{Enable T.38 passthrough|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/retail_accounts:term-enable-t-38-passthrough}
If set to `yes', this SIP endpoint must be a \textbf{T.38 capable fax sender/receiver}. IvozProvider
application servers will act as T.38 gateways, routing calls through a T.38 capable carrier and
bridging signalling and media from one to another. See {\hyperref[security_and_maintenance/security/firewall:firewall]{\sphinxcrossref{\DUrole{std,std-ref}{Firewall}}}} for port exposing concerns
related to this kind of traffic.

\end{description}

\begin{notice}{warning}{Warning:}
All retail accounts within a retail client will have the transcoding capabilities configured at client level.
\end{notice}

\begin{notice}{tip}{Tip:}
On retail account edit screen \textbf{id} field shows internal identification number assigned to the retail account.
This id is transported to \emph{Endpoint Id} field in \emph{External Calls} section for CSV export.
\end{notice}


\subsubsection{Voicemail settings}
\label{administration_portal/client/retail/retail_accounts:voicemail-settings}
There is no voicemail service for retail clients.


\subsubsection{Call forwarding settings}
\label{administration_portal/client/retail/retail_accounts:call-forwarding-settings}
Each retail account can have a unique enabled call forward setting, pointing to an external number.

This external called will be called whenever the retail account cannot be reached:
\begin{itemize}
\item {} 
Direct connectivity accounts: when no answer is received from defined address.

\item {} 
Accounts using SIP register: when no answer is received from last contact address or when no active register is found.

\end{itemize}


\subsubsection{Asterisk as a retail account}
\label{administration_portal/client/retail/retail_accounts:asterisk-as-a-retail-account}
At the other end of a account can be any kind of SIP entity. This section takes
as example an Asterisk PBX system using SIP channel driver that wants to connect
to IvozProvider.


\paragraph{Account register}
\label{administration_portal/client/retail/retail_accounts:account-register}
If the system can not be directly access, Asterisk will have to register in the
platform (like a terminal will do).

Configuration will be something like this:

\begin{Verbatim}[commandchars=\\\{\}]
register =\PYGZgt{} retailAccountName:retailAccountPassword@ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
\end{Verbatim}


\paragraph{Account peer}
\label{administration_portal/client/retail/retail_accounts:account-peer}
\begin{Verbatim}[commandchars=\\\{\}]
[retailAccountName]
type=peer
host=ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
context=XXXXXX
disallow=all
allow=alaw
defaultuser=retailAccountName
secret=retailAccountPassword
fromuser=retailAccountName
fromdomain=ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
insecure=port,invite
sendrpid=pai
directmedia=no
\end{Verbatim}

\begin{notice}{warning}{Warning:}
\emph{Retail accounts} MUST NOT challenge IvozProvider. That's
why the \emph{insecure} setting is used here.
\end{notice}

\begin{notice}{note}{Note:}
As from username is used to identify the retail account, P-Asserted-Identity must be used to specify caller number.
\end{notice}


\subsection{DDIs}
\label{administration_portal/client/retail/ddis:ddis}\label{administration_portal/client/retail/ddis::doc}\label{administration_portal/client/retail/ddis:retail-ddis}
DDIs are the external entry point from DDI Providers to Retail Clients that
can be routed through Retail Accounts.

\begin{notice}{note}{Note:}
No call-forwarding feature with external call filters in retail clients.
\end{notice}


\subsubsection{Retail DDI routes}
\label{administration_portal/client/retail/ddis:retail-ddi-routes}
Retail DDIs can only be routed to a {\hyperref[administration_portal/client/retail/retail_accounts:retail\string-accounts]{\sphinxcrossref{\DUrole{std,std-ref}{Retail Accounts}}}}

\begin{notice}{hint}{Hint:}
Routing a DDI through a Retail account will allow to place external calls
from that account presenting that DDI as origin.
\end{notice}

\begin{notice}{note}{Note:}
No recording enable/disable feature: all calls will be recorded.
\end{notice}


\subsubsection{Retail Recordings}
\label{administration_portal/client/retail/ddis:retail-recordings}
If Retail Client has \emph{Recordings} feature enabled, DDIs can also record incoming and/or
outgoing calls.


\subsection{Rating profiles}
\label{administration_portal/client/retail/rating_profiles:rating-profiles}\label{administration_portal/client/retail/rating_profiles::doc}
This section allows the client to:
\begin{itemize}
\item {} 
See the list of rating plans and their activation time.

\item {} 
Download a CSV with each rating plan.

\item {} 
Simulate a call and guess the cost of a given call.

\end{itemize}


\subsection{Calls}
\label{administration_portal/client/retail/calls/index::doc}\label{administration_portal/client/retail/calls/index:calls}
These are the call-list sections for retail clients:


\subsubsection{Call registry}
\label{administration_portal/client/retail/calls/call_registry::doc}\label{administration_portal/client/retail/calls/call_registry:call-registry}\label{administration_portal/client/retail/calls/call_registry:id1}
Lists all the calls of the client, even those that do not imply cost.

\begin{notice}{note}{Note:}
\href{https://es.wikipedia.org/wiki/CSV}{CSV} export makes possible to
download the list for its later analysis.
\end{notice}


\subsubsection{External calls}
\label{administration_portal/client/retail/calls/external_calls:id1}\label{administration_portal/client/retail/calls/external_calls::doc}\label{administration_portal/client/retail/calls/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{description}
\item[{Start time\index{Start time|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-start-time}
Date and time of the call establishment.

\item[{Brand\index{Brand|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-brand}
Only visible for \emph{god}, shows the brand of each call.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-client}
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller\index{Caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-caller}
DDI presented for the outgoing call.

\item[{Callee\index{Callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-callee}
External number dialed.

\item[{Duration\index{Duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-duration}
Shows how long the call lasted.

\item[{Price\index{Price|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-price}
The money amount for the client.

\item[{Cost\index{Cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-cost}
The money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan\index{Rating Plan|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-rating-plan}
Rating plan used to set price for the call.

\item[{Destination\index{Destination|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-destination}
Destination that matched the call for billing.

\item[{Carrier\index{Carrier|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-carrier}
Shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for
each call.

\item[{Invoice\index{Invoice|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-invoice}
Shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID\index{Call ID|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-call-id}
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type\index{Endpoint Type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-endpoint-type}
For retail client calls, shows ``RetailAccount''. Empty for remaining client types.

\item[{Endpoint Id\index{Endpoint Id|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/external_calls:term-endpoint-id}
For retail client calls, shows the retail account's id of the call. Empty for remaining client types.

\end{description}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\paragraph{Call rerating}
\label{administration_portal/client/retail/calls/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\subsubsection{Call CSV schedulers}
\label{administration_portal/client/retail/calls/call_csv_schedulers:call-csv-schedulers}\label{administration_portal/client/retail/calls/call_csv_schedulers::doc}
This section allows programming the automatic periodical creation of CSV reports to:
\begin{itemize}
\item {} 
Clients (no matter type).

\item {} 
Brand operators.

\end{itemize}

\begin{notice}{note}{Note:}
This section is almost identical to {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} except to the
fields that do not apply to CSVs (Invoice number sequence, Tax rate...)
\end{notice}

\begin{notice}{tip}{Tip:}
Brand operators can schedule a CSV containing calls of all its clients.
In this kind of schedules, a notification template can be chosen. In remaining
schedules, the notification template assigned to the specific client will be used.
\end{notice}

When adding a new definition, these fields are shown:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-name}
Name of the scheduled Call CSV

\item[{Call direction:\index{Call direction:|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-call-direction}
Which kind of calls should be included: Inbound, outbound or both.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-client}
Which client calls should be included

\item[{Email\index{Email|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-email}
Send generated Call CSV via email. Empty if no automatic mail is wanted.

\item[{Notification template:\index{Notification template:|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-notification-template}
Used on email notifications

\item[{Frequency/Unit\index{Frequency/Unit|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-frequency-unit}
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\end{description}

Once created, some new fields and subsections are accesible:
\begin{itemize}
\item {} 
Next execution date.

\item {} 
Last execution date and result (success/error).

\item {} 
Generated CSVs in \textbf{List of Call CSV reports}.

\end{itemize}

\begin{notice}{tip}{Tip:}
Brand operator can generate CSV containing calls of all clients.
\end{notice}


\paragraph{CSV fields}
\label{administration_portal/client/retail/calls/call_csv_schedulers:csv-fields}
These are the fields of the generated CSV files:
\begin{description}
\item[{callid\index{callid|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-callid}
Call-ID of the SIP dialog

\item[{startTime\index{startTime|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-starttime}
Time and date of the call establishment

\item[{duration\index{duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-duration}
Call duration in seconds

\item[{caller\index{caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-caller}
Caller number in E.164 format (with `+')

\item[{callee\index{callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-callee}
Callee number in E.164 format (with `+')

\item[{price\index{price|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-price}
Calculated price for the given call

\item[{direction\index{direction|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-direction}
call direction

\end{description}

In Brand CSVs, these additional fields will be included too:
\begin{description}
\item[{endpointType\index{endpointType|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-endpointtype}
`RetailAccount' for retail clients, empty for remaining types.

\item[{endpointId\index{endpointId|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-endpointid}
Retail Account ID for retail clients, empty for remaining types.

\item[{cost\index{cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-cost}
Calculated cost for the given call

\item[{companyId\index{companyId|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/retail/calls/call_csv_schedulers:term-companyid}
Client ID

\end{description}


\subsubsection{Call recordings}
\label{administration_portal/client/retail/calls/call_recordings::doc}\label{administration_portal/client/retail/calls/call_recordings:call-recordings}\label{administration_portal/client/retail/calls/call_recordings:id1}
\begin{notice}{attention}{Attention:}
Beware that local legislation may enforce to announce that the
call is being recorded (sometimes to both parties). You should include
a recording disclaimer in your welcome locutions for DDIs with automatic
recording enabled.
\end{notice}

IvozProvider supports two different ways of recording calls:
\begin{itemize}
\item {} 
\textbf{Automatic recordings} for the incoming/outgoing calls that use a
{\hyperref[administration_portal/client/vpbx/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{External DDI}}}}.

\item {} 
\textbf{On demand recordings} requested by a user during a call.

\end{itemize}


\paragraph{Automatic DDI recordings}
\label{administration_portal/client/retail/calls/call_recordings:automatic-ddi-recordings}
In this type of recording, \textbf{the whole conversation will be recorded}: from
the start until it finishes.

Two different scenarios:
\begin{itemize}
\item {} 
\textbf{Incoming calls to a DDI}: The call will continue until the external
dialer hangups (no matter whom is talking to).

\item {} 
\textbf{Outgoing calls using a DDI} as {\hyperref[administration_portal/client/vpbx/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing DDI}}}}: the
recording will continue as long as the external destination keeps in the
conversation.

\end{itemize}

\begin{notice}{attention}{Attention:}
Take into account that the call will be recorded while the
external entity is present, even it the call is being transferred between
multiple users of the platform.
\end{notice}
\paragraph{Record all the calls of a DDI}

To enable this feature, edit the DDI and configure the field under the section
recording data:

There are 4 available options:
\begin{itemize}
\item {} 
Disable recordings

\item {} 
Enable incoming recordings

\item {} 
Enable outgoing recordings

\item {} 
Enable all call recordings

\end{itemize}


\paragraph{On demand recordings}
\label{administration_portal/client/retail/calls/call_recordings:on-demand-recordings}
The \emph{on-demand} recordings must be enabled by the \emph{brand administrator} for the
clients that request it. This can be done in the client edit screen:

\begin{notice}{warning}{Warning:}
Contrary to the {\hyperref[administration_portal/platform/services:services]{\sphinxcrossref{\DUrole{std,std-ref}{Services}}}} mentioned in the
previous section, the on demand record are activated within a conversation.
\end{notice}

Contrary to automatic ones, on demand recording can be stopped using the same
process that started them.


\subparagraph{Activated using the \emph{Record} key}
\label{administration_portal/client/retail/calls/call_recordings:activated-using-the-record-key}
Some terminals (for example, \emph{Yealink}) support sending a \href{https://tools.ietf.org/html/rfc6086}{SIP INFO} message during the conversation with a
special \emph{Record} header (see \href{http://www.yealink.com/Upload/document/UsingCallRecordingFeatureonYealinkPhones/UsingCallRecordingFeatureonYealinkSIPT2XPphonesRev\_610-20561729764.pdf}{reference}).
This is not a standard for the protocol, but being Yealink one of the supported
manufacturers of the solution, we include this kind of on-demand recording.

\begin{notice}{important}{Important:}
For this recording requests, the configured code doesn't matter
but the client still must have on demand records enabled.
\end{notice}

To start or stop this kind of recordings, just press the Record key in the
terminal and the system will handle the sent message.


\subparagraph{Activated using \emph{DTMF} codes}
\label{administration_portal/client/retail/calls/call_recordings:activated-using-dtmf-codes}
The more traditional approach for this feature is to press a combination of
keys during the call. Some notification will be played and the recording will
start or stop. This combination is sent to the system using \href{https://es.wikipedia.org/wiki/Marcaci\%C3\%B3n\_por\_tonos}{DTMF tones} using the same audio
stream that the conversation (as mentioned in \href{https://tools.ietf.org/html/rfc4733}{RFC 4733}).

IvozProvider supports this kind of on demand record activation but with an
important downside. In order to capture this codes, the pbx must process each
audio packet to detect the code, avoiding the direct flow of media between the
final endpoints.

\begin{notice}{important}{Important:}
Enabling this record mode highly affects the performance of the
platform. Use at your own risk.
\end{notice}


\paragraph{Recordings list}
\label{administration_portal/client/retail/calls/call_recordings:recordings-list}
The \emph{client administrator} can access to all the recordings in the section
\textbf{Client configuration} \textgreater{} \textbf{Recordings}:

Recordings can be heard from the \emph{web} or downloaded in MP3 format:

If the recording has been started on demand, it will also include the user
that requested it:

\begin{notice}{tip}{Tip:}
Check {\hyperref[administration_portal/brand/clients/retail:differences\string-between\string-retail\string-and\string-residential\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Differences between retail and residential clients}}}} to understand the difference between these two
client types.
\end{notice}


\section{Wholesale clients}
\label{administration_portal/client/wholesale/index:wholesale-clients}\label{administration_portal/client/wholesale/index::doc}
Wholesale clients are the most lightweight client type in IvozProvider.

\begin{notice}{tip}{Tip:}
You can read the details about this client type {\hyperref[administration_portal/brand/clients/wholesale:wholesale\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}.
\end{notice}

These sections will be covered for this client type:


\subsection{Rating profiles}
\label{administration_portal/client/wholesale/rating_profiles:rating-profiles}\label{administration_portal/client/wholesale/rating_profiles::doc}
This section allows the client to:
\begin{itemize}
\item {} 
See the list of rating plans and their activation time.

\item {} 
Download a CSV with each rating plan.

\item {} 
Simulate a call and guess the cost of a given call.

\end{itemize}


\subsection{Calls}
\label{administration_portal/client/wholesale/calls/index::doc}\label{administration_portal/client/wholesale/calls/index:calls}
These are the call-list sections for wholesale clients:


\subsubsection{External calls}
\label{administration_portal/client/wholesale/calls/external_calls:id1}\label{administration_portal/client/wholesale/calls/external_calls::doc}\label{administration_portal/client/wholesale/calls/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{description}
\item[{Start time\index{Start time|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-start-time}
Date and time of the call establishment.

\item[{Brand\index{Brand|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-brand}
Only visible for \emph{god}, shows the brand of each call.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-client}
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller\index{Caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-caller}
DDI presented for the outgoing call.

\item[{Callee\index{Callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-callee}
External number dialed.

\item[{Duration\index{Duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-duration}
Shows how long the call lasted.

\item[{Price\index{Price|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-price}
The money amount for the client.

\item[{Cost\index{Cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-cost}
The money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan\index{Rating Plan|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-rating-plan}
Rating plan used to set price for the call.

\item[{Destination\index{Destination|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-destination}
Destination that matched the call for billing.

\item[{Carrier\index{Carrier|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-carrier}
Shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for
each call.

\item[{Invoice\index{Invoice|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-invoice}
Shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID\index{Call ID|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-call-id}
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type\index{Endpoint Type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-endpoint-type}
For retail client calls, shows ``RetailAccount''. Empty for remaining client types.

\item[{Endpoint Id\index{Endpoint Id|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/external_calls:term-endpoint-id}
For retail client calls, shows the retail account's id of the call. Empty for remaining client types.

\end{description}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\paragraph{Call rerating}
\label{administration_portal/client/wholesale/calls/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\subsubsection{Call CSV schedulers}
\label{administration_portal/client/wholesale/calls/call_csv_schedulers:call-csv-schedulers}\label{administration_portal/client/wholesale/calls/call_csv_schedulers::doc}
This section allows programming the automatic periodical creation of CSV reports to:
\begin{itemize}
\item {} 
Clients (no matter type).

\item {} 
Brand operators.

\end{itemize}

\begin{notice}{note}{Note:}
This section is almost identical to {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} except to the
fields that do not apply to CSVs (Invoice number sequence, Tax rate...)
\end{notice}

\begin{notice}{tip}{Tip:}
Brand operators can schedule a CSV containing calls of all its clients.
In this kind of schedules, a notification template can be chosen. In remaining
schedules, the notification template assigned to the specific client will be used.
\end{notice}

When adding a new definition, these fields are shown:
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-name}
Name of the scheduled Call CSV

\item[{Call direction:\index{Call direction:|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-call-direction}
Which kind of calls should be included: Inbound, outbound or both.

\item[{Client\index{Client|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-client}
Which client calls should be included

\item[{Email\index{Email|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-email}
Send generated Call CSV via email. Empty if no automatic mail is wanted.

\item[{Notification template:\index{Notification template:|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-notification-template}
Used on email notifications

\item[{Frequency/Unit\index{Frequency/Unit|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-frequency-unit}
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\end{description}

Once created, some new fields and subsections are accesible:
\begin{itemize}
\item {} 
Next execution date.

\item {} 
Last execution date and result (success/error).

\item {} 
Generated CSVs in \textbf{List of Call CSV reports}.

\end{itemize}

\begin{notice}{tip}{Tip:}
Brand operator can generate CSV containing calls of all clients.
\end{notice}


\paragraph{CSV fields}
\label{administration_portal/client/wholesale/calls/call_csv_schedulers:csv-fields}
These are the fields of the generated CSV files:
\begin{description}
\item[{callid\index{callid|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-callid}
Call-ID of the SIP dialog

\item[{startTime\index{startTime|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-starttime}
Time and date of the call establishment

\item[{duration\index{duration|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-duration}
Call duration in seconds

\item[{caller\index{caller|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-caller}
Caller number in E.164 format (with `+')

\item[{callee\index{callee|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-callee}
Callee number in E.164 format (with `+')

\item[{price\index{price|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-price}
Calculated price for the given call

\item[{direction\index{direction|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-direction}
call direction

\end{description}

In Brand CSVs, these additional fields will be included too:
\begin{description}
\item[{endpointType\index{endpointType|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-endpointtype}
`RetailAccount' for retail clients, empty for remaining types.

\item[{endpointId\index{endpointId|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-endpointid}
Retail Account ID for retail clients, empty for remaining types.

\item[{cost\index{cost|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-cost}
Calculated cost for the given call

\item[{companyId\index{companyId|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/wholesale/calls/call_csv_schedulers:term-companyid}
Client ID

\end{description}

Client types are order from the most feature-full to the most lightweight one.


\chapter{User Portal}
\label{user_portal/index:userportal}\label{user_portal/index:user-portal}\label{user_portal/index::doc}
{\hyperref[administration_portal/brand/clients/virtual_pbx:virtual\string-pbx]{\sphinxcrossref{\DUrole{std,std-ref}{Virtual PBX}}}} clients have an additional role apart from god, brand and client: \textbf{user role}.

As remaining IvozProvider levels, final users have an independent web portal.

This section will cover these topics:


\section{URLs}
\label{user_portal/urls::doc}\label{user_portal/urls:urls}
Prior to accessing to user portal, the URL addresses must be configured (domains
in these URLs must point to any of the public IP addresses of the platform).

2 roles can perform this task:


\subsection{God operator}
\label{user_portal/urls:god-operator}
In the section \textbf{Platform configuration \textgreater{} Brands} you can configure as many
user URLs as you wish, using the button \textbf{Portal list} of each brand.

\begin{notice}{note}{Note:}
URLs are linked to brands and god operator may choose where to create
one shared user portal URL for all the clients of a brand or creating
one per client.
\end{notice}

\begin{notice}{warning}{Warning:}
URLs MUST be HTTPS.
\end{notice}

This section also allows setting a logo per URL, a theme and a phrase to use as
the title of user portal.

\begin{notice}{hint}{Hint:}
This allows creating corporate user portals.
\end{notice}


\subsection{Brand Operator}
\label{user_portal/urls:brand-operator}
Brand Operator can also perform this same task in order to configure the user
portal URLs of his clients.

This way, he can choose whether to configure one URL per Client (with custom
domains, logos, theme and title) or sharing a global URL for all of them.

The section to do this is \textbf{Brand configuration \textgreater{} Portal URLs}.


\section{Credentials}
\label{user_portal/credentials:credentials}\label{user_portal/credentials::doc}
Access credentials to user portal are configured in \textbf{Client configuration \textgreater{}
Users} section.

Specifically:
\begin{itemize}
\item {} 
\textbf{Login information} block, the access of each user is enabled or disabled.

\item {} 
You can set the \textbf{Password} too.

\item {} 
To log in the user portal, the user must use his/her email address.

\end{itemize}

\begin{notice}{warning}{Warning:}
The \textbf{email} of each user MUST be \textbf{globally unique}.
\end{notice}


\section{Features}
\label{user_portal/features::doc}\label{user_portal/features:features}
IvozProvider provides a web portal where final users can do the following
actions:
\begin{itemize}
\item {} 
See all calls he or she has been involved.

\item {} 
Configure call forwards:
\begin{itemize}
\item {} 
To voicemail

\item {} 
To an internal extension

\item {} 
To an external number

\end{itemize}

\item {} 
Enable functionalities:
\begin{itemize}
\item {} 
Call waiting

\item {} 
Do Not Disturb

\end{itemize}

\item {} 
See the state of his or her SIP device registration

\end{itemize}

\begin{notice}{note}{Note:}
User portal has a different look-and-feel than remaining portals and is responsive to work with mobile devices.
\end{notice}


\chapter{Security}
\label{security_and_maintenance/security/index:security}\label{security_and_maintenance/security/index::doc}
IvozProvider is designed to be exposed to Internet, having public IPs on some profile's NICs.

This section talks about included and non-included (but recommended and shipped in all production IvozProvider
installations maintained by \href{https://www.irontec.com}{Irontec}) security mechanisms:


\section{Firewall}
\label{security_and_maintenance/security/firewall:firewall}\label{security_and_maintenance/security/firewall::doc}
\textbf{IvozProvider does not currently include a firewall} but...

\begin{notice}{danger}{Danger:}
We \textbf{strongly encourage any production installation to implement
a firewall} to protect the platform from the wild Internet.
\end{notice}

The protection method could be:
\begin{itemize}
\item {} 
Local firewall based on \href{https://www.netfilter.org/}{iptables}

\item {} 
External firewall

\item {} 
Both

\end{itemize}


\subsection{Exposed ports/services}
\label{security_and_maintenance/security/firewall:exposed-ports-services}
These are the \textbf{ports IvozProvider needs to expose} to work properly:

\textbf{SIP signalling}:
\begin{itemize}
\item {} 
Port 5060 (TCP/UDP)

\item {} 
Port 5061 (TCP)

\item {} 
Port 7060 (TCP/UDP) y 7061 TCP (just in case both ProxyUsers and ProxyTrunks share IP)

\end{itemize}

\textbf{RTP audioflow}:
\begin{itemize}
\item {} 
Port range 13000-19000 UDP

\end{itemize}

\textbf{Web portal and provisioning}:
\begin{itemize}
\item {} 
Ports TCP 443, 1443 y 2443

\end{itemize}

\begin{notice}{hint}{Hint:}
We recommend using \textbf{iptables geoIP module} to drop connections from
countries where we don't have any clients.
\end{notice}


\subsection{T.38 passthrough mode}
\label{security_and_maintenance/security/firewall:t-38-passthrough-mode}
vPBX terminals/friends, residential devices and retail accounts can be configured with T.38 passthrough enabled. In this
kind of setup, T.38 capable devices will exchange T.38 RTP traffic directly to Application Servers.

This means that when this mode is needed:
\begin{itemize}
\item {} 
Application Server must have an exposed IP address (usually public IP address).

\item {} 
Firewall will need to expose those IP addresses' 4000-4999 UDP port range.

\end{itemize}


\section{SIP Antiflooding}
\label{security_and_maintenance/security/antiflooding::doc}\label{security_and_maintenance/security/antiflooding:sip-antiflooding}
Both SIP Proxies included in IvozProvider installation, KamUsers for SIP signalling with clients and KamTrunks for SIP
signalling with providers, use \href{http://kamailio.org/docs/modules/5.1.x/modules/pike.html}{PIKE module} to avoid DoS
attacks.

This module keeps trace of all incoming request's IP source and blocks the ones that exceed the limit on a given time
interval.

\begin{notice}{warning}{Warning:}
\textbf{IPs are not blocked permanently}, they are allowed again as soon as their incoming request don't exceed the limit
on upcoming time interval.
\end{notice}

Current configuration parameters are:
\begin{itemize}
\item {} 
\textbf{Sampling time interval}: 2 seconds.

\item {} 
\textbf{Threshold per time unit}: 30 requests.

\end{itemize}

This means that \emph{any IP address that sends more than 30 requests in a 2-second-time-interval will be blocked (ignored)
until next 2-second-time-interval in which this origin tries less than 30 requests}.


\subsection{Antiflooding excluded sources}
\label{security_and_maintenance/security/antiflooding:antiflooding-excluded-sources}
These sources are not evaluated against antiflood:
\begin{itemize}
\item {} \begin{description}
\item[{Both KamUsers and KamTrunks:}] \leavevmode\begin{itemize}
\item {} 
IvozProvider components

\item {} 
IPs in {\hyperref[administration_portal/platform/antiflood_trusted_ips:antiflood\string-trusted\string-ips]{\sphinxcrossref{\DUrole{std,std-ref}{Antiflood trusted IPs}}}}

\end{itemize}

\end{description}

\item {} \begin{description}
\item[{KamUsers:}] \leavevmode\begin{itemize}
\item {} 
IPs in {\hyperref[security_and_maintenance/security/authorized_ip_ranges:client\string-authorized\string-ip\string-ranges]{\sphinxcrossref{\DUrole{std,std-ref}{Clients authorized IPs}}}} (vPBX, retail, residential)

\item {} 
Wholesale clients' IP addresses

\end{itemize}

\end{description}

\end{itemize}

\begin{notice}{warning}{Warning:}
IPs and ranges added in {\hyperref[security_and_maintenance/security/authorized_ip_ranges:client\string-authorized\string-ip\string-ranges]{\sphinxcrossref{\DUrole{std,std-ref}{Clients authorized IPs}}}} will be excluded from
antiflood, even if \textbf{Filter by IP address} is disabled.
\end{notice}
\begin{itemize}
\item {} \begin{description}
\item[{KamTrunks:}] \leavevmode\begin{itemize}
\item {} 
DDI Providers' IP addresses

\end{itemize}

\end{description}

\end{itemize}

\begin{notice}{tip}{Tip:}
On a typical NAT scenario with hundreds of UACs sharing the same public IP address, this IP should be static and
should be added to {\hyperref[security_and_maintenance/security/authorized_ip_ranges:client\string-authorized\string-ip\string-ranges]{\sphinxcrossref{\DUrole{std,std-ref}{Clients authorized IPs}}}} list to avoid been blocked by
antiflooding (e.g. after lights out, etc.)
\end{notice}


\section{Authorized IP ranges}
\label{security_and_maintenance/security/authorized_ip_ranges:client-authorized-ip-ranges}\label{security_and_maintenance/security/authorized_ip_ranges::doc}\label{security_and_maintenance/security/authorized_ip_ranges:authorized-ip-ranges}
{\hyperref[administration_portal/client/vpbx/index:vpbx\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Virtual PBX clients}}}}, {\hyperref[administration_portal/client/retail/index:retail\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Retail Clients}}}} and {\hyperref[administration_portal/client/residential/index:residential\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Residential Clients}}}} can add IP addresses or ranges
(in CIDR format) with the combination of \textbf{Filter by IP address} field and \textbf{List of authorized sources} subsection.

\begin{notice}{warning}{Warning:}
On {\hyperref[administration_portal/client/wholesale/index:wholesale\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Wholesale clients}}}} there is no \textbf{Filter by IP address} field as this type of clients are authenticated by IP, making
filling \textbf{List of wholesale addresses} mandatory.
\end{notice}

When \textbf{Filter by IP address} is enabled, users won't be allowed to connect from another network, even if they have
valid SIP credentials.

\begin{notice}{error}{Error:}
Once the filter has been activated you \textbf{MUST} add networks or
valid IP addresses, otherwise, all the calls will be rejected.
\end{notice}


\subsection{Roadwarrior users}
\label{security_and_maintenance/security/authorized_ip_ranges:roadwarrior-users}\label{security_and_maintenance/security/authorized_ip_ranges:id1}
Some vPBX clients have roadwarrior users that travel often and connect from external
networks, forcing Clients to disable the IP filter security mechanism.

To solve this issue, there is a user option called \textbf{Calls from non-granted IPs}
that enables these users to call from non-granted IPs while remaining users' credentials
are still protected with IP filter mechanism.

When users like these call from non-granted IPs, their amount of concurrent
outgoing calls are limited to 1, 2 or 3 to avoid being a security breach.

\begin{notice}{note}{Note:}
Only \textbf{generated calls} (both internals and externals) are limited,
received calls are not affected by this setting.
\end{notice}

To sum up, with this feature:
\begin{itemize}
\item {} 
There are users that are allowed to make a fixed amount of calls from
non-granted IPs.

\item {} 
These calls from non-granted IPs are counted and limited.

\end{itemize}
\paragraph{Example 1 - Client without IP check}

It doesn't matter if the user is allowed to make calls from non-granted IPs,
as there are no non-granted IPs.
\paragraph{Example 2 - Client with IP check}
\begin{itemize}
\item {} 
If the user is calling from one of the allowed IPs,
it doesn't matter if the user is allowed to make calls from non-granted IPs:
this calls are not counted nor limited.

\item {} 
If the user is NOT calling from one of the allowed IPs, it is verified the
amount of calls that this user is allowed to make. If the user is allowed to
make calls from non-granted IPs and has not exceeded his limit, the call is
granted and counted.

\end{itemize}

To sum up, if \textbf{Calls from non-granted IPs} is set to \emph{None} the user must fulfill the IP policy of the client.


\section{Concurrent call limit}
\label{security_and_maintenance/security/concurrent_call_limit::doc}\label{security_and_maintenance/security/concurrent_call_limit:concurrent-call-limit}
This mechanism \textbf{limits the number of concurrent calls} of each client/brand.

\begin{notice}{note}{Note:}
Both incoming external calls and outgoing external calls will be limited.
\end{notice}

It can be configured at two levels:
\begin{itemize}
\item {} 
At Brand level with \textbf{Max calls} setting.

\item {} 
At Client level with \textbf{Max calls} setting.

\end{itemize}

A brand clients' \emph{Max calls} sum may be bigger than brand's \emph{Max calls} value, there is no control to avoid this situation.

\begin{notice}{warning}{Warning:}
These counters are independent. Whenever one of this counter reaches its limit, call will be denied. This
means that a call from a client that has not exceeded it own \emph{Max call} setting may be denied if brand's
limit has been exceeded.
\end{notice}

\begin{notice}{tip}{Tip:}
To disable this mechanism, set its value to 0.
\end{notice}


\chapter{Troubleshooting}
\label{security_and_maintenance/maintenance/index::doc}\label{security_and_maintenance/maintenance/index:troubleshooting}
This section talks about included and non-included (but recommended and shipped in all production IvozProvider
installations maintained by \href{https://www.irontec.com}{Irontec}) tools to troubleshoot any problem you may have:


\section{Analyzing SIP traffic}
\label{security_and_maintenance/maintenance/sip_captures:analyzing-sip-traffic}\label{security_and_maintenance/maintenance/sip_captures::doc}
Although all production IvozProvider installations maintained by
\href{https://www.irontec.com}{Irontec} include a \href{https://www.sipcapture.org/}{Homer SIP Capture Server}, it is not installed in the standalone version
of IvozProvider. The reason behind this is that we prefer awesome SIPCAPTURE
stack running on an additional machine.

\href{https://github.com/irontec/sngrep}{sngrep Ncurses SIP Messages flow viewer developed by Irontec} is currently
the preferred tool to inspect SIP traffic included in IvozProvider.

\noindent\sphinxincludegraphics{{sngrep_sample}.png}


\subsection{sngrep}
\label{security_and_maintenance/maintenance/sip_captures:sngrep}
See live SIP traffic (all):

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{sngrep}
\end{Verbatim}

See live SIP traffic related to calls:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{sngrep \PYGZhy{}c}
\end{Verbatim}

See live SIP traffic and capture RTP too:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{sngrep \PYGZhy{}c \PYGZhy{}r}
\end{Verbatim}

For more reference, visit \href{https://github.com/irontec/sngrep}{sngrep official site}.


\subsection{Other capturing tools}
\label{security_and_maintenance/maintenance/sip_captures:other-capturing-tools}
Although sngrep is our preferred capturing tool, IvozProvider ships other tools
to capture SIP/RTP traffic, such as \href{http://www.tcpdump.org}{tcpdump} and
\href{http://ngrep.sourceforge.net}{ngrep}.


\section{Log viewer}
\label{security_and_maintenance/maintenance/log_viewer::doc}\label{security_and_maintenance/maintenance/log_viewer:log-viewer}
Although all production IvozProvider installations maintained by
\href{https://www.irontec.com}{Irontec} include a \href{https://www.elastic.co/elk-stack}{ELK stack}, \href{https://www.freedesktop.org/software/systemd/man/journalctl.html}{journalctl} is currently
the unique tool shipped with IvozProvider to inspect logs generated by different elements of the solution
in the past.


\subsection{Asterisk CLI}
\label{security_and_maintenance/maintenance/log_viewer:asterisk-cli}
Asterisk CLI gives tons of realtime information too and are formatted beautifully
to detect possible configuration errors:

\noindent\sphinxincludegraphics{{asterisk_cli}.png}

You can access Asterisk CLI typing \emph{ast} in the shell.


\subsection{Kamailio realtime log viewing}
\label{security_and_maintenance/maintenance/log_viewer:kamailio-realtime-log-viewing}
You can see Kamailio logs in realtime too typing \emph{kamtail-proxyusers} and
\emph{kamtail-proxytrunks} in the shell:

\noindent\sphinxincludegraphics{{kamtail}.png}


\section{Other tools}
\label{security_and_maintenance/maintenance/other_tools::doc}\label{security_and_maintenance/maintenance/other_tools:other-tools}
Although IvozProvider does not include any of the tools mentioned here, we consider them crucial for dealing with
production environments.

We list here tools configured in all production IvozProvider installations maintained by
\href{https://www.irontec.com}{Irontec}.


\subsection{Metrics viewer}
\label{security_and_maintenance/maintenance/other_tools:metrics-viewer}
\href{https://www.influxdata.com/time-series-platform/chronograf/}{Chronograf web interface}
showing information collected by remaining \href{https://www.influxdata.com/time-series-platform/}{TICK Stack components},
allow us to show:
\begin{itemize}
\item {} 
Realtime system metrics.

\item {} 
Realtime VoIP metrics.

\item {} 
Custom dashboard per profile.

\end{itemize}

\href{https://www.influxdata.com/time-series-platform/kapacitor/}{Kapacitor component} allows setting alarms when anomalous
metrics happen or certain thresholds are exceeded.


\subsection{Active monitoring}
\label{security_and_maintenance/maintenance/other_tools:active-monitoring}
All IvozProvider installations maintained by \href{https://www.irontec.com}{Irontec} are thoroughly monitored to solve problems
as soon as possible and to prevent future problems when possible.


\chapter{Introduction to IvozProvider API}
\label{api_rest/introduction:introduction-to-ivozprovider-api}\label{api_rest/introduction::doc}
Ivoz Provider offers three \href{https://en.wikipedia.org/wiki/HATEOAS}{hypermedia}-driven REST APIs, one for each admin role. The three of them have been built over
\href{https://www.openapis.org/}{OpenAPI Specification}, a community-driven open specification within the OpenAPI
Initiative, a Linux Foundation Collaborative Project. This initiative is supported by some leading tech companies
such as Adobe, Google, IBM, Microsoft and \href{https://www.openapis.org/membership/members)}{more}.

We support the features below:
\begin{itemize}
\item {} 
Nice human-readable specification, including a sandbox

\item {} 
JSON Web Token (JWT) based authentication

\item {} 
Request and response content type negotiation

\item {} 
Result pagination

\item {} 
Response property filters

\item {} 
Result filters

\item {} 
Result ordering

\item {} 
Security layer: Resource and record access control

\end{itemize}


\chapter{Built-in web client}
\label{api_rest/web_client:built-in-web-client}\label{api_rest/web_client::doc}
APIs come with their own web client so that you can test them easily. Go to Platform API for instance.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{web-client}.png}\hspace*{\fill}}

You will need to get an access token with some valid admin credentials before anything else. You can do that from {[}Auth{]} \textgreater{} {[}POST /admin\_login{]} section. Click on \sphinxtitleref{Try it out} button, set your credentials and click on \sphinxtitleref{execute} to send the request. You should get a response that contains a token and a refresh token.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{access-token}.png}\hspace*{\fill}}

Copy the token and set it on \sphinxtitleref{Authorize} button at the top of the page. The token ttl (time to live) is one hour by default, you can use the refresh token then to get a new one without sending admin credentials again.

Once you have got your token properly set, click on {[}GET /administrators{]} endpoint, \sphinxtitleref{Try it out} and \sphinxtitleref{Execute}. You may want to switch \sphinxtitleref{Response content type} as well (JSON or LD+JSON for this endpoint).

\noindent{\hspace*{\fill}\sphinxincludegraphics{{response}.png}\hspace*{\fill}}

It's possible to filter and sort response using \sphinxtitleref{Parameters} input fields as well.
\paragraph{Specification}

You can check out request and response models from the web client itself.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{spec}.png}\hspace*{\fill}}


\chapter{Third party integrations}
\label{api_rest/integrations:third-party-integrations}\label{api_rest/integrations::doc}
Ivoz Provider makes use of \textbf{OpenAPI Specification 2.0} (which is identical to the Swagger 2.0 specification before it was
renamed to ``OpenAPI Specification'').

APIs are supposed to be the way to integrate third party applications with IvozProvider. Some community tools, such as
\href{https://github.com/swagger-api/swagger-codegen}{swagger-codegen}, may be of great help during the client development.
According to their github page the following language/framework code auto-generation is supported:
\begin{itemize}
\item {} 
ActionScript

\item {} 
Ada

\item {} 
Apex

\item {} 
Bash

\item {} 
C\# (.net 2.0, 3.5 or later)

\item {} 
C++ (cpprest, Qt5, Tizen)

\item {} 
Clojure

\item {} 
Dart

\item {} 
Elixir

\item {} 
Elm

\item {} 
Eiffel

\item {} 
Erlang

\item {} 
Go

\item {} 
Groovy

\item {} 
Haskell (http-client, Servant)

\item {} 
Java (Jersey1.x, Jersey2.x, OkHttp, Retrofit1.x, Retrofit2.x, Feign, RestTemplate, RESTEasy, Vertx, Google API Client Library for Java, Rest-assured)

\item {} 
Kotlin

\item {} 
Lua

\item {} 
Node.js (ES5, ES6, AngularJS with Google Closure Compiler annotations)

\item {} 
Objective-C

\item {} 
Perl

\item {} 
PHP

\item {} 
PowerShell

\item {} 
Python

\item {} 
R

\item {} 
Ruby

\item {} 
Rust (rust, rust-server)

\item {} 
Scala (akka, http4s, swagger-async-httpclient)

\item {} 
Swift (2.x, 3.x, 4.x)

\item {} 
Typescript (Angular1.x, Angular2.x, Fetch, jQuery, Node)

\end{itemize}

You'll find API specs in the URLs below:
\begin{itemize}
\item {} 
Platform API spec

\item {} 
Brand API spec

\item {} 
Client API spec

\end{itemize}



\renewcommand{\indexname}{Index}
\printindex
\end{document}
